---
output:
  pdf_document:
    toc: yes
    keep_tex: TRUE
urlcolor: blue
---

---
title: "PERSUADE `r basename(getwd())`"
date: "`r Sys.Date()`"
---

```{r setup, include=FALSE}
#code is formatted using formatR::tidy_source(width.cutoff = 80)
knitr::opts_chunk$set(echo = TRUE, fig.align = "left", fig.path = "Images/", dev = c('pdf', 'png'), dpi=300)
```

```{r preparation, echo=FALSE, warning = FALSE, message = FALSE, results = "hide"}
packages <- c("rms", "survival", "flexsurv", "muhaz", "survminer", "ggplot2", "data.table",
              "summarytools", "knitr", "kableExtra", "sft")
new.packages <- packages[!(packages %in% installed.packages()[, "Package"])]  #check for new packages
if (length(new.packages)) install.packages(new.packages)  #install new packages (if needed)
suppressPackageStartupMessages(lapply(packages, require, character.only = TRUE))  #load packages

# COLOUR PALETTE
n <- 9  #number of different colors (to be used for palette)
palette(rainbow(n = n, s = 1, v = 1, start = 0, end = max(1, n - 1)/n, alpha = 1))
```

```{r input, echo=FALSE, warning = FALSE, message = FALSE, results = "hide"}
# INPUT DATA
load(paste0(getwd(),"/PERSUADE.RData"))
```

\  
\

[Link to PERSUADE GitHub page](https://github.com/Bram-R/PERSUADE)
\newpage

# Kaplan-Meier  

```{r plot_KM, echo=FALSE, fig.height=8, fig.width=7}
evalq({
  suppressWarnings(if (misc$ngroups > 1) {
    ggsurvplot(surv_fit(misc$form, data = data.frame(input[1:3])), 
               linetype = as.integer(c(1, "2222", "5212")), legend.labs = misc$group_names, risk.table = TRUE, 
               conf.int = TRUE, surv.median.line = "hv", ncensor.plot = TRUE, censor = FALSE, 
               ggtheme = theme_light(), color = "strata", size = 0.5)
  } else {
    ggsurvplot(surv_fit(misc$form, data = data.frame(input[1:2])), legend.labs = misc$group_names, 
               risk.table = TRUE, conf.int = TRUE, surv.median.line = "hv", ncensor.plot = FALSE, 
               censor = TRUE, ggtheme = theme_light(), color = "black", size = 0.5)
  })
}, envir = PERSUADE)

kable_styling(kable(summary(PERSUADE$surv_obs$km)$table, format = "latex", 
                    row.names = TRUE, booktabs = TRUE, linesep = ""), latex_options = c("scale_down", "striped"))
```

\newpage

# Proportional hazards assumption  

Should stratified parametric survival models be used? 

To inform the decision whether stratified or non-stratified models should be used. One should assess whether the proportional hazard (PH) assumption holds. The PH assumption entails that the ratio of the hazards of two groups is constant over time.  When the PH assumption holds, one may fit non-stratified (parametric) survival models, meaning that a single (parametric) survival model can be fitted to all groups with the group effect(s) included as a covariate of the model. When the PH assumption does not hold it is advised to fit separate (parametric) survival models to the different groups. Finally, this section only provides plots to assess the proportional hazards assumption over the period for which data are observed. Even if these plots indicate that the PH assumption does hold, it might be violated in the period for which no data are observed. For more information, please refer to the [NICE TSD 14](http://nicedsu.org.uk/wp-content/uploads/2016/03/NICE-DSU-TSD-Survival-analysis.updated-March-2013.v2.pdf).  
The Figures below allow to examine whether the PH assumption holds over the observed data period. Figure A shows the relation between the natural logarithm of time (x-axis) and the natural logarithm of the cumulative hazard (y-axis). The lines in the Figure representing the different groups. An indication that the PH assumption holds is when these lines are parallel. Figures B and C represent the scaled Schoenfeld residual plots. In those plots, the relation of time (x-axis) and the residuals of the observed events (y-axis) is plotted. For the PH assumption to hold, there should be not apparent relations between these residuals and time. To investigate this, a smoothed spline has been plotted (cyan). Once this smoothed line systematically deviates from a straight line, one can consider that the PH assumption is violated, because it indicates a relation between the coefficient (or group variable in this case) and time. This is demonstrated by [Grambsch and Therneau (1994)](https://doi.org/10.1093/biomet/81.3.515).  
Another indication that the PH assumption does not hold is when the lines from different groups Kaplan-Meier plot (previous page) cross each other. 

**CAUTION**: These plots apply to the observed data period and do not allow to make inferences about the proportional hazard function assumption beyond this period. Additionally, the end of the observed data period may be affected by the low number of observations. One should consider this when interpreting the tail of the curves. 

\newpage

```{r PH_assumption, echo=FALSE, eval=if (PERSUADE$misc$ngroups>1) {TRUE} else {FALSE}, out.height = "29%", fig.width=11}
evalq({
  plot(cbind(log(surv_obs$km$time), log(-log(surv_obs$km$surv))), main = "A: LN(cumulative hazard)", 
       xlim = c(floor(min(log(surv_obs$km$time)[surv_obs$km$surv != 1])), ceiling(max(log(surv_obs$km$time)))), 
       cex = 0.6, xlab = "LN(time)", ylab = "LN(cumulative hazard)", 
       pch = c(1, 8, 9)[surv_obs$km_names], col = c("black", "lightgrey", "darkgrey")[surv_obs$km_names])
  legend("topleft",                    # Add legend to plot
         legend = levels(input$group),
         col = c("black", "lightgrey", "darkgrey")[unique(surv_obs$km_names)],
         lty = 1)
  
  plot(cox.zph(surv_obs$cox_reg, terms = FALSE)[1], col = "5", lwd = 2, xlab = "time", 
       main = "B: Scaled Schoenfeld residuals", ylab = "Beta(t) for group 2 vs group 1")
  abline(0, 0, lty = 3)
  abline(lm(cox.zph(surv_obs$cox_reg, terms = FALSE)$y[, 1] ~ cox.zph(surv_obs$cox_reg)$x)$coefficients, 
         col = "7", lty = 1, lwd = 2)
  legend(0, -2, col = c("5", "7"), lty = 1, cex = 0.8, 
         legend = c("smoothed line (natural spline with df = 4)", "regression line"))
  if (misc$ngroups > 2) {
    plot(cox.zph(surv_obs$cox_reg, terms = FALSE)[2], col = "5", lwd = 2, xlab = "time", 
         main = "C: Scaled Schoenfeld residuals", ylab = "Beta(t) for group 3 vs group 1")
    abline(0, 0, lty = 3)
    abline(lm(cox.zph(surv_obs$cox_reg, terms = FALSE)$y[, 2] ~ cox.zph(surv_obs$cox_reg)$x)$coefficients, 
           col = "7", lty = 1, lwd = 2)
    legend(0, -2, col = c("5", "7"), lty = 1, cex = 0.8, 
           legend = c("smoothed line (natural spline with df = 4)", "regression line"))
  }
}, envir = PERSUADE)
```

\newpage

# Hazard function  
## Shape of the observed smoothed hazard function  

The hazard function, or the instantaneous rate at which an event occurs at a specific time point given survival until that time point. The hazard function can take a variety of shapes depending on the distribution/parametric survival model considered. The plausibility of different shapes for the hazard function should be considered given the observed hazard function (considered below) and/or external data (not considered below).

See below for an overview of the potential shapes for the hazard function for standard parametric survival models:

No | Distribution |	Hazard function shape 
-- | ---------------- | ---------------- 
1 | Exponential | constant hazard 
2 | Weibull	| monotonically increasing and decreasing hazards 
3 | Gompertz  | monotonically increasing and decreasing hazards  
4 | Log-normal | arc-shaped and monotonically decreasing hazards 
5 | Log-logistic | arc-shaped and monotonically decreasing hazards
6 | Gamma | monotonically increasing and decreasing hazards  
7 | Generalised Gamma | arc-shaped, bathtub-shaped, monotonically increasing, and monotonically decreasing hazards

as the spline-based and (non-)mixture cure models are based on the standard parametric models, the assumed hazard functions can be derived from the Table above as well. For spline-based models using the hazard scale, the Weibull distribution (thus monotonically increasing and decreasing hazards) is used and the hazard function can differ for the different segments (i.e. between the knot locations). Similarly for spline-based models using the odds (log-logistic distribution) and normal scale (log-normal distribution) as well as the distributions used for the (non-)mixture cure models (different hazard functions are potentially estimated for the (non-)cure fraction). More information and visualisation of the shape of the hazard function that can be estimated by the different parametric survival models can be found [here](https://devinincerti.com/2019/06/18/parametric_survival.html).  

**CAUTION**: These plots apply to the observed data period and do not allow to make inferences about the shape of the hazard function beyond this period. Additionally, the end of the observed data period may be affected by the low number of observations. One should consider this when interpreting the tail of the curves.  

```{r plot_hr, echo=FALSE}
evalq({
  plot(cbind(surv_obs$haz$smooth_gr1$est.grid, surv_obs$haz$smooth_gr1$haz.est), 
       type = "l", col = "red", lty = 1, lwd = 2, xlab = "time", ylab = "smoothed hazard rate", 
       xlim = c(0, surv_obs$haz$max$time), ylim = c(0, surv_obs$haz$max$smooth))
  if (misc$ngroups > 1) {
    lines(cbind(surv_obs$haz$smooth_gr2$est.grid, surv_obs$haz$smooth_gr2$haz.est), 
          col = "green", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(surv_obs$haz$smooth_gr3$est.grid, surv_obs$haz$smooth_gr3$haz.est), 
          col = "blue", lty = "5212", lwd = 2)
  }
  legend("topleft", legend = misc$group_names, col = c("red", "green", "blue"), 
         lty = as.integer(c(1, "2222", "5212")), cex = 0.8)
}, envir = PERSUADE)
```

\newpage

## Shape of the predicted hazard function  
The following plots dislay how the hazard rates is estimated using the different parametric survival models.  

```{r plot_haz_pred, out.height = "29%", fig.width=11, echo=FALSE}

# GROUP 1
evalq({
  plot(cbind(surv_obs$haz$smooth_gr1$est.grid, surv_obs$haz$smooth_gr1$haz.est),
       main = paste("Group", misc$group_names[1]),
       type = "l", col = "black", lty = 1, lwd = 2, xlab = "time", ylab = "smoothed hazard rate", 
       xlim = c(0, surv_obs$haz$max$time), ylim = c(0, surv_obs$haz$max$smooth))
  lines(cbind(surv_pred$model$expo_h[[1]]$time, surv_pred$model$expo_h[[1]]$est), 
        col = "1", lty = 1, lwd = 1)
  lines(cbind(surv_pred$model$weib_h[[1]]$time, surv_pred$model$weib_h[[1]]$est), 
        col = "2", lty = 1, lwd = 1)
  lines(cbind(surv_pred$model$gom_h[[1]]$time, surv_pred$model$gom_h[[1]]$est), 
        col = "3", lty = 1, lwd = 1)
  lines(cbind(surv_pred$model$lnorm_h[[1]]$time, surv_pred$model$lnorm_h[[1]]$est), 
        col = "4", lty = 1, lwd = 1)
  lines(cbind(surv_pred$model$llog_h[[1]]$time, surv_pred$model$llog_h[[1]]$est), 
        col = "5", lty = 1, lwd = 1)
  lines(cbind(surv_pred$model$gam_h[[1]]$time, surv_pred$model$gam_h[[1]]$est), 
        col = "6", lty = 1, lwd = 1)
  lines(cbind(surv_pred$model$ggam_h[[1]]$time, surv_pred$model$ggam_h[[1]]$est), 
        col = "7", lty = 1, lwd = 1)
  legend("topleft", legend = misc$lbls, col = 1:7, lty = 1, cex = 0.8)
  
  if (input$spline_mod == TRUE) {
    plot(cbind(surv_obs$haz$smooth_gr1$est.grid, surv_obs$haz$smooth_gr1$haz.est),
         main = paste("Group", misc$group_names[1]),
         type = "l", col = "black", lty = 1, lwd = 2, xlab = "time", ylab = "smoothed hazard rate", 
         xlim = c(0, surv_obs$haz$max$time), ylim = c(0, surv_obs$haz$max$smooth))
    lines(cbind(surv_pred$model$spl_hazard1_h[[1]]$time, surv_pred$model$spl_hazard1_h[[1]]$est), 
          col = "1", lty = 1, lwd = 1)
    lines(cbind(surv_pred$model$spl_hazard2_h[[1]]$time, surv_pred$model$spl_hazard2_h[[1]]$est), 
          col = "2", lty = 1, lwd = 1)
    lines(cbind(surv_pred$model$spl_hazard3_h[[1]]$time, surv_pred$model$spl_hazard3_h[[1]]$est), 
          col = "3", lty = 1, lwd = 1)
    lines(cbind(surv_pred$model$spl_odds1_h[[1]]$time, surv_pred$model$spl_odds1_h[[1]]$est), 
          col = "4", lty = 1, lwd = 1)
    lines(cbind(surv_pred$model$spl_odds2_h[[1]]$time, surv_pred$model$spl_odds2_h[[1]]$est), 
          col = "5", lty = 1, lwd = 1)
    lines(cbind(surv_pred$model$spl_odds3_h[[1]]$time, surv_pred$model$spl_odds3_h[[1]]$est), 
          col = "6", lty = 1, lwd = 1)
    lines(cbind(surv_pred$model$spl_normal1_h[[1]]$time, surv_pred$model$spl_normal1_h[[1]]$est), 
          col = "7", lty = 1, lwd = 1)
    lines(cbind(surv_pred$model$spl_normal2_h[[1]]$time, surv_pred$model$spl_normal2_h[[1]]$est), 
          col = "8", lty = 1, lwd = 1)
    lines(cbind(surv_pred$model$spl_normal3_h[[1]]$time, surv_pred$model$spl_normal3_h[[1]]$est), 
          col = "9", lty = 1, lwd = 1)
    legend("topleft", legend = misc$lbls_spline, col = 1:9, lty = 1, cex = 0.8)
  }
  
  if (input$cure_mod == TRUE) {
    plot(cbind(surv_obs$haz$smooth_gr1$est.grid, surv_obs$haz$smooth_gr1$haz.est),
         main = paste("Group", misc$group_names[1]),
         type = "l", col = "black", lty = 1, lwd = 2, xlab = "time", ylab = "smoothed hazard rate", 
         xlim = c(0, surv_obs$haz$max$time), ylim = c(0, surv_obs$haz$max$smooth))
    lines(cbind(surv_pred$model$cure_weib_mix_h[, 1], surv_pred$model$cure_weib_mix_h[,2]),
          col = "1", lty = 1, lwd = 1)
    lines(cbind(surv_pred$model$cure_weib_nmix_h[, 1], surv_pred$model$cure_weib_nmix_h[,2]),
          col = "2", lty = 1, lwd = 1)
    lines(cbind(surv_pred$model$cure_lnorm_mix_h[, 1], surv_pred$model$cure_lnorm_mix_h[,2]),
          col = "3", lty = 1, lwd = 1)
    lines(cbind(surv_pred$model$cure_lnorm_nmix_h[, 1], surv_pred$model$cure_lnorm_nmix_h[,2]),
          col = "4", lty = 1, lwd = 1)
    lines(cbind(surv_pred$model$cure_llog_mix_h[, 1], surv_pred$model$cure_llog_mix_h[,2]),
          col = "5", lty = 1, lwd = 1)
    lines(cbind(surv_pred$model$cure_llog_nmix_h[, 1], surv_pred$model$cure_llog_nmix_h[,2]),
          col = "6", lty = 1, lwd = 1)
    legend("topleft", legend = misc$lbls_cure, col = 1:6, lty = 1, cex = 0.8)
  }
}, envir = PERSUADE)

# GROUP 2
evalq({
  if (misc$ngroups > 1) {
    plot(cbind(surv_obs$haz$smooth_gr2$est.grid, surv_obs$haz$smooth_gr2$haz.est), 
         main = paste("Group", misc$group_names[2]),
         type = "l", col = "black", lty = "2222", lwd = 2, xlab = "time", ylab = "smoothed hazard rate", 
         xlim = c(0, surv_obs$haz$max$time), ylim = c(0, surv_obs$haz$max$smooth))
    lines(cbind(surv_pred$model$expo_h[[2]]$time, surv_pred$model$expo_h[[2]]$est), 
          col = "1", lty = "2222", lwd = 1)
    lines(cbind(surv_pred$model$weib_h[[2]]$time, surv_pred$model$weib_h[[2]]$est), 
          col = "2", lty = "2222", lwd = 1)
    lines(cbind(surv_pred$model$gom_h[[2]]$time, surv_pred$model$gom_h[[2]]$est), 
          col = "3", lty = "2222", lwd = 1)
    lines(cbind(surv_pred$model$lnorm_h[[2]]$time, surv_pred$model$lnorm_h[[2]]$est), 
          col = "4", lty = "2222", lwd = 1)
    lines(cbind(surv_pred$model$llog_h[[2]]$time, surv_pred$model$llog_h[[2]]$est), 
          col = "5", lty = "2222", lwd = 1)
    lines(cbind(surv_pred$model$gam_h[[2]]$time, surv_pred$model$gam_h[[2]]$est), 
          col = "6", lty = "2222", lwd = 1)
    lines(cbind(surv_pred$model$ggam_h[[2]]$time, surv_pred$model$ggam_h[[2]]$est), 
          col = "7", lty = "2222", lwd = 1)
    legend("topleft", legend = misc$lbls, col = 1:7, lty = "2222", cex = 0.8)
    
    if (input$spline_mod == TRUE) {
      plot(cbind(surv_obs$haz$smooth_gr2$est.grid, surv_obs$haz$smooth_gr2$haz.est),
           main = paste("Group", misc$group_names[2]),
           type = "l", col = "black", lty = "2222", lwd = 2, xlab = "time", ylab = "smoothed hazard rate", 
           xlim = c(0, surv_obs$haz$max$time), ylim = c(0, surv_obs$haz$max$smooth))
      lines(cbind(surv_pred$model$spl_hazard1_h[[2]]$time, surv_pred$model$spl_hazard1_h[[2]]$est), 
            col = "1", lty = "2222", lwd = 1)
      lines(cbind(surv_pred$model$spl_hazard2_h[[2]]$time, surv_pred$model$spl_hazard2_h[[2]]$est), 
            col = "2", lty = "2222", lwd = 1)
      lines(cbind(surv_pred$model$spl_hazard3_h[[2]]$time, surv_pred$model$spl_hazard3_h[[2]]$est), 
            col = "3", lty = "2222", lwd = 1)
      lines(cbind(surv_pred$model$spl_odds1_h[[2]]$time, surv_pred$model$spl_odds1_h[[2]]$est), 
            col = "4", lty = "2222", lwd = 1)
      lines(cbind(surv_pred$model$spl_odds2_h[[2]]$time, surv_pred$model$spl_odds2_h[[2]]$est), 
            col = "5", lty = "2222", lwd = 1)
      lines(cbind(surv_pred$model$spl_odds3_h[[2]]$time, surv_pred$model$spl_odds3_h[[2]]$est), 
            col = "6", lty = "2222", lwd = 1)
      lines(cbind(surv_pred$model$spl_normal1_h[[2]]$time, surv_pred$model$spl_normal1_h[[2]]$est), 
            col = "7", lty = "2222", lwd = 1)
      lines(cbind(surv_pred$model$spl_normal2_h[[2]]$time, surv_pred$model$spl_normal2_h[[2]]$est), 
            col = "8", lty = "2222", lwd = 1)
      lines(cbind(surv_pred$model$spl_normal3_h[[2]]$time, surv_pred$model$spl_normal3_h[[2]]$est), 
            col = "9", lty = "2222", lwd = 1)
      legend("topleft", legend = misc$lbls_spline, col = 1:9, lty = "2222", cex = 0.8)
    }
    
    if (input$cure_mod == TRUE) {
      plot(cbind(surv_obs$haz$smooth_gr2$est.grid, surv_obs$haz$smooth_gr2$haz.est),
           main = paste("Group", misc$group_names[2]),
           type = "l", col = "black", lty = "2222", lwd = 2, xlab = "time", ylab = "smoothed hazard rate", 
           xlim = c(0, surv_obs$haz$max$time), ylim = c(0, surv_obs$haz$max$smooth))
      lines(cbind(surv_pred$model$cure_weib_mix_h[, 1], surv_pred$model$cure_weib_mix_h[,3]),
            col = "1", lty = "2222", lwd = 1)
      lines(cbind(surv_pred$model$cure_weib_nmix_h[, 1], surv_pred$model$cure_weib_nmix_h[,3]),
            col = "2", lty = "2222", lwd = 1)
      lines(cbind(surv_pred$model$cure_lnorm_mix_h[, 1], surv_pred$model$cure_lnorm_mix_h[,3]),
            col = "3", lty = "2222", lwd = 1)
      lines(cbind(surv_pred$model$cure_lnorm_nmix_h[, 1], surv_pred$model$cure_lnorm_nmix_h[,3]),
            col = "4", lty = "2222", lwd = 1)
      lines(cbind(surv_pred$model$cure_llog_mix_h[, 1], surv_pred$model$cure_llog_mix_h[,3]),
            col = "5", lty = "2222", lwd = 1)
      lines(cbind(surv_pred$model$cure_llog_nmix_h[, 1], surv_pred$model$cure_llog_nmix_h[,3]),
            col = "6", lty = "2222", lwd = 1)
      legend("topleft", legend = misc$lbls_cure, col = 1:6, lty = "2222", cex = 0.8)
    }
  }
}, envir = PERSUADE)

# GROUP 3
evalq({
  if (misc$ngroups > 2) {
    plot(cbind(surv_obs$haz$smooth_gr3$est.grid, surv_obs$haz$smooth_gr3$haz.est), 
         main = paste("Group", misc$group_names[3]),
         type = "l", col = "black", lty = "5212", lwd = 2, xlab = "time", ylab = "smoothed hazard rate", 
         xlim = c(0, surv_obs$haz$max$time), ylim = c(0, surv_obs$haz$max$smooth))
    lines(cbind(surv_pred$model$expo_h[[3]]$time, surv_pred$model$expo_h[[3]]$est), 
          col = "1", lty = "5212", lwd = 1)
    lines(cbind(surv_pred$model$weib_h[[3]]$time, surv_pred$model$weib_h[[3]]$est), 
          col = "2", lty = "5212", lwd = 1)
    lines(cbind(surv_pred$model$gom_h[[3]]$time, surv_pred$model$gom_h[[3]]$est), 
          col = "3", lty = "5212", lwd = 1)
    lines(cbind(surv_pred$model$lnorm_h[[3]]$time, surv_pred$model$lnorm_h[[3]]$est), 
          col = "4", lty = "5212", lwd = 1)
    lines(cbind(surv_pred$model$llog_h[[3]]$time, surv_pred$model$llog_h[[3]]$est), 
          col = "5", lty = "5212", lwd = 1)
    lines(cbind(surv_pred$model$gam_h[[3]]$time, surv_pred$model$gam_h[[3]]$est), 
          col = "6", lty = "5212", lwd = 1)
    lines(cbind(surv_pred$model$ggam_h[[3]]$time, surv_pred$model$ggam_h[[3]]$est), 
          col = "7", lty = "5212", lwd = 1)
    legend("topleft", legend = misc$lbls, col = 1:7, lty = "5212", cex = 0.8)
    
    if (input$spline_mod == TRUE) {
      plot(cbind(surv_obs$haz$smooth_gr3$est.grid, surv_obs$haz$smooth_gr3$haz.est), 
           main = paste("Group", misc$group_names[3]),
           type = "l", col = "black", lty = "5212", lwd = 2, xlab = "time", ylab = "smoothed hazard rate", 
           xlim = c(0, surv_obs$haz$max$time), ylim = c(0, surv_obs$haz$max$smooth))
      lines(cbind(surv_pred$model$spl_hazard1_h[[3]]$time, surv_pred$model$spl_hazard1_h[[3]]$est), 
            col = "1", lty = "5212", lwd = 1)
      lines(cbind(surv_pred$model$spl_hazard2_h[[3]]$time, surv_pred$model$spl_hazard2_h[[3]]$est), 
            col = "2", lty = "5212", lwd = 1)
      lines(cbind(surv_pred$model$spl_hazard3_h[[3]]$time, surv_pred$model$spl_hazard3_h[[3]]$est), 
            col = "3", lty = "5212", lwd = 1)
      lines(cbind(surv_pred$model$spl_odds1_h[[3]]$time, surv_pred$model$spl_odds1_h[[3]]$est), 
            col = "4", lty = "5212", lwd = 1)
      lines(cbind(surv_pred$model$spl_odds2_h[[3]]$time, surv_pred$model$spl_odds2_h[[3]]$est), 
            col = "5", lty = "5212", lwd = 1)
      lines(cbind(surv_pred$model$spl_odds3_h[[3]]$time, surv_pred$model$spl_odds3_h[[3]]$est), 
            col = "6", lty = "5212", lwd = 1)
      lines(cbind(surv_pred$model$spl_normal1_h[[3]]$time, surv_pred$model$spl_normal1_h[[3]]$est), 
            col = "7", lty = "5212", lwd = 1)
      lines(cbind(surv_pred$model$spl_normal2_h[[3]]$time, surv_pred$model$spl_normal2_h[[3]]$est), 
            col = "8", lty = "5212", lwd = 1)
      lines(cbind(surv_pred$model$spl_normal3_h[[3]]$time, surv_pred$model$spl_normal3_h[[3]]$est), 
            col = "9", lty = "5212", lwd = 1)
      legend("topleft", legend = misc$lbls_spline, col = 1:9, lty = "5212", cex = 0.8)
    }
    
    if (input$cure_mod == TRUE) {
      plot(cbind(surv_obs$haz$smooth_gr3$est.grid, surv_obs$haz$smooth_gr3$haz.est), 
           main = paste("Group", misc$group_names[3]),
           type = "l", col = "black", lty = "5212", lwd = 2, xlab = "time", ylab = "smoothed hazard rate", 
           xlim = c(0, surv_obs$haz$max$time), ylim = c(0, surv_obs$haz$max$smooth))
      lines(cbind(surv_pred$model$cure_weib_mix_h[, 1], surv_pred$model$cure_weib_mix_h[,4]),
            col = "1", lty = "5212", lwd = 1)
      lines(cbind(surv_pred$model$cure_weib_nmix_h[, 1], surv_pred$model$cure_weib_nmix_h[,4]),
            col = "2", lty = "5212", lwd = 1)
      lines(cbind(surv_pred$model$cure_lnorm_mix_h[, 1], surv_pred$model$cure_lnorm_mix_h[,4]),
            col = "3", lty = "5212", lwd = 1)
      lines(cbind(surv_pred$model$cure_lnorm_nmix_h[, 1], surv_pred$model$cure_lnorm_nmix_h[,4]),
            col = "4", lty = "5212", lwd = 1)
      lines(cbind(surv_pred$model$cure_llog_mix_h[, 1], surv_pred$model$cure_llog_mix_h[,4]),
            col = "5", lty = "5212", lwd = 1)
      lines(cbind(surv_pred$model$cure_llog_nmix_h[, 1], surv_pred$model$cure_llog_nmix_h[,4]),
            col = "6", lty = "5212", lwd = 1)
      legend("topleft", legend = misc$lbls_cure, col = 1:6, lty = "5212", cex = 0.8)
    }
  }
}, envir = PERSUADE)

```

\newpage

# Standard parametric models  
The circle displays the colours that are attributed to each parametric survival model in the graphs on the following pages.  
The Table below displays the goodness-of-fit statistics for each parametric survival model, ordered from 'best' fitting to less well fitting based on the Akaike Information Criterion (AIC). The AIC and Bayesian Information Criterion (BIC) provide a measure of the relative fit of each model to the data, while penalising for the number of parameter included in the fitted models. The lower the AIC or BIC, the better the relative fit of a model compared to other fitted models.  

In the following pages, three plots per fitted parametric survival model are displayed to support the visual inspection of the fit of the models to the observed data. Figure A shows the Kaplan-Meier curves (black and gray) versus the fitted parametric survival models (colour). Figure B displays a comparison of the smoothed hazard rates based on the empirical data (black and gray) versus the estimated transition probabilities (colour). In all Figures A and B, the Kaplan-Meier curves  and the smoothed hazard rates are the same. Figure C shows a specific diagnostic plot for each fitted parametric survival model (see graphical test in Table 1 by [Ishak et al. (2013)](https://doi.org/10.1007/s40273-013-0064-3). For all these plots, the rule is: the closer the coloured lines are to the black and grey lines, the better.  

Notably, the Weibull (shape = 1), Gompertz (shape = 0) and gamma (shape = 1) distributions can simplify to the exponential distribution. The generalised gamma distribution can simplify to the log-normal (Q = 0), Weibull (Q = 1), exponential (Q = 1 and scale = 1) and gamma (Q = scale) distributions. Information regarding the parameterisation of the parametric survival models can be found [here](https://devinincerti.com/code/survival-distributions.html).  

**CAUTION**: These goodness-of-fit statistics only apply to the observed data period and do not allow to issue statements about the suitability of the extrapolated survival by these fitted models beyond this period. Additionally, the end of the observed data period may be affected by the low number of observations. One should consider this when interpreting the tail of the curves.  

```{r plot_parametric, echo=FALSE}
evalq({
  pie(rep(1, n), labels = misc$lbls, col = rainbow(n = n, s = 1, v = 1, start = 0, 
                                                   end = max(1, n - 1)/n, alpha = 1))
  kable_styling(kable(surv_model$IC[order(surv_model$IC$AIC), ], format = "latex", 
                      row.names = FALSE, booktabs = TRUE, linesep = ""), latex_options = "striped")
}, envir = PERSUADE)
```

\newpage

## Exponential
```{r expo, echo=FALSE, out.height = "25%", fig.width=11}
evalq({
  # constant hazard
  plot(surv_obs$km, lwd = 2, main = "A: Kaplan-Meier (Exponential)", xlab = "time", 
       ylab = "survival", col = c("black", "lightgrey", "darkgrey"))
  lines(cbind(input$time_pred, surv_pred$model$expo[, 2]), col = "1", lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(input$time_pred, surv_pred$model$expo[, 3]), col = "1", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(input$time_pred, surv_pred$model$expo[, 4]), col = "1", lty = "5212", lwd = 2)
  }
  # add shading confidence intervals
  polygon(na.omit(data.frame(c(surv_obs$km$time[surv_obs$km_names == 1], rev(surv_obs$km$time[surv_obs$km_names == 1])),
                             c(surv_obs$km$lower[surv_obs$km_names == 1], rev(surv_obs$km$upper[surv_obs$km_names == 1])))), 
          col = adjustcolor("black", alpha.f = 0.3), border = NA)
  if (misc$ngroups > 1) {
    polygon(na.omit(data.frame(c(surv_obs$km$time[surv_obs$km_names == 2], rev(surv_obs$km$time[surv_obs$km_names == 2])),
                               c(surv_obs$km$lower[surv_obs$km_names == 2], rev(surv_obs$km$upper[surv_obs$km_names == 2])))), 
            col = adjustcolor("lightgrey", alpha.f = 0.3), border = NA)
  }
  if (misc$ngroups > 2) {
    polygon(na.omit(data.frame(c(surv_obs$km$time[surv_obs$km_names == 3], rev(surv_obs$km$time[surv_obs$km_names ==3])),
                               c(surv_obs$km$lower[surv_obs$km_names == 3], rev(surv_obs$km$upper[surv_obs$km_names == 3])))),
            col = adjustcolor("darkgrey", alpha.f = 0.3), border = NA)
  }
  legend("bottomleft", legend = c(misc$group_names, rep("", length(misc$group_names))), 
         col = c(rep("1", misc$ngroups), c("black", "lightgrey", "darkgrey")[1:misc$ngroups]), 
         lty = c(as.integer(c(1, "2222", "5212")[1:misc$ngroups]), rep(1, misc$ngroups)), 
         cex = 0.8, ncol = 2,
         bty = 'n')
  
  # annual transition probabilities
  plot(cbind(surv_obs$tp$gr_1$time, surv_obs$tp$gr_1$smooth), lwd = 1, 
       lty = 1, type = "b", cex = 0.6, pch = 1, col = "black", 
       main = "B: Annual transition probability (Exponential)", 
       xlab = "time", ylab = "annual transition probability (smoothed)", 
       ylim = c(0, ceiling(surv_obs$tp$max * 10)/10), xlim = c(0, ceiling(surv_obs$km$maxtime * 10)/10))
  lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_1[, 2]), col = "1", 
        lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(surv_obs$tp$gr_2$time, surv_obs$tp$gr_2$smooth), 
          col = "lightgrey", type = "b", lwd = 1, cex = 0.6, pch = 8)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_2[, 2]), col = "1", 
          lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(surv_obs$tp$gr_3$time, surv_obs$tp$gr_3$smooth), 
          col = "darkgrey", type = "b", lwd = 1, cex = 0.6, pch = 9)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_3[, 2]), col = "1", 
          lty = "5212", lwd = 2)
  }
  # add shading confidence intervals
  polygon(c(surv_obs$tp$gr_1$time, rev(surv_obs$tp$gr_1$time)), 
          c(surv_obs$tp$gr_1$smooth_lower, rev(surv_obs$tp$gr_1$smooth_upper)), 
          col = adjustcolor("black", alpha.f = 0.3), border = NA)
  if (misc$ngroups > 1) {
    polygon(c(surv_obs$tp$gr_2$time, rev(surv_obs$tp$gr_2$time)), 
            c(surv_obs$tp$gr_2$smooth_lower, rev(surv_obs$tp$gr_2$smooth_upper)), 
            col = adjustcolor("lightgrey", alpha.f = 0.3), border = NA)
  }
  if (misc$ngroups > 2) {
    polygon(c(surv_obs$tp$gr_3$time, rev(surv_obs$tp$gr_3$time)), 
            c(surv_obs$tp$gr_3$smooth_lower, rev(surv_obs$tp$gr_3$smooth_upper)), 
            col = adjustcolor("darkgrey", alpha.f = 0.3), border = NA)
  }
  legend("topleft", legend = c(misc$group_names, rep("", length(misc$group_names))), 
         col =  c(rep("1", misc$ngroups), c("black", "lightgrey", "darkgrey")[1:misc$ngroups]), 
         lty = c(as.integer(c(1, "2222", "5212")[1:misc$ngroups]), rep(NA, misc$ngroups)),
         pch = c(rep(NA, misc$ngroups), c(1, 8, 9)[1:misc$ngroups]),
         cex = 0.8, ncol = 2,
         bty = "n")
  
  # diagnostics
  plot(cbind(surv_obs$km$time, -log(surv_obs$km$surv)), cex = 0.6, 
       pch = c(1, 8, 9)[surv_obs$km_names], col = c("black", "lightgrey", "darkgrey")[surv_obs$km_names], 
       main = "C: Diagnostic plot (Exponential)", xlab = "time", ylab = "cumulative hazard")
  lines(cbind(input$time_pred, -log(surv_pred$model$expo[, 2])), col = "1", lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(input$time_pred, -log(surv_pred$model$expo[, 3])), col = "1", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(input$time_pred, -log(surv_pred$model$expo[, 4])), col = "1", lty = "5212", lwd = 2)
  }
  legend("topleft", legend = c(misc$group_names, rep("", length(misc$group_names))), 
         col =  c(rep("1", misc$ngroups), c("black", "lightgrey", "darkgrey")[1:misc$ngroups]), 
         lty = c(as.integer(c(1, "2222", "5212")[1:misc$ngroups]), rep(NA, misc$ngroups)),
         pch = c(rep(NA, misc$ngroups), c(1, 8, 9)[1:misc$ngroups]),
         cex = 0.8, ncol = 2,
         bty = "n")
  
}, envir = PERSUADE)
```

\newpage  

## Weibull
```{r weib, echo=FALSE, out.height = "25%", fig.width=11}
evalq({
  # monotonically increasing or decreasing hazard
  plot(surv_obs$km, lwd = 2, main = "A: Kaplan-Meier (Weibull)", xlab = "time", 
       ylab = "survival", col = c("black", "lightgrey", "darkgrey"))
  lines(cbind(input$time_pred, surv_pred$model$weib[, 2]), col = "2", lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(input$time_pred, surv_pred$model$weib[, 3]), col = "2", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(input$time_pred, surv_pred$model$weib[, 4]), col = "2", lty = "5212", lwd = 2)
  }
  # add shading confidence intervals
  polygon(na.omit(data.frame(c(surv_obs$km$time[surv_obs$km_names == 1], rev(surv_obs$km$time[surv_obs$km_names == 1])),
                             c(surv_obs$km$lower[surv_obs$km_names == 1], rev(surv_obs$km$upper[surv_obs$km_names == 1])))), 
          col = adjustcolor("black", alpha.f = 0.3), border = NA)
  if (misc$ngroups > 1) {
    polygon(na.omit(data.frame(c(surv_obs$km$time[surv_obs$km_names == 2], rev(surv_obs$km$time[surv_obs$km_names == 2])),
                               c(surv_obs$km$lower[surv_obs$km_names == 2], rev(surv_obs$km$upper[surv_obs$km_names == 2])))),
            col = adjustcolor("lightgrey", alpha.f = 0.3), border = NA)
  }
  if (misc$ngroups > 2) {
    polygon(na.omit(data.frame(c(surv_obs$km$time[surv_obs$km_names == 3], rev(surv_obs$km$time[surv_obs$km_names == 3])),
                               c(surv_obs$km$lower[surv_obs$km_names == 3], rev(surv_obs$km$upper[surv_obs$km_names == 3])))),
            col = adjustcolor("darkgrey", alpha.f = 0.3), border = NA)
  }
  legend("bottomleft", legend = c(misc$group_names, rep("", length(misc$group_names))), 
         col = c(rep("2", misc$ngroups), c("black", "lightgrey", "darkgrey")[1:misc$ngroups]), 
         lty = c(as.integer(c(1, "2222", "5212")[1:misc$ngroups]), rep(1, misc$ngroups)), 
         cex = 0.8, ncol = 2,
         bty = "n")
  
  # annual transition probabilities
  plot(cbind(surv_obs$tp$gr_1$time, surv_obs$tp$gr_1$smooth), lwd = 1, 
       lty = 1, type = "b", cex = 0.6, pch = 1, col = "black", 
       main = "B: Annual transition probability (Weibull)", 
       xlab = "time", ylab = "annual transition probability (smoothed)", 
       ylim = c(0, ceiling(surv_obs$tp$max * 10)/10), xlim = c(0, ceiling(surv_obs$km$maxtime * 10)/10))
  lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_1[, 3]), col = "2", lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(surv_obs$tp$gr_2$time, surv_obs$tp$gr_2$smooth), 
          col = "lightgrey", type = "b", lwd = 1, cex = 0.6, pch = 8)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_2[, 3]), col = "2", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(surv_obs$tp$gr_3$time, surv_obs$tp$gr_3$smooth), 
          col = "darkgrey", type = "b", lwd = 1, cex = 0.6, pch = 9)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_3[, 3]), col = "2", 
          lty = "5212", lwd = 2)
  }
  # add shading confidence intervals
  polygon(c(surv_obs$tp$gr_1$time, rev(surv_obs$tp$gr_1$time)), 
          c(surv_obs$tp$gr_1$smooth_lower, rev(surv_obs$tp$gr_1$smooth_upper)), 
          col = adjustcolor("black", alpha.f = 0.3), border = NA)
  if (misc$ngroups > 1) {
    polygon(c(surv_obs$tp$gr_2$time, rev(surv_obs$tp$gr_2$time)), 
            c(surv_obs$tp$gr_2$smooth_lower, rev(surv_obs$tp$gr_2$smooth_upper)), 
            col = adjustcolor("lightgrey", alpha.f = 0.3), border = NA)
  }
  if (misc$ngroups > 2) {
    polygon(c(surv_obs$tp$gr_3$time, rev(surv_obs$tp$gr_3$time)), 
            c(surv_obs$tp$gr_3$smooth_lower, rev(surv_obs$tp$gr_3$smooth_upper)), 
            col = adjustcolor("darkgrey", alpha.f = 0.3), border = NA)
  }
  legend("topleft", legend = c(misc$group_names, rep("", length(misc$group_names))), 
         col =  c(rep("2", misc$ngroups), c("black", "lightgrey", "darkgrey")[1:misc$ngroups]), 
         lty = c(as.integer(c(1, "2222", "5212")[1:misc$ngroups]), rep(NA, misc$ngroups)),
         pch = c(rep(NA, misc$ngroups), c(1, 8, 9)[1:misc$ngroups]),
         cex = 0.8, ncol = 2,
         bty = "n")
  
  # diagnostics
  plot(cbind(log(surv_obs$km$time), log(-log(surv_obs$km$surv))), cex = 0.6, pch = c(1, 8, 9)[surv_obs$km_names],
       xlim = c(floor(min(log(surv_obs$km$time)[surv_obs$km$surv != 1])), ceiling(max(log(surv_obs$km$time)))),
       col = c("black", "lightgrey", "darkgrey")[surv_obs$km_names], main = "C: Diagnostic plot (Weibull)", 
       xlab = "LN(time)", ylab = "LN(cumulative hazard)")
  lines(cbind(log(input$time_pred), log(-log(surv_pred$model$weib[, 2]))), col = "2", lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(log(input$time_pred), log(-log(surv_pred$model$weib[, 3]))), col = "2", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(log(input$time_pred), log(-log(surv_pred$model$weib[, 4]))), col = "2", lty = "5212", lwd = 2)
  }
  legend("topleft", legend = c(misc$group_names, rep("", length(misc$group_names))), 
         col =  c(rep("2", misc$ngroups), c("black", "lightgrey", "darkgrey")[1:misc$ngroups]), 
         lty = c(as.integer(c(1, "2222", "5212")[1:misc$ngroups]), rep(NA, misc$ngroups)),
         pch = c(rep(NA, misc$ngroups), c(1, 8, 9)[1:misc$ngroups]),
         cex = 0.8, ncol = 2,
         bty = "n")
}, envir = PERSUADE)
```

\newpage 

## Gompertz
```{r gom, echo=FALSE, out.height = "25%", fig.width=11}
evalq({
  # monotonically increasing or decreasing hazard
  plot(surv_obs$km, lwd = 2, main = "A: Kaplan-Meier (Gompertz)", xlab = "time", 
       ylab = "survival", col = c("black", "lightgrey", "darkgrey"))
  lines(cbind(input$time_pred, surv_pred$model$gom[, 2]), col = "3", lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(input$time_pred, surv_pred$model$gom[, 3]), col = "3", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(input$time_pred, surv_pred$model$gom[, 4]), col = "3", lty = "5212", lwd = 2)
  }
  # add shading confidence intervals
  polygon(na.omit(data.frame(c(surv_obs$km$time[surv_obs$km_names == 1], rev(surv_obs$km$time[surv_obs$km_names == 1])),
                             c(surv_obs$km$lower[surv_obs$km_names == 1], rev(surv_obs$km$upper[surv_obs$km_names == 1])))), 
          col = adjustcolor("black", alpha.f = 0.3), border = NA)
  if (misc$ngroups > 1) {
    polygon(na.omit(data.frame(c(surv_obs$km$time[surv_obs$km_names == 2], rev(surv_obs$km$time[surv_obs$km_names == 2])),
                               c(surv_obs$km$lower[surv_obs$km_names == 2], rev(surv_obs$km$upper[surv_obs$km_names == 2])))),
            col = adjustcolor("lightgrey", alpha.f = 0.3), border = NA)
  }
  if (misc$ngroups > 2) {
    polygon(na.omit(data.frame(c(surv_obs$km$time[surv_obs$km_names == 3], rev(surv_obs$km$time[surv_obs$km_names == 3])),
                               c(surv_obs$km$lower[surv_obs$km_names == 3], rev(surv_obs$km$upper[surv_obs$km_names == 3])))), 
            col = adjustcolor("darkgrey", alpha.f = 0.3), border = NA)
  }
  legend("bottomleft", legend = c(misc$group_names, rep("", length(misc$group_names))), 
         col = c(rep("3", misc$ngroups), c("black", "lightgrey", "darkgrey")[1:misc$ngroups]), 
         lty = c(as.integer(c(1, "2222", "5212")[1:misc$ngroups]), rep(1, misc$ngroups)), 
         cex = 0.8, ncol = 2,
         bty = "n")
  
  # annual transition probabilities
  plot(cbind(surv_obs$tp$gr_1$time, surv_obs$tp$gr_1$smooth), lwd = 1, 
       lty = 1, type = "b", cex = 0.6, pch = 1, col = "black", 
       main = "B: Annual transition probability (Gompertz)", 
       xlab = "time", ylab = "annual transition probability (smoothed)", 
       ylim = c(0, ceiling(surv_obs$tp$max * 10)/10), xlim = c(0, ceiling(surv_obs$km$maxtime * 10)/10))
  lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_1[, 4]), col = "3", 
        lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(surv_obs$tp$gr_2$time, surv_obs$tp$gr_2$smooth), 
          col = "lightgrey", type = "b", lwd = 1, cex = 0.6, pch = 8)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_2[, 4]), col = "3", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(surv_obs$tp$gr_3$time, surv_obs$tp$gr_3$smooth), 
          col = "darkgrey", type = "b", lwd = 1, cex = 0.6, pch = 9)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_3[, 4]), col = "3", lty = "5212", lwd = 2)
  }
  # add shading confidence intervals
  polygon(c(surv_obs$tp$gr_1$time, rev(surv_obs$tp$gr_1$time)), 
          c(surv_obs$tp$gr_1$smooth_lower, rev(surv_obs$tp$gr_1$smooth_upper)), 
          col = adjustcolor("black", alpha.f = 0.3), border = NA)
  if (misc$ngroups > 1) {
    polygon(c(surv_obs$tp$gr_2$time, rev(surv_obs$tp$gr_2$time)), 
            c(surv_obs$tp$gr_2$smooth_lower, rev(surv_obs$tp$gr_2$smooth_upper)), 
            col = adjustcolor("lightgrey", alpha.f = 0.3), border = NA)
  }
  if (misc$ngroups > 2) {
    polygon(c(surv_obs$tp$gr_3$time, rev(surv_obs$tp$gr_3$time)), 
            c(surv_obs$tp$gr_3$smooth_lower, rev(surv_obs$tp$gr_3$smooth_upper)), 
            col = adjustcolor("darkgrey", alpha.f = 0.3), border = NA)
  }
  legend("topleft", legend = c(misc$group_names, rep("", length(misc$group_names))), 
         col =  c(rep("3", misc$ngroups), c("black", "lightgrey", "darkgrey")[1:misc$ngroups]), 
         lty = c(as.integer(c(1, "2222", "5212")[1:misc$ngroups]), rep(NA, misc$ngroups)),
         pch = c(rep(NA, misc$ngroups), c(1, 8, 9)[1:misc$ngroups]),
         cex = 0.8, ncol = 2,
         bty = "n")
  
  # diagnostics
  plot(cbind(c(surv_obs$haz$smooth_gr1$est.grid, 
               if (misc$ngroups > 1) {surv_obs$haz$smooth_gr2$est.grid} else {NA}, 
               if (misc$ngroups > 2) {surv_obs$haz$smooth_gr3$est.grid} else {NA}),
             c(log(surv_obs$haz$smooth_gr1$haz.est), 
               if (misc$ngroups > 1) {log(surv_obs$haz$smooth_gr2$haz.est)} else {NA}, 
               if (misc$ngroups > 2) {log(surv_obs$haz$smooth_gr3$haz.est)} else {NA})), 
       cex = 0.6, main = "C: Diagnostic plot (Gompertz)", xlab = "time", ylab = "LN(smoothed hazard)", 
       pch = c(1, 8, 9)[surv_obs$haz$names], col = c("black", "lightgrey", "darkgrey")[surv_obs$haz$names])
  lines(cbind(surv_pred$model$gom_h[[1]]$time, log(surv_pred$model$gom_h[[1]]$est)), col = "3", lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(surv_pred$model$gom_h[[2]]$time, log(surv_pred$model$gom_h[[2]]$est)), 
          col = "3", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(surv_pred$model$gom_h[[3]]$time, log(surv_pred$model$gom_h[[3]]$est)), 
          col = "3", lty = "5212", lwd = 2)
  }
  legend("bottomleft", legend = c(misc$group_names, rep("", length(misc$group_names))), 
         col =  c(rep("3", misc$ngroups), c("black", "lightgrey", "darkgrey")[1:misc$ngroups]), 
         lty = c(as.integer(c(1, "2222", "5212")[1:misc$ngroups]), rep(NA, misc$ngroups)),
         pch = c(rep(NA, misc$ngroups), c(1, 8, 9)[1:misc$ngroups]),
         cex = 0.8, ncol = 2,
         bty = "n")
  
}, envir = PERSUADE)
```

\newpage 

## Log-normal
```{r lnorm, echo=FALSE, out.height = "25%", fig.width=11}
evalq({
  # hazard can be non-monotonic with respect to time; initially an increasing
  # hazard, followed by a decreasing hazard
  plot(surv_obs$km, lwd = 2, main = "A: Kaplan-Meier (Log-normal)", xlab = "time", 
       ylab = "survival", col = c("black", "lightgrey", "darkgrey"))
  lines(cbind(input$time_pred, surv_pred$model$lnorm[, 2]), col = "4", lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(input$time_pred, surv_pred$model$lnorm[, 3]), col = "4", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(input$time_pred, surv_pred$model$lnorm[, 4]), col = "4", lty = "5212", lwd = 2)
  }
  # add shading confidence intervals
  polygon(na.omit(data.frame(c(surv_obs$km$time[surv_obs$km_names == 1], rev(surv_obs$km$time[surv_obs$km_names == 1])),
                             c(surv_obs$km$lower[surv_obs$km_names == 1], rev(surv_obs$km$upper[surv_obs$km_names == 1])))), 
          col = adjustcolor("black", alpha.f = 0.3), border = NA)
  if (misc$ngroups > 1) {
    polygon(na.omit(data.frame(c(surv_obs$km$time[surv_obs$km_names == 2], rev(surv_obs$km$time[surv_obs$km_names == 2])),
                               c(surv_obs$km$lower[surv_obs$km_names == 2], rev(surv_obs$km$upper[surv_obs$km_names == 2])))),
            col = adjustcolor("lightgrey", alpha.f = 0.3), border = NA)
  }
  if (misc$ngroups > 2) {
    polygon(na.omit(data.frame(c(surv_obs$km$time[surv_obs$km_names == 3], rev(surv_obs$km$time[surv_obs$km_names == 3])),
                               c(surv_obs$km$lower[surv_obs$km_names == 3], rev(surv_obs$km$upper[surv_obs$km_names == 3])))),
            col = adjustcolor("darkgrey", alpha.f = 0.3), border = NA)
  }
  legend("bottomleft", legend = c(misc$group_names, rep("", length(misc$group_names))), 
         col = c(rep("4", misc$ngroups), c("black", "lightgrey", "darkgrey")[1:misc$ngroups]), 
         lty = c(as.integer(c(1, "2222", "5212")[1:misc$ngroups]), rep(1, misc$ngroups)), 
         cex = 0.8, ncol = 2,
         bty = "n")
  
  # annual transition probabilities
  plot(cbind(surv_obs$tp$gr_1$time, surv_obs$tp$gr_1$smooth), lwd = 1, 
       lty = 1, type = "b", cex = 0.6, pch = 1, col = "black", 
       main = "B: Annual transition probability (Log-normal)", 
       xlab = "time", ylab = "annual transition probability (smoothed)", 
       ylim = c(0, ceiling(surv_obs$tp$max * 10)/10), xlim = c(0, ceiling(surv_obs$km$maxtime * 10)/10))
  lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_1[, 5]), col = "4", lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(surv_obs$tp$gr_2$time, surv_obs$tp$gr_2$smooth), 
          col = "lightgrey", type = "b", lwd = 1, cex = 0.6, pch = 8)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_2[, 5]), col = "4", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(surv_obs$tp$gr_3$time, surv_obs$tp$gr_3$smooth), 
          col = "darkgrey", type = "b", lwd = 1, cex = 0.6, pch = 9)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_3[, 5]), col = "4", lty = "5212", lwd = 2)
  }
  # add shading confidence intervals
  polygon(c(surv_obs$tp$gr_1$time, rev(surv_obs$tp$gr_1$time)), 
          c(surv_obs$tp$gr_1$smooth_lower, rev(surv_obs$tp$gr_1$smooth_upper)), 
          col = adjustcolor("black", alpha.f = 0.3), border = NA)
  if (misc$ngroups > 1) {
    polygon(c(surv_obs$tp$gr_2$time, rev(surv_obs$tp$gr_2$time)), 
            c(surv_obs$tp$gr_2$smooth_lower, rev(surv_obs$tp$gr_2$smooth_upper)), 
            col = adjustcolor("lightgrey", alpha.f = 0.3), border = NA)
  }
  if (misc$ngroups > 2) {
    polygon(c(surv_obs$tp$gr_3$time, rev(surv_obs$tp$gr_3$time)), 
            c(surv_obs$tp$gr_3$smooth_lower, rev(surv_obs$tp$gr_3$smooth_upper)), 
            col = adjustcolor("darkgrey", alpha.f = 0.3), border = NA)
  }
  legend("topleft", legend = c(misc$group_names, rep("", length(misc$group_names))), 
         col =  c(rep("4", misc$ngroups), c("black", "lightgrey", "darkgrey")[1:misc$ngroups]), 
         lty = c(as.integer(c(1, "2222", "5212")[1:misc$ngroups]), rep(NA, misc$ngroups)),
         pch = c(rep(NA, misc$ngroups), c(1, 8, 9)[1:misc$ngroups]),
         cex = 0.8, ncol = 2,
         bty = "n")
  
  # diagnostics
  plot(cbind(log(surv_obs$km$time), 
             -qnorm(surv_obs$km$surv, mean = 0, sd = 1, lower.tail = TRUE, log.p = FALSE)), 
       cex = 0.6, main = "C: Diagnostic plot (Log-normal)", xlab = "LN(time)", 
       xlim = c(floor(min(log(surv_obs$km$time)[surv_obs$km$surv != 1])), ceiling(max(log(surv_obs$km$time)))),
       pch = c(1, 8, 9)[surv_obs$km_names], col = c("black", "lightgrey", "darkgrey")[surv_obs$km_names], 
       ylab = "- standard normal quartiles")
  lines(cbind(log(input$time_pred), 
              -qnorm(surv_pred$model$lnorm[, 2], mean = 0, sd = 1, lower.tail = TRUE, log.p = FALSE)), 
        col = "4", lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(log(input$time_pred), 
                -qnorm(surv_pred$model$lnorm[, 3], mean = 0, sd = 1, lower.tail = TRUE, log.p = FALSE)),
          col = "4", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(log(input$time_pred), 
                -qnorm(surv_pred$model$lnorm[, 4], mean = 0, sd = 1, lower.tail = TRUE, log.p = FALSE)), 
          col = "4", lty = "5212", lwd = 2)
  }
  legend("topleft", legend = c(misc$group_names, rep("", length(misc$group_names))), 
         col =  c(rep("4", misc$ngroups), c("black", "lightgrey", "darkgrey")[1:misc$ngroups]), 
         lty = c(as.integer(c(1, "2222", "5212")[1:misc$ngroups]), rep(NA, misc$ngroups)),
         pch = c(rep(NA, misc$ngroups), c(1, 8, 9)[1:misc$ngroups]),
         cex = 0.8, ncol = 2,
         bty = "n")
  
}, envir = PERSUADE)
```

\newpage 

## Log-logistic
```{r llog, echo=FALSE, out.height = "25%", fig.width=11}
evalq({
  # hazard can be non-monotonic with respect to time; initially an increasing
  # hazard, followed by a decreasing hazard
  plot(surv_obs$km, lwd = 2, main = "A: Kaplan-Meier (Log-logistic)", xlab = "time", 
       ylab = "survival", col = c("black", "lightgrey", "darkgrey"))
  lines(cbind(input$time_pred, surv_pred$model$llog[, 2]), col = "5", lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(input$time_pred, surv_pred$model$llog[, 3]), col = "5", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(input$time_pred, surv_pred$model$llog[, 4]), col = "5", lty = "5212", lwd = 2)
  }
  # add shading confidence intervals
  polygon(na.omit(data.frame(c(surv_obs$km$time[surv_obs$km_names == 1], rev(surv_obs$km$time[surv_obs$km_names == 1])),
                             c(surv_obs$km$lower[surv_obs$km_names == 1], rev(surv_obs$km$upper[surv_obs$km_names == 1])))), 
          col = adjustcolor("black", alpha.f = 0.3), border = NA)
  if (misc$ngroups > 1) {
    polygon(na.omit(data.frame(c(surv_obs$km$time[surv_obs$km_names == 2], rev(surv_obs$km$time[surv_obs$km_names == 2])),
                               c(surv_obs$km$lower[surv_obs$km_names == 2], rev(surv_obs$km$upper[surv_obs$km_names == 2])))), 
            col = adjustcolor("lightgrey", alpha.f = 0.3), border = NA)
  }
  if (misc$ngroups > 2) {
    polygon(na.omit(data.frame(c(surv_obs$km$time[surv_obs$km_names == 3], rev(surv_obs$km$time[surv_obs$km_names == 3])),
                               c(surv_obs$km$lower[surv_obs$km_names == 3], rev(surv_obs$km$upper[surv_obs$km_names == 3])))),
            col = adjustcolor("darkgrey", alpha.f = 0.3), border = NA)
  }
  legend("bottomleft", legend = c(misc$group_names, rep("", length(misc$group_names))), 
         col = c(rep("5", misc$ngroups), c("black", "lightgrey", "darkgrey")[1:misc$ngroups]), 
         lty = c(as.integer(c(1, "2222", "5212")[1:misc$ngroups]), rep(1, misc$ngroups)), 
         cex = 0.8, ncol = 2,
         bty = "n")
  
  # annual transition probabilities
  plot(cbind(surv_obs$tp$gr_1$time, surv_obs$tp$gr_1$smooth), lwd = 1, 
       lty = 1, type = "b", cex = 0.6, pch = 1, col = "black", 
       main = "B: Annual transition probability (Log-logistic)", 
       xlab = "time", ylab = "annual transition probability (smoothed)", 
       ylim = c(0, ceiling(surv_obs$tp$max * 10)/10), xlim = c(0, ceiling(surv_obs$km$maxtime * 10)/10))
  lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_1[, 6]), col = "5", 
        lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(surv_obs$tp$gr_2$time, surv_obs$tp$gr_2$smooth), 
          col = "lightgrey", type = "b", lwd = 1, cex = 0.6, pch = 8)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_2[, 6]), col = "5", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(surv_obs$tp$gr_3$time, surv_obs$tp$gr_3$smooth), 
          col = "darkgrey", type = "b", lwd = 1, cex = 0.6, pch = 9)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_3[, 6]), col = "5", lty = "5212", lwd = 2)
  }
  # add shading confidence intervals
  polygon(c(surv_obs$tp$gr_1$time, rev(surv_obs$tp$gr_1$time)), 
          c(surv_obs$tp$gr_1$smooth_lower, rev(surv_obs$tp$gr_1$smooth_upper)), 
          col = adjustcolor("black", alpha.f = 0.3), border = NA)
  if (misc$ngroups > 1) {
    polygon(c(surv_obs$tp$gr_2$time, rev(surv_obs$tp$gr_2$time)), 
            c(surv_obs$tp$gr_2$smooth_lower, rev(surv_obs$tp$gr_2$smooth_upper)), 
            col = adjustcolor("lightgrey", alpha.f = 0.3), border = NA)
  }
  if (misc$ngroups > 2) {
    polygon(c(surv_obs$tp$gr_3$time, rev(surv_obs$tp$gr_3$time)), 
            c(surv_obs$tp$gr_3$smooth_lower, rev(surv_obs$tp$gr_3$smooth_upper)), 
            col = adjustcolor("darkgrey", alpha.f = 0.3), border = NA)
  }
  legend("topleft", legend = c(misc$group_names, rep("", length(misc$group_names))), 
         col =  c(rep("5", misc$ngroups), c("black", "lightgrey", "darkgrey")[1:misc$ngroups]), 
         lty = c(as.integer(c(1, "2222", "5212")[1:misc$ngroups]), rep(NA, misc$ngroups)),
         pch = c(rep(NA, misc$ngroups), c(1, 8, 9)[1:misc$ngroups]),
         cex = 0.8, ncol = 2,
         bty = "n")
  
  # diagnostics
  plot(cbind(log(surv_obs$km$time), -log(surv_obs$km$surv/(1 - surv_obs$km$surv))), 
       cex = 0.6, pch = c(1, 8, 9)[surv_obs$km_names], 
       col = c("black", "lightgrey", "darkgrey")[surv_obs$km_names],
       xlim = c(floor(min(log(surv_obs$km$time)[surv_obs$km$surv != 1])), 
                ceiling(max(log(surv_obs$km$time)))), main = "C: Diagnostic plot (Log-logistic)", 
       xlab = "LN(time)", ylab = "-LN(survival odds)")
  lines(cbind(log(input$time_pred), 
              -log(surv_pred$model$llog[, 2]/(1 - surv_pred$model$llog[, 2]))),
        col = "5", lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(log(input$time_pred), 
                -log(surv_pred$model$llog[, 3]/(1 - surv_pred$model$llog[, 3]))), 
          col = "5", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(log(input$time_pred), 
                -log(surv_pred$model$llog[, 4]/(1 - surv_pred$model$llog[, 4]))),
          col = "5", lty = "5212", lwd = 2)
  }
  legend("topleft", legend = c(misc$group_names, rep("", length(misc$group_names))), 
         col =  c(rep("5", misc$ngroups), c("black", "lightgrey", "darkgrey")[1:misc$ngroups]), 
         lty = c(as.integer(c(1, "2222", "5212")[1:misc$ngroups]), rep(NA, misc$ngroups)),
         pch = c(rep(NA, misc$ngroups), c(1, 8, 9)[1:misc$ngroups]),
         cex = 0.8, ncol = 2,
         bty = "n")
  
}, envir = PERSUADE)
```

\newpage 

## Gamma
```{r gam, echo=FALSE, out.height = "25%", fig.width=11}
evalq({
  # hazard rate has (inverted) 'U' shape over time
  plot(surv_obs$km, lwd = 2, main = "A: Kaplan-Meier (Gamma)", xlab = "time", ylab = "survival", 
       col = c("black", "lightgrey", "darkgrey"))
  lines(cbind(input$time_pred, surv_pred$model$gam[, 2]), col = "6", lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(input$time_pred, surv_pred$model$gam[, 3]), col = "6", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(input$time_pred, surv_pred$model$gam[, 4]), col = "6", lty = "5212", lwd = 2)
  }
  # add shading confidence intervals
  polygon(na.omit(data.frame(c(surv_obs$km$time[surv_obs$km_names == 1], rev(surv_obs$km$time[surv_obs$km_names == 1])), 
                             c(surv_obs$km$lower[surv_obs$km_names == 1], rev(surv_obs$km$upper[surv_obs$km_names == 1])))), 
          col = adjustcolor("black", alpha.f = 0.3), border = NA)
  if (misc$ngroups > 1) {
    polygon(na.omit(data.frame(c(surv_obs$km$time[surv_obs$km_names == 2], rev(surv_obs$km$time[surv_obs$km_names == 2])),
                               c(surv_obs$km$lower[surv_obs$km_names == 2], rev(surv_obs$km$upper[surv_obs$km_names == 2])))),
            col = adjustcolor("lightgrey", alpha.f = 0.3), border = NA)
  }
  if (misc$ngroups > 2) {
    polygon(na.omit(data.frame(c(surv_obs$km$time[surv_obs$km_names == 3], rev(surv_obs$km$time[surv_obs$km_names == 3])),
                               c(surv_obs$km$lower[surv_obs$km_names == 3], rev(surv_obs$km$upper[surv_obs$km_names == 3])))), 
            col = adjustcolor("darkgrey", alpha.f = 0.3), border = NA)
  }
  legend("bottomleft", legend = c(misc$group_names, rep("", length(misc$group_names))), 
         col = c(rep("6", misc$ngroups), c("black", "lightgrey", "darkgrey")[1:misc$ngroups]), 
         lty = c(as.integer(c(1, "2222", "5212")[1:misc$ngroups]), rep(1, misc$ngroups)), 
         cex = 0.8, ncol = 2,
         bty = "n")
  
  # annual transition probabilities
  plot(cbind(surv_obs$tp$gr_1$time, surv_obs$tp$gr_1$smooth), lwd = 1, 
       lty = 1, type = "b", cex = 0.6, pch = 1, col = "black", 
       main = "B: Annual transition probability (Gamma)", 
       xlab = "time", ylab = "annual transition probability (smoothed)", 
       ylim = c(0, ceiling(surv_obs$tp$max * 10)/10), xlim = c(0, ceiling(surv_obs$km$maxtime * 10)/10))
  lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_1[, 7]), col = "6", lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(surv_obs$tp$gr_2$time, surv_obs$tp$gr_2$smooth), 
          col = "lightgrey", type = "b", lwd = 1, cex = 0.6, pch = 8)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_2[, 7]), col = "6", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(surv_obs$tp$gr_3$time, surv_obs$tp$gr_3$smooth), 
          col = "darkgrey", type = "b", lwd = 1, cex = 0.6, pch = 9)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_3[, 7]), col = "6", lty = "5212", lwd = 2)
  }
  # add shading confidence intervals
  polygon(c(surv_obs$tp$gr_1$time, rev(surv_obs$tp$gr_1$time)), 
          c(surv_obs$tp$gr_1$smooth_lower, rev(surv_obs$tp$gr_1$smooth_upper)), 
          col = adjustcolor("black", alpha.f = 0.3), border = NA)
  if (misc$ngroups > 1) {
    polygon(c(surv_obs$tp$gr_2$time, rev(surv_obs$tp$gr_2$time)), 
            c(surv_obs$tp$gr_2$smooth_lower, rev(surv_obs$tp$gr_2$smooth_upper)), 
            col = adjustcolor("lightgrey", alpha.f = 0.3), border = NA)
  }
  if (misc$ngroups > 2) {
    polygon(c(surv_obs$tp$gr_3$time, rev(surv_obs$tp$gr_3$time)), 
            c(surv_obs$tp$gr_3$smooth_lower, rev(surv_obs$tp$gr_3$smooth_upper)), 
            col = adjustcolor("darkgrey", alpha.f = 0.3), border = NA)
  }
  legend("topleft", legend = c(misc$group_names, rep("", length(misc$group_names))), 
         col =  c(rep("6", misc$ngroups), c("black", "lightgrey", "darkgrey")[1:misc$ngroups]), 
         lty = c(as.integer(c(1, "2222", "5212")[1:misc$ngroups]), rep(NA, misc$ngroups)),
         pch = c(rep(NA, misc$ngroups), c(1, 8, 9)[1:misc$ngroups]),
         cex = 0.8, ncol = 2,
         bty = "n")
  
  # diagnostics --> not linear!
  plot(cbind(log(surv_obs$km$time), log(-log(surv_obs$km$surv))), cex = 0.6, 
       pch = c(1, 8, 9)[surv_obs$km_names], 
       xlim = c(floor(min(log(surv_obs$km$time)[surv_obs$km$surv != 1])), 
                ceiling(max(log(surv_obs$km$time)))), 
       col = c("black", "lightgrey", "darkgrey")[surv_obs$km_names], 
       main = "C: Diagnostic plot (Gamma)", xlab = "LN(time)", ylab = "LN(cumulative hazard)")
  lines(cbind(log(input$time_pred), log(-log(surv_pred$model$gam[, 2]))), col = "6", lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(log(input$time_pred), log(-log(surv_pred$model$gam[, 3]))), col = "6", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(log(input$time_pred), log(-log(surv_pred$model$gam[, 4]))), col = "6", lty = "5212", lwd = 2)
  }
  legend("topleft", legend = c(misc$group_names, rep("", length(misc$group_names))), 
         col =  c(rep("6", misc$ngroups), c("black", "lightgrey", "darkgrey")[1:misc$ngroups]), 
         lty = c(as.integer(c(1, "2222", "5212")[1:misc$ngroups]), rep(NA, misc$ngroups)),
         pch = c(rep(NA, misc$ngroups), c(1, 8, 9)[1:misc$ngroups]),
         cex = 0.8, ncol = 2,
         bty = "n")
  
}, envir = PERSUADE)
```

\newpage 

## Generalised Gamma 
```{r ggam, echo=FALSE, out.height = "25%", fig.width=11}
evalq({
  # more flexible: can take form of Exponential, Weibull, Gamma or Log-normal
  plot(surv_obs$km, lwd = 2, main = "A: Kaplan-Meier (Generalised gamma)", xlab = "time", 
       ylab = "survival", col = c("black", "lightgrey", "darkgrey"))
  lines(cbind(input$time_pred, surv_pred$model$ggam[, 2]), col = "7", lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(input$time_pred, surv_pred$model$ggam[, 3]), col = "7", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(input$time_pred, surv_pred$model$ggam[, 4]), col = "7", lty = "5212", lwd = 2)
  }
  # add shading confidence intervals
  polygon(na.omit(data.frame(c(surv_obs$km$time[surv_obs$km_names == 1], rev(surv_obs$km$time[surv_obs$km_names == 1])),
                             c(surv_obs$km$lower[surv_obs$km_names == 1], rev(surv_obs$km$upper[surv_obs$km_names == 1])))), 
          col = adjustcolor("black", alpha.f = 0.3), border = NA)
  if (misc$ngroups > 1) {
    polygon(na.omit(data.frame(c(surv_obs$km$time[surv_obs$km_names == 2], rev(surv_obs$km$time[surv_obs$km_names == 2])),
                               c(surv_obs$km$lower[surv_obs$km_names == 2], rev(surv_obs$km$upper[surv_obs$km_names == 2])))), 
            col = adjustcolor("lightgrey", alpha.f = 0.3), border = NA)
  }
  if (misc$ngroups > 2) {
    polygon(na.omit(data.frame(c(surv_obs$km$time[surv_obs$km_names == 3], rev(surv_obs$km$time[surv_obs$km_names == 3])),
                               c(surv_obs$km$lower[surv_obs$km_names == 3], rev(surv_obs$km$upper[surv_obs$km_names == 3])))), 
            col = adjustcolor("darkgrey", alpha.f = 0.3), border = NA)
  }
  legend("bottomleft", legend = c(misc$group_names, rep("", length(misc$group_names))), 
         col = c(rep("7", misc$ngroups), c("black", "lightgrey", "darkgrey")[1:misc$ngroups]), 
         lty = c(as.integer(c(1, "2222", "5212")[1:misc$ngroups]), rep(1, misc$ngroups)), 
         cex = 0.8, ncol = 2,
         bty = "n")
  
  # annual transition probabilities
  plot(cbind(surv_obs$tp$gr_1$time, surv_obs$tp$gr_1$smooth), lwd = 1, 
       lty = 1, type = "b", cex = 0.6, pch = 1, col = "black", 
       main = "B: Annual transition probability (Generalised Gamma)", 
       xlab = "time", ylab = "annual transition probability (smoothed)", 
       ylim = c(0, ceiling(surv_obs$tp$max * 10)/10), xlim = c(0, ceiling(surv_obs$km$maxtime * 10)/10))
  lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_1[, 8]), col = "7", lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(surv_obs$tp$gr_2$time, surv_obs$tp$gr_2$smooth), 
          col = "lightgrey", type = "b", lwd = 1, cex = 0.6, pch = 8)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_2[, 8]), col = "7", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(surv_obs$tp$gr_3$time, surv_obs$tp$gr_3$smooth), 
          col = "darkgrey", type = "b", lwd = 1, cex = 0.6, pch = 9)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_3[, 8]), col = "7", lty = "5212", lwd = 2)
  }
  # add shading confidence intervals
  polygon(c(surv_obs$tp$gr_1$time, rev(surv_obs$tp$gr_1$time)), 
          c(surv_obs$tp$gr_1$smooth_lower, rev(surv_obs$tp$gr_1$smooth_upper)), 
          col = adjustcolor("black", alpha.f = 0.3), border = NA)
  if (misc$ngroups > 1) {
    polygon(c(surv_obs$tp$gr_2$time, rev(surv_obs$tp$gr_2$time)), 
            c(surv_obs$tp$gr_2$smooth_lower, rev(surv_obs$tp$gr_2$smooth_upper)), 
            col = adjustcolor("lightgrey", alpha.f = 0.3), border = NA)
  }
  if (misc$ngroups > 2) {
    polygon(c(surv_obs$tp$gr_3$time, rev(surv_obs$tp$gr_3$time)), 
            c(surv_obs$tp$gr_3$smooth_lower, rev(surv_obs$tp$gr_3$smooth_upper)), 
            col = adjustcolor("darkgrey", alpha.f = 0.3), border = NA)
  }
  legend("topleft", legend = c(misc$group_names, rep("", length(misc$group_names))), 
         col =  c(rep("7", misc$ngroups), c("black", "lightgrey", "darkgrey")[1:misc$ngroups]), 
         lty = c(as.integer(c(1, "2222", "5212")[1:misc$ngroups]), rep(NA, misc$ngroups)),
         pch = c(rep(NA, misc$ngroups), c(1, 8, 9)[1:misc$ngroups]),
         cex = 0.8, ncol = 2,
         bty = "n")
  
  # diagnostics --> not linear!
  plot(cbind(log(surv_obs$km$time), log(-log(surv_obs$km$surv))), cex = 0.6, 
       pch = c(1, 8, 9)[surv_obs$km_names], 
       xlim = c(floor(min(log(surv_obs$km$time)[surv_obs$km$surv != 1])), 
                ceiling(max(log(surv_obs$km$time)))), 
       col = c("black", "lightgrey", "darkgrey")[surv_obs$km_names], 
       main = "C: Diagnostic plot (Generalised gamma)", 
       xlab = "LN(time)", ylab = "LN(cumulative hazard)")
  lines(cbind(log(input$time_pred), log(-log(surv_pred$model$ggam[, 2]))), col = "7", lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(log(input$time_pred), log(-log(surv_pred$model$ggam[, 3]))), col = "7", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(log(input$time_pred), log(-log(surv_pred$model$ggam[, 4]))), col = "7", lty = "5212", lwd = 2)
  }
  legend("topleft", legend = c(misc$group_names, rep("", length(misc$group_names))), 
         col =  c(rep("7", misc$ngroups), c("black", "lightgrey", "darkgrey")[1:misc$ngroups]), 
         lty = c(as.integer(c(1, "2222", "5212")[1:misc$ngroups]), rep(NA, misc$ngroups)),
         pch = c(rep(NA, misc$ngroups), c(1, 8, 9)[1:misc$ngroups]),
         cex = 0.8, ncol = 2,
         bty = "n")
  
}, envir = PERSUADE)
```

\newpage

# Parametric natural cubic spline models
If standard parametric models do not provide a satisfactory fit to the data based on previous observations, do spline-based models provide a more satisfactory fit to the data? An explanation concerning these natural cubic spline models, henceforth spline-based models, is provided in [Royston and Pamar - 2002](https://doi.org/10.1002/sim.1203).  

Similar plots are provided as provided (and explained) in the previous section. As highlighted above, spline-based models using the hazard scale, odds scale and normal scale are extensions of the standard parametric survival models using the Weibull, log-logistic and log-normal distribution respectively. 

**CAUTION**: These goodness-of-fit statistics only apply to the observed data period and do not allow to issue statements about the suitability of the extrapolated survival by these fitted models beyond this period. Additionally, the end of the observed data period may be affected by the low number of observations. One should consider this when interpreting the tail of the curves.  

```{r spline, echo=FALSE, eval = PERSUADE$input$spline_mod}
evalq({
  # k=0 gives a Weibull, log-logistic or log-normal model, if 'scale' is 'hazard',
  # 'odds' or 'normal' respectively. The knots are then chosen as equally-spaced
  # quantiles of the log uncensored survival times, for example, at the median with
  # one knot, or at the 33% and 67% quantiles of log time (or time, see
  # 'timescale') with two knots.
  
  pie(rep(1, n), labels = misc$lbls_spline, 
      col = rainbow(n = n, s = 1, v = 1, start = 0, end = max(1, n - 1)/n, alpha = 1))
  
  kable_styling(kable(rbind(surv_model$IC, 
                            surv_model$IC_spl)[order(rbind(surv_model$IC, surv_model$IC_spl)$AIC), ], 
                      format = "latex", row.names = FALSE, booktabs = TRUE, 
                      linesep = ""), latex_options = "striped")
}, envir = PERSUADE)
```

`r if(PERSUADE$input$spline_mod == TRUE) {return("\\newpage")}`

## Spline 1 knot hazard
```{r spline_hazard1, echo=FALSE, out.height = "25%", fig.width=11, eval = PERSUADE$input$spline_mod}
evalq({
  # 1 knot
  plot(surv_obs$km, lwd = 2, main = "A: Kaplan-Meier (Spline, 1 knot, hazard scale)", 
       xlab = "time", ylab = "survival", col = c("black", "lightgrey", "darkgrey"))
  lines(cbind(input$time_pred, surv_pred$model$spl_hazard1[, 2]), col = "1", lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(input$time_pred, surv_pred$model$spl_hazard1[, 3]), col = "1", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(input$time_pred, surv_pred$model$spl_hazard1[, 4]), col = "1", lty = "5212", lwd = 2)
  }
  # add shading confidence intervals
  polygon(na.omit(data.frame(c(surv_obs$km$time[surv_obs$km_names == 1], rev(surv_obs$km$time[surv_obs$km_names == 1])),
                             c(surv_obs$km$lower[surv_obs$km_names == 1], rev(surv_obs$km$upper[surv_obs$km_names == 1])))), 
          col = adjustcolor("black", alpha.f = 0.3), border = NA)
  if (misc$ngroups > 1) {
    polygon(na.omit(data.frame(c(surv_obs$km$time[surv_obs$km_names == 2], rev(surv_obs$km$time[surv_obs$km_names == 2])),
                               c(surv_obs$km$lower[surv_obs$km_names == 2], rev(surv_obs$km$upper[surv_obs$km_names == 2])))), 
            col = adjustcolor("lightgrey", alpha.f = 0.3), border = NA)
  }
  if (misc$ngroups > 2) {
    polygon(na.omit(data.frame(c(surv_obs$km$time[surv_obs$km_names == 3], rev(surv_obs$km$time[surv_obs$km_names == 3])),
                               c(surv_obs$km$lower[surv_obs$km_names == 3], rev(surv_obs$km$upper[surv_obs$km_names == 3])))), 
            col = adjustcolor("darkgrey", alpha.f = 0.3), border = NA)
  }
  abline(v = exp(surv_model$spl_hazard1$knots[2]), lty = 2, lwd = 1.5)
  abline(v = exp(surv_model$spl_hazard1$knots[1]), lty = 3, lwd = 1)
  abline(v = exp(surv_model$spl_hazard1$knots[3]), lty = 3, lwd = 1)
  legend("bottomleft", legend = c(misc$group_names, rep("", length(misc$group_names))), 
         col = c(rep("1", misc$ngroups), c("black", "lightgrey", "darkgrey")[1:misc$ngroups]), 
         lty = c(as.integer(c(1, "2222", "5212")[1:misc$ngroups]), rep(1, misc$ngroups)), 
         cex = 0.8, ncol = 2,
         bty = "n")
  
  # annual transition probabilities
  plot(cbind(surv_obs$tp$gr_1$time, surv_obs$tp$gr_1$smooth), lwd = 1, 
       lty = 1, type = "b", cex = 0.6, pch = 1, col = "black", 
       main = "B: Annual transition probability (Spline, 1 knot, hazard scale)", 
       xlab = "time", ylab = "annual transition probability (smoothed)", 
       ylim = c(0, ceiling(surv_obs$tp$max * 10)/10), xlim = c(0, ceiling(surv_obs$km$maxtime * 10)/10))
  lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_1[, 9]), col = "1", lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(surv_obs$tp$gr_2$time, surv_obs$tp$gr_2$smooth), 
          col = "lightgrey", type = "b", lwd = 1, cex = 0.6, pch = 8)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_2[, 9]), col = "1", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(surv_obs$tp$gr_3$time, surv_obs$tp$gr_3$smooth), 
          col = "darkgrey", type = "b", lwd = 1, cex = 0.6, pch = 9)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_3[, 9]), col = "1", lty = "5212", lwd = 2)
  }
  # add shading confidence intervals
  polygon(c(surv_obs$tp$gr_1$time, rev(surv_obs$tp$gr_1$time)), 
          c(surv_obs$tp$gr_1$smooth_lower, rev(surv_obs$tp$gr_1$smooth_upper)), 
          col = adjustcolor("black", alpha.f = 0.3), border = NA)
  if (misc$ngroups > 1) {
    polygon(c(surv_obs$tp$gr_2$time, rev(surv_obs$tp$gr_2$time)), 
            c(surv_obs$tp$gr_2$smooth_lower, rev(surv_obs$tp$gr_2$smooth_upper)), 
            col = adjustcolor("lightgrey", alpha.f = 0.3), border = NA)
  }
  if (misc$ngroups > 2) {
    polygon(c(surv_obs$tp$gr_3$time, rev(surv_obs$tp$gr_3$time)), 
            c(surv_obs$tp$gr_3$smooth_lower, rev(surv_obs$tp$gr_3$smooth_upper)), 
            col = adjustcolor("darkgrey", alpha.f = 0.3), border = NA)
  }
  abline(v = exp(surv_model$spl_hazard1$knots[2]), lty = 2, lwd = 1.5)
  abline(v = exp(surv_model$spl_hazard1$knots[1]), lty = 3, lwd = 1)
  abline(v = exp(surv_model$spl_hazard1$knots[3]), lty = 3, lwd = 1)
  legend("topleft", legend = c(misc$group_names, rep("", length(misc$group_names))), 
         col =  c(rep("1", misc$ngroups), c("black", "lightgrey", "darkgrey")[1:misc$ngroups]), 
         lty = c(as.integer(c(1, "2222", "5212")[1:misc$ngroups]), rep(NA, misc$ngroups)),
         pch = c(rep(NA, misc$ngroups), c(1, 8, 9)[1:misc$ngroups]),
         cex = 0.8, ncol = 2,
         bty = "n")
  
  # diagnostics
  plot(cbind(log(surv_obs$km$time), log(-log(surv_obs$km$surv))), cex = 0.6, 
       pch = c(1, 8, 9)[surv_obs$km_names], 
       xlim = c(floor(min(log(surv_obs$km$time)[surv_obs$km$surv != 1])), 
                ceiling(max(log(surv_obs$km$time)))), 
       col = c("black", "lightgrey", "darkgrey")[surv_obs$km_names], 
       main = "C: Diagnostic plot (Spline, 1 knot, hazard scale)", 
       xlab = "LN(time)", ylab = "LN(cumulative hazard)")
  lines(cbind(log(input$time_pred), log(-log(surv_pred$model$spl_hazard1[, 2]))), 
        col = "1", lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(log(input$time_pred), log(-log(surv_pred$model$spl_hazard1[, 3]))), 
          col = "1", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(log(input$time_pred), log(-log(surv_pred$model$spl_hazard1[, 4]))), 
          col = "1", lty = "5212", lwd = 2)
  }
  abline(v = surv_model$spl_hazard1$knots[2], lty = 2, lwd = 1.5)
  abline(v = surv_model$spl_hazard1$knots[1], lty = 3, lwd = 1)
  abline(v = surv_model$spl_hazard1$knots[3], lty = 3, lwd = 1)
  legend("topleft", legend = c(misc$group_names, rep("", length(misc$group_names))), 
         col =  c(rep("1", misc$ngroups), c("black", "lightgrey", "darkgrey")[1:misc$ngroups]), 
         lty = c(as.integer(c(1, "2222", "5212")[1:misc$ngroups]), rep(NA, misc$ngroups)),
         pch = c(rep(NA, misc$ngroups), c(1, 8, 9)[1:misc$ngroups]),
         cex = 0.8, ncol = 2,
         bty = "n")
  
}, envir = PERSUADE)
```

`r if(PERSUADE$input$spline_mod == TRUE) {return("\\newpage")}`

## Spline 2 knots hazard
```{r spline_hazard2, echo=FALSE, out.height = "25%", fig.width=11, eval = PERSUADE$input$spline_mod}
evalq({
  # 2 knots
  plot(surv_obs$km, lwd = 2, main = "A: Kaplan-Meier (Spline, 2 knots, hazard scale)", 
       xlab = "time", ylab = "survival", col = c("black", "lightgrey", "darkgrey"))
  lines(cbind(input$time_pred, surv_pred$model$spl_hazard2[, 2]), col = "2", lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(input$time_pred, surv_pred$model$spl_hazard2[, 3]), col = "2", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(input$time_pred, surv_pred$model$spl_hazard2[, 4]), col = "2", lty = "5212", lwd = 2)
  }
  # add shading confidence intervals
  polygon(na.omit(data.frame(c(surv_obs$km$time[surv_obs$km_names == 1], rev(surv_obs$km$time[surv_obs$km_names == 1])),
                             c(surv_obs$km$lower[surv_obs$km_names == 1], rev(surv_obs$km$upper[surv_obs$km_names == 1])))), 
          col = adjustcolor("black", alpha.f = 0.3), border = NA)
  if (misc$ngroups > 1) {
    polygon(na.omit(data.frame(c(surv_obs$km$time[surv_obs$km_names == 2], rev(surv_obs$km$time[surv_obs$km_names == 2])),
                               c(surv_obs$km$lower[surv_obs$km_names == 2], rev(surv_obs$km$upper[surv_obs$km_names == 2])))), 
            col = adjustcolor("lightgrey", alpha.f = 0.3), border = NA)
  }
  if (misc$ngroups > 2) {
    polygon(na.omit(data.frame(c(surv_obs$km$time[surv_obs$km_names == 3], rev(surv_obs$km$time[surv_obs$km_names == 3])),
                               c(surv_obs$km$lower[surv_obs$km_names == 3], rev(surv_obs$km$upper[surv_obs$km_names == 3])))),
            col = adjustcolor("darkgrey", alpha.f = 0.3), border = NA)
  }
  abline(v = exp(surv_model$spl_hazard2$knots[2]), lty = 2, lwd = 1.5)
  abline(v = exp(surv_model$spl_hazard2$knots[3]), lty = 2, lwd = 1.5)
  abline(v = exp(surv_model$spl_hazard2$knots[1]), lty = 3, lwd = 1)
  abline(v = exp(surv_model$spl_hazard2$knots[4]), lty = 3, lwd = 1)
  legend("bottomleft", legend = c(misc$group_names, rep("", length(misc$group_names))), 
         col = c(rep("2", misc$ngroups), c("black", "lightgrey", "darkgrey")[1:misc$ngroups]), 
         lty = c(as.integer(c(1, "2222", "5212")[1:misc$ngroups]), rep(1, misc$ngroups)), 
         cex = 0.8, ncol = 2,
         bty = "n")
  
  # annual transition probabilities
  plot(cbind(surv_obs$tp$gr_1$time, surv_obs$tp$gr_1$smooth), lwd = 1, 
       lty = 1, type = "b", cex = 0.6, pch = 1, col = "black", 
       main = "B: Annual transition probability (Spline, 2 knots, hazard scale)", 
       xlab = "time", ylab = "annual transition probability (smoothed)", 
       ylim = c(0, ceiling(surv_obs$tp$max * 10)/10), xlim = c(0, ceiling(surv_obs$km$maxtime * 10)/10))
  lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_1[, 10]), col = "2", lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(surv_obs$tp$gr_2$time, surv_obs$tp$gr_2$smooth), 
          col = "lightgrey", type = "b", lwd = 1, cex = 0.6, pch = 8)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_2[, 10]), col = "2", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(surv_obs$tp$gr_3$time, surv_obs$tp$gr_3$smooth), 
          col = "darkgrey", type = "b", lwd = 1, cex = 0.6, pch = 9)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_3[, 10]), col = "2", lty = "5212", lwd = 2)
  }
  # add shading confidence intervals
  polygon(c(surv_obs$tp$gr_1$time, rev(surv_obs$tp$gr_1$time)), 
          c(surv_obs$tp$gr_1$smooth_lower, rev(surv_obs$tp$gr_1$smooth_upper)), 
          col = adjustcolor("black", alpha.f = 0.3), border = NA)
  if (misc$ngroups > 1) {
    polygon(c(surv_obs$tp$gr_2$time, rev(surv_obs$tp$gr_2$time)), 
            c(surv_obs$tp$gr_2$smooth_lower, rev(surv_obs$tp$gr_2$smooth_upper)), 
            col = adjustcolor("lightgrey", alpha.f = 0.3), border = NA)
  }
  if (misc$ngroups > 2) {
    polygon(c(surv_obs$tp$gr_3$time, rev(surv_obs$tp$gr_3$time)), 
            c(surv_obs$tp$gr_3$smooth_lower, rev(surv_obs$tp$gr_3$smooth_upper)), 
            col = adjustcolor("darkgrey", alpha.f = 0.3), border = NA)
  }
  abline(v = exp(surv_model$spl_hazard2$knots[2]), lty = 2, lwd = 1.5)
  abline(v = exp(surv_model$spl_hazard2$knots[3]), lty = 2, lwd = 1.5)
  abline(v = exp(surv_model$spl_hazard2$knots[1]), lty = 3, lwd = 1)
  abline(v = exp(surv_model$spl_hazard2$knots[4]), lty = 3, lwd = 1)
  legend("topleft", legend = c(misc$group_names, rep("", length(misc$group_names))), 
         col =  c(rep("2", misc$ngroups), c("black", "lightgrey", "darkgrey")[1:misc$ngroups]), 
         lty = c(as.integer(c(1, "2222", "5212")[1:misc$ngroups]), rep(NA, misc$ngroups)),
         pch = c(rep(NA, misc$ngroups), c(1, 8, 9)[1:misc$ngroups]),
         cex = 0.8, ncol = 2,
         bty = "n")
  
  # diagnostics
  plot(cbind(log(surv_obs$km$time), log(-log(surv_obs$km$surv))), cex = 0.6, 
       pch = c(1, 8, 9)[surv_obs$km_names], 
       xlim = c(floor(min(log(surv_obs$km$time)[surv_obs$km$surv != 1])), 
                ceiling(max(log(surv_obs$km$time)))), 
       col = c("black", "lightgrey", "darkgrey")[surv_obs$km_names], 
       main = "C: Diagnostic plot (Spline, 2 knots, hazard scale)", 
       xlab = "LN(time)", ylab = "LN(cumulative hazard)")
  lines(cbind(log(input$time_pred), log(-log(surv_pred$model$spl_hazard2[, 2]))), 
        col = "2", lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(log(input$time_pred), log(-log(surv_pred$model$spl_hazard2[, 3]))), 
          col = "2", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(log(input$time_pred), log(-log(surv_pred$model$spl_hazard2[, 4]))), 
          col = "2", lty = "5212", lwd = 2)
  }
  abline(v = surv_model$spl_hazard2$knots[2], lty = 2, lwd = 1.5)
  abline(v = surv_model$spl_hazard2$knots[3], lty = 2, lwd = 1.5)
  abline(v = surv_model$spl_hazard2$knots[1], lty = 3, lwd = 1)
  abline(v = surv_model$spl_hazard2$knots[4], lty = 3, lwd = 1)
  legend("topleft", legend = c(misc$group_names, rep("", length(misc$group_names))), 
         col =  c(rep("2", misc$ngroups), c("black", "lightgrey", "darkgrey")[1:misc$ngroups]), 
         lty = c(as.integer(c(1, "2222", "5212")[1:misc$ngroups]), rep(NA, misc$ngroups)),
         pch = c(rep(NA, misc$ngroups), c(1, 8, 9)[1:misc$ngroups]),
         cex = 0.8, ncol = 2,
         bty = "n")
  
}, envir = PERSUADE)
```

`r if(PERSUADE$input$spline_mod == TRUE) {return("\\newpage")}`

## Spline 3 knots hazard 
```{r spline_hazard3, echo=FALSE, out.height = "25%", fig.width=11, eval = PERSUADE$input$spline_mod}
evalq({
  # 2 knots
  plot(surv_obs$km, lwd = 2, main = "A: Kaplan-Meier (Spline, 3 knots, hazard scale)", 
       xlab = "time", ylab = "survival", col = c("black", "lightgrey", "darkgrey"))
  lines(cbind(input$time_pred, surv_pred$model$spl_hazard3[, 2]), col = "3", lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(input$time_pred, surv_pred$model$spl_hazard3[, 3]), col = "3", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(input$time_pred, surv_pred$model$spl_hazard3[, 4]), col = "3", lty = "5212", lwd = 2)
  }
  # add shading confidence intervals
  polygon(na.omit(data.frame(c(surv_obs$km$time[surv_obs$km_names == 1], rev(surv_obs$km$time[surv_obs$km_names == 1])),
                             c(surv_obs$km$lower[surv_obs$km_names == 1], rev(surv_obs$km$upper[surv_obs$km_names == 1])))), 
          col = adjustcolor("black", alpha.f = 0.3), border = NA)
  if (misc$ngroups > 1) {
    polygon(na.omit(data.frame(c(surv_obs$km$time[surv_obs$km_names == 2], rev(surv_obs$km$time[surv_obs$km_names == 2])),
                               c(surv_obs$km$lower[surv_obs$km_names == 2], rev(surv_obs$km$upper[surv_obs$km_names == 2])))), 
            col = adjustcolor("lightgrey", alpha.f = 0.3), border = NA)
  }
  if (misc$ngroups > 2) {
    polygon(na.omit(data.frame(c(surv_obs$km$time[surv_obs$km_names == 3], rev(surv_obs$km$time[surv_obs$km_names == 3])),
                               c(surv_obs$km$lower[surv_obs$km_names == 3], rev(surv_obs$km$upper[surv_obs$km_names == 3])))),
            col = adjustcolor("darkgrey", alpha.f = 0.3), border = NA)
  }
  abline(v = exp(surv_model$spl_hazard3$knots[2]), lty = 2, lwd = 1.5)
  abline(v = exp(surv_model$spl_hazard3$knots[3]), lty = 2, lwd = 1.5)
  abline(v = exp(surv_model$spl_hazard3$knots[4]), lty = 2, lwd = 1.5)
  abline(v = exp(surv_model$spl_hazard3$knots[1]), lty = 3, lwd = 1)
  abline(v = exp(surv_model$spl_hazard3$knots[5]), lty = 3, lwd = 1)
  legend("bottomleft", legend = c(misc$group_names, rep("", length(misc$group_names))), 
         col = c(rep("3", misc$ngroups), c("black", "lightgrey", "darkgrey")[1:misc$ngroups]), 
         lty = c(as.integer(c(1, "2222", "5212")[1:misc$ngroups]), rep(1, misc$ngroups)), 
         cex = 0.8, ncol = 2,
         bty = "n")
  
  # annual transition probabilities
  plot(cbind(surv_obs$tp$gr_1$time, surv_obs$tp$gr_1$smooth), lwd = 1, 
       lty = 1, type = "b", cex = 0.6, pch = 1, col = "black", 
       main = "B: Annual transition probability (Spline, 3 knots, hazard scale)", 
       xlab = "time", ylab = "annual transition probability (smoothed)", 
       ylim = c(0, ceiling(surv_obs$tp$max * 10)/10), xlim = c(0, ceiling(surv_obs$km$maxtime * 10)/10))
  lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_1[, 11]), col = "3", lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(surv_obs$tp$gr_2$time, surv_obs$tp$gr_2$smooth), 
          col = "lightgrey", type = "b", lwd = 1, cex = 0.6, pch = 8)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_2[, 11]), col = "3", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(surv_obs$tp$gr_3$time, surv_obs$tp$gr_3$smooth), 
          col = "darkgrey", type = "b", lwd = 1, cex = 0.6, pch = 9)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_3[, 11]), col = "3", lty = "5212", lwd = 2)
  }
  # add shading confidence intervals
  polygon(c(surv_obs$tp$gr_1$time, rev(surv_obs$tp$gr_1$time)), 
          c(surv_obs$tp$gr_1$smooth_lower, rev(surv_obs$tp$gr_1$smooth_upper)), 
          col = adjustcolor("black", alpha.f = 0.3), border = NA)
  if (misc$ngroups > 1) {
    polygon(c(surv_obs$tp$gr_2$time, rev(surv_obs$tp$gr_2$time)), 
            c(surv_obs$tp$gr_2$smooth_lower, rev(surv_obs$tp$gr_2$smooth_upper)), 
            col = adjustcolor("lightgrey", alpha.f = 0.3), border = NA)
  }
  if (misc$ngroups > 2) {
    polygon(c(surv_obs$tp$gr_3$time, rev(surv_obs$tp$gr_3$time)), 
            c(surv_obs$tp$gr_3$smooth_lower, rev(surv_obs$tp$gr_3$smooth_upper)), 
            col = adjustcolor("darkgrey", alpha.f = 0.3), border = NA)
  }
  abline(v = exp(surv_model$spl_hazard3$knots[2]), lty = 2, lwd = 1.5)
  abline(v = exp(surv_model$spl_hazard3$knots[3]), lty = 2, lwd = 1.5)
  abline(v = exp(surv_model$spl_hazard3$knots[4]), lty = 2, lwd = 1.5)
  abline(v = exp(surv_model$spl_hazard3$knots[1]), lty = 3, lwd = 1)
  abline(v = exp(surv_model$spl_hazard3$knots[5]), lty = 3, lwd = 1)
  legend("topleft", legend = c(misc$group_names, rep("", length(misc$group_names))), 
         col =  c(rep("3", misc$ngroups), c("black", "lightgrey", "darkgrey")[1:misc$ngroups]), 
         lty = c(as.integer(c(1, "2222", "5212")[1:misc$ngroups]), rep(NA, misc$ngroups)),
         pch = c(rep(NA, misc$ngroups), c(1, 8, 9)[1:misc$ngroups]),
         cex = 0.8, ncol = 2,
         bty = "n")
  
  # diagnostics
  plot(cbind(log(surv_obs$km$time), log(-log(surv_obs$km$surv))), cex = 0.6, 
       pch = c(1, 8, 9)[surv_obs$km_names], 
       xlim = c(floor(min(log(surv_obs$km$time)[surv_obs$km$surv != 1])), 
                ceiling(max(log(surv_obs$km$time)))), 
       col = c("black", "lightgrey", "darkgrey")[surv_obs$km_names], 
       main = "C: Diagnostic plot (Spline, 3 knots, hazard scale)", 
       xlab = "LN(time)", ylab = "LN(cumulative hazard)")
  lines(cbind(log(input$time_pred), log(-log(surv_pred$model$spl_hazard3[, 2]))), 
        col = "3", lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(log(input$time_pred), log(-log(surv_pred$model$spl_hazard3[, 3]))), 
          col = "3", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(log(input$time_pred), log(-log(surv_pred$model$spl_hazard3[, 4]))), 
          col = "3", lty = "5212", lwd = 2)
  }
  abline(v = surv_model$spl_hazard3$knots[2], lty = 2, lwd = 1.5)
  abline(v = surv_model$spl_hazard3$knots[3], lty = 2, lwd = 1.5)
  abline(v = surv_model$spl_hazard3$knots[4], lty = 2, lwd = 1.5)
  abline(v = surv_model$spl_hazard3$knots[1], lty = 3, lwd = 1)
  abline(v = surv_model$spl_hazard3$knots[5], lty = 3, lwd = 1)
  legend("topleft", legend = c(misc$group_names, rep("", length(misc$group_names))), 
         col =  c(rep("3", misc$ngroups), c("black", "lightgrey", "darkgrey")[1:misc$ngroups]), 
         lty = c(as.integer(c(1, "2222", "5212")[1:misc$ngroups]), rep(NA, misc$ngroups)),
         pch = c(rep(NA, misc$ngroups), c(1, 8, 9)[1:misc$ngroups]),
         cex = 0.8, ncol = 2,
         bty = "n")
  
}, envir = PERSUADE)
```

`r if(PERSUADE$input$spline_mod == TRUE) {return("\\newpage")}`

## Spline 1 knot odds 
```{r spline_odds1, echo=FALSE, out.height = "25%", fig.width=11, eval = PERSUADE$input$spline_mod}
evalq({
  # 1 knot
  plot(surv_obs$km, lwd = 2, main = "A: Kaplan-Meier (Spline, 1 knot, odds scale)", 
       xlab = "time", ylab = "survival", col = c("black", "lightgrey", "darkgrey"))
  lines(cbind(input$time_pred, surv_pred$model$spl_odds1[, 2]), col = "4", lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(input$time_pred, surv_pred$model$spl_odds1[, 3]), col = "4", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(input$time_pred, surv_pred$model$spl_odds1[, 4]), col = "4", lty = "5212", lwd = 2)
  }
  # add shading confidence intervals
  polygon(na.omit(data.frame(c(surv_obs$km$time[surv_obs$km_names == 1], rev(surv_obs$km$time[surv_obs$km_names == 1])),
                             c(surv_obs$km$lower[surv_obs$km_names == 1], rev(surv_obs$km$upper[surv_obs$km_names == 1])))), 
          col = adjustcolor("black", alpha.f = 0.3), border = NA)
  if (misc$ngroups > 1) {
    polygon(na.omit(data.frame(c(surv_obs$km$time[surv_obs$km_names == 2], rev(surv_obs$km$time[surv_obs$km_names == 2])),
                               c(surv_obs$km$lower[surv_obs$km_names == 2], rev(surv_obs$km$upper[surv_obs$km_names == 2])))), 
            col = adjustcolor("lightgrey", alpha.f = 0.3), border = NA)
  }
  if (misc$ngroups > 2) {
    polygon(na.omit(data.frame(c(surv_obs$km$time[surv_obs$km_names == 3], rev(surv_obs$km$time[surv_obs$km_names == 3])),
                               c(surv_obs$km$lower[surv_obs$km_names == 3], rev(surv_obs$km$upper[surv_obs$km_names == 3])))), 
            col = adjustcolor("darkgrey", alpha.f = 0.3), border = NA)
  }
  abline(v = exp(surv_model$spl_odds1$knots[2]), lty = 2, lwd = 1.5)
  abline(v = exp(surv_model$spl_odds1$knots[1]), lty = 3, lwd = 1)
  abline(v = exp(surv_model$spl_odds1$knots[3]), lty = 3, lwd = 1)
  legend("bottomleft", legend = c(misc$group_names, rep("", length(misc$group_names))), 
         col = c(rep("4", misc$ngroups), c("black", "lightgrey", "darkgrey")[1:misc$ngroups]), 
         lty = c(as.integer(c(1, "2222", "5212")[1:misc$ngroups]), rep(1, misc$ngroups)), 
         cex = 0.8, ncol = 2,
         bty = "n")
  
  # annual transition probabilities
  plot(cbind(surv_obs$tp$gr_1$time, surv_obs$tp$gr_1$smooth), lwd = 1, 
       lty = 1, type = "b", cex = 0.6, pch = 1, col = "black",
       main = "B: Annual transition probability (Spline, 1 knot, odds scale)", 
       xlab = "time", ylab = "annual transition probability (smoothed)", 
       ylim = c(0, ceiling(surv_obs$tp$max * 10)/10), xlim = c(0, ceiling(surv_obs$km$maxtime * 10)/10))
  lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_1[, 12]), col = "4", lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(surv_obs$tp$gr_2$time, surv_obs$tp$gr_2$smooth), 
          col = "lightgrey", type = "b", lwd = 1, cex = 0.6, pch = 8)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_2[, 12]), col = "4", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(surv_obs$tp$gr_3$time, surv_obs$tp$gr_3$smooth), 
          col = "darkgrey", type = "b", lwd = 1, cex = 0.6, pch = 9)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_3[, 12]), col = "4", lty = "5212", lwd = 2)
  }
  # add shading confidence intervals
  polygon(c(surv_obs$tp$gr_1$time, rev(surv_obs$tp$gr_1$time)), 
          c(surv_obs$tp$gr_1$smooth_lower, rev(surv_obs$tp$gr_1$smooth_upper)), 
          col = adjustcolor("black", alpha.f = 0.3), border = NA)
  if (misc$ngroups > 1) {
    polygon(c(surv_obs$tp$gr_2$time, rev(surv_obs$tp$gr_2$time)), 
            c(surv_obs$tp$gr_2$smooth_lower, rev(surv_obs$tp$gr_2$smooth_upper)), 
            col = adjustcolor("lightgrey", alpha.f = 0.3), border = NA)
  }
  if (misc$ngroups > 2) {
    polygon(c(surv_obs$tp$gr_3$time, rev(surv_obs$tp$gr_3$time)), 
            c(surv_obs$tp$gr_3$smooth_lower, rev(surv_obs$tp$gr_3$smooth_upper)), 
            col = adjustcolor("darkgrey", alpha.f = 0.3), border = NA)
  }
  abline(v = exp(surv_model$spl_odds1$knots[2]), lty = 2, lwd = 1.5)
  abline(v = exp(surv_model$spl_odds1$knots[1]), lty = 3, lwd = 1)
  abline(v = exp(surv_model$spl_odds1$knots[3]), lty = 3, lwd = 1)
  legend("topleft", legend = c(misc$group_names, rep("", length(misc$group_names))), 
         col =  c(rep("4", misc$ngroups), c("black", "lightgrey", "darkgrey")[1:misc$ngroups]), 
         lty = c(as.integer(c(1, "2222", "5212")[1:misc$ngroups]), rep(NA, misc$ngroups)),
         pch = c(rep(NA, misc$ngroups), c(1, 8, 9)[1:misc$ngroups]),
         cex = 0.8, ncol = 2,
         bty = "n")
  
  # diagnostics
  plot(cbind(log(surv_obs$km$time), -log(surv_obs$km$surv/(1 - surv_obs$km$surv))), 
       cex = 0.6, pch = c(1, 8, 9)[surv_obs$km_names], 
       col = c("black", "lightgrey", "darkgrey")[surv_obs$km_names], 
       main = "C: Diagnostic plot (Spline, 1 knot, odds scale)", 
       xlim = c(floor(min(log(surv_obs$km$time)[surv_obs$km$surv != 1])), ceiling(max(log(surv_obs$km$time)))), 
       xlab = "LN(time)", ylab = "-LN(survival odds)")
  lines(cbind(log(input$time_pred), 
              -log(surv_pred$model$spl_odds1[, 2]/(1 - surv_pred$model$spl_odds1[, 2]))), 
        col = "4", lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(log(input$time_pred), 
                -log(surv_pred$model$spl_odds1[, 3]/(1 - surv_pred$model$spl_odds1[, 3]))),
          col = "4", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(log(input$time_pred), 
                -log(surv_pred$model$spl_odds1[, 4]/(1 - surv_pred$model$spl_odds1[, 4]))), 
          col = "4", lty = "5212", lwd = 2)
  }
  abline(v = surv_model$spl_odds1$knots[2], lty = 2, lwd = 1.5)
  abline(v = surv_model$spl_odds1$knots[1], lty = 3, lwd = 1)
  abline(v = surv_model$spl_odds1$knots[3], lty = 3, lwd = 1)
  legend("topleft", legend = c(misc$group_names, rep("", length(misc$group_names))), 
         col =  c(rep("4", misc$ngroups), c("black", "lightgrey", "darkgrey")[1:misc$ngroups]), 
         lty = c(as.integer(c(1, "2222", "5212")[1:misc$ngroups]), rep(NA, misc$ngroups)),
         pch = c(rep(NA, misc$ngroups), c(1, 8, 9)[1:misc$ngroups]),
         cex = 0.8, ncol = 2,
         bty = "n")
  
}, envir = PERSUADE)
```

`r if(PERSUADE$input$spline_mod == TRUE) {return("\\newpage")}`

## Spline 2 knots odds 
```{r spline_odds2, echo=FALSE, out.height = "25%", fig.width=11, eval = PERSUADE$input$spline_mod}
evalq({
  # 2 knots
  plot(surv_obs$km, lwd = 2, main = "A: Kaplan-Meier (Spline, 2 knots, odds scale)", 
       xlab = "time", ylab = "survival", col = c("black", "lightgrey", "darkgrey"))
  lines(cbind(input$time_pred, surv_pred$model$spl_odds2[, 2]), col = "5", lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(input$time_pred, surv_pred$model$spl_odds2[, 3]), col = "5", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(input$time_pred, surv_pred$model$spl_odds2[, 4]), col = "5", lty = "5212", lwd = 2)
  }
  # add shading confidence intervals
  polygon(na.omit(data.frame(c(surv_obs$km$time[surv_obs$km_names == 1], rev(surv_obs$km$time[surv_obs$km_names == 1])),
                             c(surv_obs$km$lower[surv_obs$km_names == 1], rev(surv_obs$km$upper[surv_obs$km_names == 1])))), 
          col = adjustcolor("black", alpha.f = 0.3), border = NA)
  if (misc$ngroups > 1) {
    polygon(na.omit(data.frame(c(surv_obs$km$time[surv_obs$km_names == 2], rev(surv_obs$km$time[surv_obs$km_names == 2])),
                               c(surv_obs$km$lower[surv_obs$km_names == 2], rev(surv_obs$km$upper[surv_obs$km_names == 2])))),
            col = adjustcolor("lightgrey", alpha.f = 0.3), border = NA)
  }
  if (misc$ngroups > 2) {
    polygon(na.omit(data.frame(c(surv_obs$km$time[surv_obs$km_names == 3], rev(surv_obs$km$time[surv_obs$km_names == 3])),
                               c(surv_obs$km$lower[surv_obs$km_names == 3], rev(surv_obs$km$upper[surv_obs$km_names == 3])))), 
            col = adjustcolor("darkgrey", alpha.f = 0.3), border = NA)
  }
  abline(v = exp(surv_model$spl_odds2$knots[2]), lty = 2, lwd = 1.5)
  abline(v = exp(surv_model$spl_odds2$knots[3]), lty = 2, lwd = 1.5)
  abline(v = exp(surv_model$spl_odds2$knots[1]), lty = 3, lwd = 1)
  abline(v = exp(surv_model$spl_odds2$knots[4]), lty = 3, lwd = 1)
  legend("bottomleft", legend = c(misc$group_names, rep("", length(misc$group_names))), 
         col = c(rep("5", misc$ngroups), c("black", "lightgrey", "darkgrey")[1:misc$ngroups]), 
         lty = c(as.integer(c(1, "2222", "5212")[1:misc$ngroups]), rep(1, misc$ngroups)), 
         cex = 0.8, ncol = 2,
         bty = "n")
  
  # annual transition probabilities
  plot(cbind(surv_obs$tp$gr_1$time, surv_obs$tp$gr_1$smooth), lwd = 1, 
       lty = 1, type = "b", cex = 0.6, pch = 1, col = "black", 
       main = "B: Annual transition probability (Spline, 2 knots, odds scale)", 
       xlab = "time", ylab = "annual transition probability (smoothed)", 
       ylim = c(0, ceiling(surv_obs$tp$max * 10)/10), xlim = c(0, ceiling(surv_obs$km$maxtime * 10)/10))
  lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_1[, 13]), col = "5", lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(surv_obs$tp$gr_2$time, surv_obs$tp$gr_2$smooth), 
          col = "lightgrey", type = "b", lwd = 1, cex = 0.6, pch = 8)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_2[, 13]), col = "5", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(surv_obs$tp$gr_3$time, surv_obs$tp$gr_3$smooth), 
          col = "darkgrey", type = "b", lwd = 1, cex = 0.6, pch = 9)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_3[, 13]), col = "5", lty = "5212", lwd = 2)
  }
  # add shading confidence intervals
  polygon(c(surv_obs$tp$gr_1$time, rev(surv_obs$tp$gr_1$time)), 
          c(surv_obs$tp$gr_1$smooth_lower, rev(surv_obs$tp$gr_1$smooth_upper)), 
          col = adjustcolor("black", alpha.f = 0.3), border = NA)
  if (misc$ngroups > 1) {
    polygon(c(surv_obs$tp$gr_2$time, rev(surv_obs$tp$gr_2$time)), 
            c(surv_obs$tp$gr_2$smooth_lower, rev(surv_obs$tp$gr_2$smooth_upper)), 
            col = adjustcolor("lightgrey", alpha.f = 0.3), border = NA)
  }
  if (misc$ngroups > 2) {
    polygon(c(surv_obs$tp$gr_3$time, rev(surv_obs$tp$gr_3$time)), 
            c(surv_obs$tp$gr_3$smooth_lower, rev(surv_obs$tp$gr_3$smooth_upper)), 
            col = adjustcolor("darkgrey", alpha.f = 0.3), border = NA)
  }
  abline(v = exp(surv_model$spl_odds2$knots[2]), lty = 2, lwd = 1.5)
  abline(v = exp(surv_model$spl_odds2$knots[3]), lty = 2, lwd = 1.5)
  abline(v = exp(surv_model$spl_odds2$knots[1]), lty = 3, lwd = 1)
  abline(v = exp(surv_model$spl_odds2$knots[4]), lty = 3, lwd = 1)
  legend("topleft", legend = c(misc$group_names, rep("", length(misc$group_names))), 
         col =  c(rep("5", misc$ngroups), c("black", "lightgrey", "darkgrey")[1:misc$ngroups]), 
         lty = c(as.integer(c(1, "2222", "5212")[1:misc$ngroups]), rep(NA, misc$ngroups)),
         pch = c(rep(NA, misc$ngroups), c(1, 8, 9)[1:misc$ngroups]),
         cex = 0.8, ncol = 2,
         bty = "n")
  
  # diagnostics
  plot(cbind(log(surv_obs$km$time), -log(surv_obs$km$surv/(1 - surv_obs$km$surv))), 
       cex = 0.6, pch = c(1, 8, 9)[surv_obs$km_names], 
       col = c("black", "lightgrey", "darkgrey")[surv_obs$km_names],
       main = "C: Diagnostic plot (Spline, 2 knots, odds scale)", 
       xlim = c(floor(min(log(surv_obs$km$time)[surv_obs$km$surv != 1])), ceiling(max(log(surv_obs$km$time)))), 
       xlab = "LN(time)", ylab = "-LN(survival odds)")
  lines(cbind(log(input$time_pred), 
              -log(surv_pred$model$spl_odds2[, 2]/(1 - surv_pred$model$spl_odds2[, 2]))), 
        col = "5", lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(log(input$time_pred), 
                -log(surv_pred$model$spl_odds2[, 3]/(1 - surv_pred$model$spl_odds2[, 3]))), 
          col = "5", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(log(input$time_pred), 
                -log(surv_pred$model$spl_odds2[, 4]/(1 - surv_pred$model$spl_odds2[, 4]))), 
          col = "5", lty = "5212", lwd = 2)
  }
  abline(v = surv_model$spl_odds2$knots[2], lty = 2, lwd = 1.5)
  abline(v = surv_model$spl_odds2$knots[3], lty = 2, lwd = 1.5)
  abline(v = surv_model$spl_odds2$knots[1], lty = 3, lwd = 1)
  abline(v = surv_model$spl_odds2$knots[4], lty = 3, lwd = 1)
  legend("topleft", legend = c(misc$group_names, rep("", length(misc$group_names))), 
         col =  c(rep("5", misc$ngroups), c("black", "lightgrey", "darkgrey")[1:misc$ngroups]), 
         lty = c(as.integer(c(1, "2222", "5212")[1:misc$ngroups]), rep(NA, misc$ngroups)),
         pch = c(rep(NA, misc$ngroups), c(1, 8, 9)[1:misc$ngroups]),
         cex = 0.8, ncol = 2,
         bty = "n")
  
}, envir = PERSUADE)
```

`r if(PERSUADE$input$spline_mod == TRUE) {return("\\newpage")}`

## Spline 3 knots odds 
```{r spline_odds3, echo=FALSE, out.height = "25%", fig.width=11, eval = PERSUADE$input$spline_mod}
evalq({
  # 2 knots
  plot(surv_obs$km, lwd = 2, main = "A: Kaplan-Meier (Spline, 3 knots, odds scale)", 
       xlab = "time", ylab = "survival", col = c("black", "lightgrey", "darkgrey"))
  lines(cbind(input$time_pred, surv_pred$model$spl_odds3[, 2]), col = "6", lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(input$time_pred, surv_pred$model$spl_odds3[, 3]), col = "6", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(input$time_pred, surv_pred$model$spl_odds3[, 4]), col = "6", lty = "5212", lwd = 2)
  }
  # add shading confidence intervals
  polygon(na.omit(data.frame(c(surv_obs$km$time[surv_obs$km_names == 1], rev(surv_obs$km$time[surv_obs$km_names == 1])),
                             c(surv_obs$km$lower[surv_obs$km_names == 1], rev(surv_obs$km$upper[surv_obs$km_names == 1])))), 
          col = adjustcolor("black", alpha.f = 0.3), border = NA)
  if (misc$ngroups > 1) {
    polygon(na.omit(data.frame(c(surv_obs$km$time[surv_obs$km_names == 2], rev(surv_obs$km$time[surv_obs$km_names == 2])),
                               c(surv_obs$km$lower[surv_obs$km_names == 2], rev(surv_obs$km$upper[surv_obs$km_names == 2])))),
            col = adjustcolor("lightgrey", alpha.f = 0.3), border = NA)
  }
  if (misc$ngroups > 2) {
    polygon(na.omit(data.frame(c(surv_obs$km$time[surv_obs$km_names == 3], rev(surv_obs$km$time[surv_obs$km_names == 3])),
                               c(surv_obs$km$lower[surv_obs$km_names == 3], rev(surv_obs$km$upper[surv_obs$km_names == 3])))), 
            col = adjustcolor("darkgrey", alpha.f = 0.3), border = NA)
  }
  abline(v = exp(surv_model$spl_odds3$knots[2]), lty = 2, lwd = 1.5)
  abline(v = exp(surv_model$spl_odds3$knots[3]), lty = 2, lwd = 1.5)
  abline(v = exp(surv_model$spl_odds3$knots[4]), lty = 2, lwd = 1.5)
  abline(v = exp(surv_model$spl_odds3$knots[1]), lty = 3, lwd = 1)
  abline(v = exp(surv_model$spl_odds3$knots[5]), lty = 3, lwd = 1)
  legend("bottomleft", legend = c(misc$group_names, rep("", length(misc$group_names))), 
         col = c(rep("6", misc$ngroups), c("black", "lightgrey", "darkgrey")[1:misc$ngroups]), 
         lty = c(as.integer(c(1, "2222", "5212")[1:misc$ngroups]), rep(1, misc$ngroups)), 
         cex = 0.8, ncol = 2,
         bty = "n")
  
  # annual transition probabilities
  plot(cbind(surv_obs$tp$gr_1$time, surv_obs$tp$gr_1$smooth), lwd = 1, 
       lty = 1, type = "b", cex = 0.6, pch = 1, col = "black", 
       main = "B: Annual transition probability (Spline, 3 knots, odds scale)", 
       xlab = "time", ylab = "annual transition probability (smoothed)", 
       ylim = c(0, ceiling(surv_obs$tp$max * 10)/10), xlim = c(0, ceiling(surv_obs$km$maxtime * 10)/10))
  lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_1[, 14]), col = "6", lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(surv_obs$tp$gr_2$time, surv_obs$tp$gr_2$smooth), 
          col = "lightgrey", type = "b", lwd = 1, cex = 0.6, pch = 8)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_2[, 14]), col = "6", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(surv_obs$tp$gr_3$time, surv_obs$tp$gr_3$smooth), 
          col = "darkgrey", type = "b", lwd = 1, cex = 0.6, pch = 9)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_3[, 14]), col = "6", lty = "5212", lwd = 2)
  }
  # add shading confidence intervals
  polygon(c(surv_obs$tp$gr_1$time, rev(surv_obs$tp$gr_1$time)), 
          c(surv_obs$tp$gr_1$smooth_lower, rev(surv_obs$tp$gr_1$smooth_upper)), 
          col = adjustcolor("black", alpha.f = 0.3), border = NA)
  if (misc$ngroups > 1) {
    polygon(c(surv_obs$tp$gr_2$time, rev(surv_obs$tp$gr_2$time)), 
            c(surv_obs$tp$gr_2$smooth_lower, rev(surv_obs$tp$gr_2$smooth_upper)), 
            col = adjustcolor("lightgrey", alpha.f = 0.3), border = NA)
  }
  if (misc$ngroups > 2) {
    polygon(c(surv_obs$tp$gr_3$time, rev(surv_obs$tp$gr_3$time)), 
            c(surv_obs$tp$gr_3$smooth_lower, rev(surv_obs$tp$gr_3$smooth_upper)), 
            col = adjustcolor("darkgrey", alpha.f = 0.3), border = NA)
  }
  abline(v = exp(surv_model$spl_odds3$knots[2]), lty = 2, lwd = 1.5)
  abline(v = exp(surv_model$spl_odds3$knots[3]), lty = 2, lwd = 1.5)
  abline(v = exp(surv_model$spl_odds3$knots[4]), lty = 2, lwd = 1.5)
  abline(v = exp(surv_model$spl_odds3$knots[1]), lty = 3, lwd = 1)
  abline(v = exp(surv_model$spl_odds3$knots[5]), lty = 3, lwd = 1)
  legend("topleft", legend = c(misc$group_names, rep("", length(misc$group_names))), 
         col =  c(rep("6", misc$ngroups), c("black", "lightgrey", "darkgrey")[1:misc$ngroups]), 
         lty = c(as.integer(c(1, "2222", "5212")[1:misc$ngroups]), rep(NA, misc$ngroups)),
         pch = c(rep(NA, misc$ngroups), c(1, 8, 9)[1:misc$ngroups]),
         cex = 0.8, ncol = 2,
         bty = "n")
  
  # diagnostics
  plot(cbind(log(surv_obs$km$time), -log(surv_obs$km$surv/(1 - surv_obs$km$surv))), 
       cex = 0.6, pch = c(1, 8, 9)[surv_obs$km_names], 
       col = c("black", "lightgrey", "darkgrey")[surv_obs$km_names],
       main = "C: Diagnostic plot (Spline, 3 knots, odds scale)", 
       xlim = c(floor(min(log(surv_obs$km$time)[surv_obs$km$surv != 1])), ceiling(max(log(surv_obs$km$time)))), 
       xlab = "LN(time)", ylab = "-LN(survival odds)")
  lines(cbind(log(input$time_pred), 
              -log(surv_pred$model$spl_odds3[, 2]/(1 - surv_pred$model$spl_odds3[, 2]))), 
        col = "6", lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(log(input$time_pred), 
                -log(surv_pred$model$spl_odds3[, 3]/(1 - surv_pred$model$spl_odds3[, 3]))), 
          col = "6", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(log(input$time_pred), 
                -log(surv_pred$model$spl_odds3[, 4]/(1 - surv_pred$model$spl_odds3[, 4]))), 
          col = "6", lty = "5212", lwd = 2)
  }
  abline(v = surv_model$spl_odds3$knots[2], lty = 2, lwd = 1.5)
  abline(v = surv_model$spl_odds3$knots[3], lty = 2, lwd = 1.5)
  abline(v = surv_model$spl_odds3$knots[4], lty = 2, lwd = 1.5)
  abline(v = surv_model$spl_odds3$knots[1], lty = 3, lwd = 1)
  abline(v = surv_model$spl_odds3$knots[5], lty = 3, lwd = 1)
  legend("topleft", legend = c(misc$group_names, rep("", length(misc$group_names))), 
         col =  c(rep("6", misc$ngroups), c("black", "lightgrey", "darkgrey")[1:misc$ngroups]), 
         lty = c(as.integer(c(1, "2222", "5212")[1:misc$ngroups]), rep(NA, misc$ngroups)),
         pch = c(rep(NA, misc$ngroups), c(1, 8, 9)[1:misc$ngroups]),
         cex = 0.8, ncol = 2,
         bty = "n")
  
}, envir = PERSUADE)
```

`r if(PERSUADE$input$spline_mod == TRUE) {return("\\newpage")}`

## Spline 1 knot normal 
```{r spline_norm1, echo=FALSE, out.height = "25%", fig.width=11, eval = PERSUADE$input$spline_mod}
evalq({
  # 1 knot
  plot(surv_obs$km, lwd = 2, main = "A: Kaplan-Meier (Spline, 1 knot, normal scale)", 
       xlab = "time", ylab = "survival", col = c("black", "lightgrey", "darkgrey"))
  lines(cbind(input$time_pred, surv_pred$model$spl_normal1[, 2]), col = "7", lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(input$time_pred, surv_pred$model$spl_normal1[, 3]), col = "7", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(input$time_pred, surv_pred$model$spl_normal1[, 4]), col = "7", lty = "5212", lwd = 2)
  }
  # add shading confidence intervals
  polygon(na.omit(data.frame(c(surv_obs$km$time[surv_obs$km_names == 1], rev(surv_obs$km$time[surv_obs$km_names == 1])),
                             c(surv_obs$km$lower[surv_obs$km_names == 1], rev(surv_obs$km$upper[surv_obs$km_names == 1])))), 
          col = adjustcolor("black", alpha.f = 0.3), border = NA)
  if (misc$ngroups > 1) {
    polygon(na.omit(data.frame(c(surv_obs$km$time[surv_obs$km_names == 2], rev(surv_obs$km$time[surv_obs$km_names == 2])),
                               c(surv_obs$km$lower[surv_obs$km_names == 2], rev(surv_obs$km$upper[surv_obs$km_names == 2])))), 
            col = adjustcolor("lightgrey", alpha.f = 0.3), border = NA)
  }
  if (misc$ngroups > 2) {
    polygon(na.omit(data.frame(c(surv_obs$km$time[surv_obs$km_names == 3], rev(surv_obs$km$time[surv_obs$km_names == 3])),
                               c(surv_obs$km$lower[surv_obs$km_names == 3], rev(surv_obs$km$upper[surv_obs$km_names == 3])))), 
            col = adjustcolor("darkgrey", alpha.f = 0.3), border = NA)
  }
  abline(v = exp(surv_model$spl_normal1$knots[2]), lty = 2, lwd = 1.5)
  abline(v = exp(surv_model$spl_normal1$knots[1]), lty = 3, lwd = 1)
  abline(v = exp(surv_model$spl_normal1$knots[3]), lty = 3, lwd = 1)
  legend("bottomleft", legend = c(misc$group_names, rep("", length(misc$group_names))), 
         col = c(rep("7", misc$ngroups), c("black", "lightgrey", "darkgrey")[1:misc$ngroups]), 
         lty = c(as.integer(c(1, "2222", "5212")[1:misc$ngroups]), rep(1, misc$ngroups)), 
         cex = 0.8, ncol = 2,
         bty = "n")
  
  # annual transition probabilities
  plot(cbind(surv_obs$tp$gr_1$time, surv_obs$tp$gr_1$smooth), lwd = 1, 
       lty = 1, type = "b", cex = 0.6, pch = 1, col = "black",
       main = "B: Annual transition probability (Spline, 1 knot, normal scale)", 
       xlab = "time", ylab = "annual transition probability (smoothed)", 
       ylim = c(0, ceiling(surv_obs$tp$max * 10)/10), xlim = c(0, ceiling(surv_obs$km$maxtime * 10)/10))
  lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_1[, 15]), col = "7", lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(surv_obs$tp$gr_2$time, surv_obs$tp$gr_2$smooth), 
          col = "lightgrey", type = "b", lwd = 1, cex = 0.6, pch = 8)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_2[, 15]), col = "7", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(surv_obs$tp$gr_3$time, surv_obs$tp$gr_3$smooth), 
          col = "darkgrey", type = "b", lwd = 1, cex = 0.6, pch = 9)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_3[, 15]), col = "7", lty = "5212", lwd = 2)
  }
  # add shading confidence intervals
  polygon(c(surv_obs$tp$gr_1$time, rev(surv_obs$tp$gr_1$time)), 
          c(surv_obs$tp$gr_1$smooth_lower, rev(surv_obs$tp$gr_1$smooth_upper)), 
          col = adjustcolor("black", alpha.f = 0.3), border = NA)
  if (misc$ngroups > 1) {
    polygon(c(surv_obs$tp$gr_2$time, rev(surv_obs$tp$gr_2$time)), 
            c(surv_obs$tp$gr_2$smooth_lower, rev(surv_obs$tp$gr_2$smooth_upper)), 
            col = adjustcolor("lightgrey", alpha.f = 0.3), border = NA)
  }
  if (misc$ngroups > 2) {
    polygon(c(surv_obs$tp$gr_3$time, rev(surv_obs$tp$gr_3$time)), 
            c(surv_obs$tp$gr_3$smooth_lower, rev(surv_obs$tp$gr_3$smooth_upper)), 
            col = adjustcolor("darkgrey", alpha.f = 0.3), border = NA)
  }
  abline(v = exp(surv_model$spl_normal1$knots[2]), lty = 2, lwd = 1.5)
  abline(v = exp(surv_model$spl_normal1$knots[1]), lty = 3, lwd = 1)
  abline(v = exp(surv_model$spl_normal1$knots[3]), lty = 3, lwd = 1)
  legend("topleft", legend = c(misc$group_names, rep("", length(misc$group_names))), 
         col =  c(rep("7", misc$ngroups), c("black", "lightgrey", "darkgrey")[1:misc$ngroups]), 
         lty = c(as.integer(c(1, "2222", "5212")[1:misc$ngroups]), rep(NA, misc$ngroups)),
         pch = c(rep(NA, misc$ngroups), c(1, 8, 9)[1:misc$ngroups]),
         cex = 0.8, ncol = 2,
         bty = "n")
  
  # diagnostics
  plot(cbind(log(surv_obs$km$time), 
             -qnorm(surv_obs$km$surv, mean = 0, sd = 1, lower.tail = TRUE, log.p = FALSE)), 
       pch = c(1, 8, 9)[surv_obs$km_names], 
       col = c("black", "lightgrey", "darkgrey")[surv_obs$km_names], cex = 0.6, 
       main = "C: Diagnostic plot (Spline, 1 knot, normal scale)", 
       xlim = c(floor(min(log(surv_obs$km$time)[surv_obs$km$surv != 1])), 
                ceiling(max(log(surv_obs$km$time)))), xlab = "LN(time)", ylab = "- standard normal quartiles")
  lines(cbind(log(input$time_pred), 
              -qnorm(surv_pred$model$spl_normal1[, 2], mean = 0, sd = 1, lower.tail = TRUE, log.p = FALSE)), 
        col = "7", lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(log(input$time_pred), 
                -qnorm(surv_pred$model$spl_normal1[, 3], mean = 0, sd = 1, lower.tail = TRUE, log.p = FALSE)),
          col = "7", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(log(input$time_pred), 
                -qnorm(surv_pred$model$spl_normal1[, 4], mean = 0, sd = 1, lower.tail = TRUE, log.p = FALSE)),
          col = "7", lty = "5212", lwd = 2)
  }
  abline(v = surv_model$spl_normal1$knots[2], lty = 2, lwd = 1.5)
  abline(v = surv_model$spl_normal1$knots[1], lty = 3, lwd = 1)
  abline(v = surv_model$spl_normal1$knots[3], lty = 3, lwd = 1)
  legend("topleft", legend = c(misc$group_names, rep("", length(misc$group_names))), 
         col =  c(rep("7", misc$ngroups), c("black", "lightgrey", "darkgrey")[1:misc$ngroups]), 
         lty = c(as.integer(c(1, "2222", "5212")[1:misc$ngroups]), rep(NA, misc$ngroups)),
         pch = c(rep(NA, misc$ngroups), c(1, 8, 9)[1:misc$ngroups]),
         cex = 0.8, ncol = 2,
         bty = "n")
  
}, envir = PERSUADE)
```

`r if(PERSUADE$input$spline_mod == TRUE) {return("\\newpage")}`

## Spline 2 knots normal 
```{r spline_norm2, echo=FALSE, out.height = "25%", fig.width=11, eval = PERSUADE$input$spline_mod}
evalq({
  # 2 knots
  plot(surv_obs$km, lwd = 2, main = "A: Kaplan-Meier (Spline, 2 knots, normal scale)", 
       xlab = "time", ylab = "survival", col = c("black", "lightgrey", "darkgrey"))
  lines(cbind(input$time_pred, surv_pred$model$spl_normal2[, 2]), col = "8", lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(input$time_pred, surv_pred$model$spl_normal2[, 3]), col = "8", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(input$time_pred, surv_pred$model$spl_normal2[, 4]), col = "8", lty = "5212", lwd = 2)
  }
  # add shading confidence intervals
  polygon(na.omit(data.frame(c(surv_obs$km$time[surv_obs$km_names == 1], rev(surv_obs$km$time[surv_obs$km_names == 1])),
                             c(surv_obs$km$lower[surv_obs$km_names == 1], rev(surv_obs$km$upper[surv_obs$km_names == 1])))), 
          col = adjustcolor("black", alpha.f = 0.3), border = NA)
  if (misc$ngroups > 1) {
    polygon(na.omit(data.frame(c(surv_obs$km$time[surv_obs$km_names == 2], rev(surv_obs$km$time[surv_obs$km_names == 2])),
                               c(surv_obs$km$lower[surv_obs$km_names == 2], rev(surv_obs$km$upper[surv_obs$km_names == 2])))), 
            col = adjustcolor("lightgrey", alpha.f = 0.3), border = NA)
  }
  if (misc$ngroups > 2) {
    polygon(na.omit(data.frame(c(surv_obs$km$time[surv_obs$km_names == 3], rev(surv_obs$km$time[surv_obs$km_names == 3])),
                               c(surv_obs$km$lower[surv_obs$km_names == 3], rev(surv_obs$km$upper[surv_obs$km_names == 3])))), 
            col = adjustcolor("darkgrey", alpha.f = 0.3), border = NA)
  }
  abline(v = exp(surv_model$spl_normal2$knots[2]), lty = 2, lwd = 1.5)
  abline(v = exp(surv_model$spl_normal2$knots[3]), lty = 2, lwd = 1.5)
  abline(v = exp(surv_model$spl_normal2$knots[1]), lty = 3, lwd = 1)
  abline(v = exp(surv_model$spl_normal2$knots[4]), lty = 3, lwd = 1)
  legend("bottomleft", legend = c(misc$group_names, rep("", length(misc$group_names))), 
         col = c(rep("8", misc$ngroups), c("black", "lightgrey", "darkgrey")[1:misc$ngroups]), 
         lty = c(as.integer(c(1, "2222", "5212")[1:misc$ngroups]), rep(1, misc$ngroups)), 
         cex = 0.8, ncol = 2,
         bty = "n")
  
  # annual transition probabilities
  plot(cbind(surv_obs$tp$gr_1$time, surv_obs$tp$gr_1$smooth), lwd = 1, 
       lty = 1, type = "b", cex = 0.6, pch = 1, col = "black", 
       main = "B: Annual transition probability (Spline, 2 knots, normal scale)", 
       xlab = "time", ylab = "annual transition probability (smoothed)", 
       ylim = c(0, ceiling(surv_obs$tp$max * 10)/10), xlim = c(0, ceiling(surv_obs$km$maxtime * 10)/10))
  lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_1[, 16]), col = "8", lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(surv_obs$tp$gr_2$time, surv_obs$tp$gr_2$smooth), 
          col = "lightgrey", type = "b", lwd = 1, cex = 0.6, pch = 8)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_2[, 16]), col = "8", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(surv_obs$tp$gr_3$time, surv_obs$tp$gr_3$smooth), 
          col = "darkgrey", type = "b", lwd = 1, cex = 0.6, pch = 9)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_3[, 16]), col = "8", lty = "5212", lwd = 2)
  }
  # add shading confidence intervals
  polygon(c(surv_obs$tp$gr_1$time, rev(surv_obs$tp$gr_1$time)), 
          c(surv_obs$tp$gr_1$smooth_lower, rev(surv_obs$tp$gr_1$smooth_upper)), 
          col = adjustcolor("black", alpha.f = 0.3), border = NA)
  if (misc$ngroups > 1) {
    polygon(c(surv_obs$tp$gr_2$time, rev(surv_obs$tp$gr_2$time)), 
            c(surv_obs$tp$gr_2$smooth_lower, rev(surv_obs$tp$gr_2$smooth_upper)), 
            col = adjustcolor("lightgrey", alpha.f = 0.3), border = NA)
  }
  if (misc$ngroups > 2) {
    polygon(c(surv_obs$tp$gr_3$time, rev(surv_obs$tp$gr_3$time)), 
            c(surv_obs$tp$gr_3$smooth_lower, rev(surv_obs$tp$gr_3$smooth_upper)), 
            col = adjustcolor("darkgrey", alpha.f = 0.3), border = NA)
  }
  abline(v = exp(surv_model$spl_normal2$knots[2]), lty = 2, lwd = 1.5)
  abline(v = exp(surv_model$spl_normal2$knots[3]), lty = 2, lwd = 1.5)
  abline(v = exp(surv_model$spl_normal2$knots[1]), lty = 3, lwd = 1)
  abline(v = exp(surv_model$spl_normal2$knots[4]), lty = 3, lwd = 1)
  legend("topleft", legend = c(misc$group_names, rep("", length(misc$group_names))), 
         col =  c(rep("8", misc$ngroups), c("black", "lightgrey", "darkgrey")[1:misc$ngroups]), 
         lty = c(as.integer(c(1, "2222", "5212")[1:misc$ngroups]), rep(NA, misc$ngroups)),
         pch = c(rep(NA, misc$ngroups), c(1, 8, 9)[1:misc$ngroups]),
         cex = 0.8, ncol = 2,
         bty = "n")
  
  # diagnostics
  plot(cbind(log(surv_obs$km$time), 
             -qnorm(surv_obs$km$surv, mean = 0, sd = 1, lower.tail = TRUE, log.p = FALSE)), 
       pch = c(1, 8, 9)[surv_obs$km_names], 
       col = c("black", "lightgrey", "darkgrey")[surv_obs$km_names], cex = 0.6, 
       main = "C: Diagnostic plot (Spline, 2 knots, normal scale)", 
       xlim = c(floor(min(log(surv_obs$km$time)[surv_obs$km$surv != 1])), 
                ceiling(max(log(surv_obs$km$time)))), 
       xlab = "LN(time)", ylab = "- standard normal quartiles")
  lines(cbind(log(input$time_pred), 
              -qnorm(surv_pred$model$spl_normal2[, 2], mean = 0, sd = 1, lower.tail = TRUE, log.p = FALSE)), 
        col = "8", lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(log(input$time_pred), 
                -qnorm(surv_pred$model$spl_normal2[, 3], mean = 0, sd = 1, lower.tail = TRUE, log.p = FALSE)),
          col = "8", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(log(input$time_pred), 
                -qnorm(surv_pred$model$spl_normal2[, 4], mean = 0, sd = 1, lower.tail = TRUE, log.p = FALSE)),
          col = "8", lty = "5212", lwd = 2)
  }
  abline(v = surv_model$spl_normal2$knots[2], lty = 2, lwd = 1.5)
  abline(v = surv_model$spl_normal2$knots[3], lty = 2, lwd = 1.5)
  abline(v = surv_model$spl_normal2$knots[1], lty = 3, lwd = 1)
  abline(v = surv_model$spl_normal2$knots[4], lty = 3, lwd = 1)
  legend("topleft", legend = c(misc$group_names, rep("", length(misc$group_names))), 
         col =  c(rep("8", misc$ngroups), c("black", "lightgrey", "darkgrey")[1:misc$ngroups]), 
         lty = c(as.integer(c(1, "2222", "5212")[1:misc$ngroups]), rep(NA, misc$ngroups)),
         pch = c(rep(NA, misc$ngroups), c(1, 8, 9)[1:misc$ngroups]),
         cex = 0.8, ncol = 2,
         bty = "n")
  
}, envir = PERSUADE)
```

`r if(PERSUADE$input$spline_mod == TRUE) {return("\\newpage")}`

## Spline 3 knots normal 
```{r spline_norm3, echo=FALSE, out.height = "25%", fig.width=11, eval = PERSUADE$input$spline_mod}
evalq({
  # 2 knots
  plot(surv_obs$km, lwd = 2, main = "A: Kaplan-Meier (Spline, 3 knots, normal scale)", 
       xlab = "time", ylab = "survival", col = c("black", "lightgrey", "darkgrey"))
  lines(cbind(input$time_pred, surv_pred$model$spl_normal3[, 2]), col = "9", lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(input$time_pred, surv_pred$model$spl_normal3[, 3]), col = "9", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(input$time_pred, surv_pred$model$spl_normal3[, 4]), col = "9", lty = "5212", lwd = 2)
  }
  # add shading confidence intervals
  polygon(na.omit(data.frame(c(surv_obs$km$time[surv_obs$km_names == 1], rev(surv_obs$km$time[surv_obs$km_names == 1])),
                             c(surv_obs$km$lower[surv_obs$km_names == 1], rev(surv_obs$km$upper[surv_obs$km_names == 1])))), 
          col = adjustcolor("black", alpha.f = 0.3), border = NA)
  if (misc$ngroups > 1) {
    polygon(na.omit(data.frame(c(surv_obs$km$time[surv_obs$km_names == 2], rev(surv_obs$km$time[surv_obs$km_names == 2])),
                               c(surv_obs$km$lower[surv_obs$km_names == 2], rev(surv_obs$km$upper[surv_obs$km_names == 2])))), 
            col = adjustcolor("lightgrey", alpha.f = 0.3), border = NA)
  }
  if (misc$ngroups > 2) {
    polygon(na.omit(data.frame(c(surv_obs$km$time[surv_obs$km_names == 3], rev(surv_obs$km$time[surv_obs$km_names == 3])),
                               c(surv_obs$km$lower[surv_obs$km_names == 3], rev(surv_obs$km$upper[surv_obs$km_names == 3])))), 
            col = adjustcolor("darkgrey", alpha.f = 0.3), border = NA)
  }
  abline(v = exp(surv_model$spl_normal3$knots[2]), lty = 2, lwd = 1.5)
  abline(v = exp(surv_model$spl_normal3$knots[3]), lty = 2, lwd = 1.5)
  abline(v = exp(surv_model$spl_normal3$knots[4]), lty = 2, lwd = 1.5)
  abline(v = exp(surv_model$spl_normal3$knots[1]), lty = 3, lwd = 1)
  abline(v = exp(surv_model$spl_normal3$knots[5]), lty = 3, lwd = 1)
  legend("bottomleft", legend = c(misc$group_names, rep("", length(misc$group_names))), 
         col = c(rep("9", misc$ngroups), c("black", "lightgrey", "darkgrey")[1:misc$ngroups]), 
         lty = c(as.integer(c(1, "2222", "5212")[1:misc$ngroups]), rep(1, misc$ngroups)), 
         cex = 0.8, ncol = 2,
         bty = "n")
  
  # annual transition probabilities
  plot(cbind(surv_obs$tp$gr_1$time, surv_obs$tp$gr_1$smooth), lwd = 1, 
       lty = 1, type = "b", cex = 0.6, pch = 1, col = "black", 
       main = "B: Annual transition probability (Spline, 3 knots, normal scale)", 
       xlab = "time", ylab = "annual transition probability (smoothed)", 
       ylim = c(0, ceiling(surv_obs$tp$max * 10)/10), xlim = c(0, ceiling(surv_obs$km$maxtime * 10)/10))
  lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_1[, 17]), col = "9", lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(surv_obs$tp$gr_2$time, surv_obs$tp$gr_2$smooth), 
          col = "lightgrey", type = "b", lwd = 1, cex = 0.6, pch = 8)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_2[, 17]), col = "9", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(surv_obs$tp$gr_3$time, surv_obs$tp$gr_3$smooth), 
          col = "darkgrey", type = "b", lwd = 1, cex = 0.6, pch = 9)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_3[, 17]), col = "9", lty = "5212", lwd = 2)
  }
  # add shading confidence intervals
  polygon(c(surv_obs$tp$gr_1$time, rev(surv_obs$tp$gr_1$time)), 
          c(surv_obs$tp$gr_1$smooth_lower, rev(surv_obs$tp$gr_1$smooth_upper)), 
          col = adjustcolor("black", alpha.f = 0.3), border = NA)
  if (misc$ngroups > 1) {
    polygon(c(surv_obs$tp$gr_2$time, rev(surv_obs$tp$gr_2$time)), 
            c(surv_obs$tp$gr_2$smooth_lower, rev(surv_obs$tp$gr_2$smooth_upper)), 
            col = adjustcolor("lightgrey", alpha.f = 0.3), border = NA)
  }
  if (misc$ngroups > 2) {
    polygon(c(surv_obs$tp$gr_3$time, rev(surv_obs$tp$gr_3$time)), 
            c(surv_obs$tp$gr_3$smooth_lower, rev(surv_obs$tp$gr_3$smooth_upper)), 
            col = adjustcolor("darkgrey", alpha.f = 0.3), border = NA)
  }
  abline(v = exp(surv_model$spl_normal3$knots[2]), lty = 2, lwd = 1.5)
  abline(v = exp(surv_model$spl_normal3$knots[3]), lty = 2, lwd = 1.5)
  abline(v = exp(surv_model$spl_normal3$knots[4]), lty = 2, lwd = 1.5)
  abline(v = exp(surv_model$spl_normal3$knots[1]), lty = 3, lwd = 1)
  abline(v = exp(surv_model$spl_normal3$knots[5]), lty = 3, lwd = 1)
  legend("topleft", legend = c(misc$group_names, rep("", length(misc$group_names))), 
         col =  c(rep("9", misc$ngroups), c("black", "lightgrey", "darkgrey")[1:misc$ngroups]), 
         lty = c(as.integer(c(1, "2222", "5212")[1:misc$ngroups]), rep(NA, misc$ngroups)),
         pch = c(rep(NA, misc$ngroups), c(1, 8, 9)[1:misc$ngroups]),
         cex = 0.8, ncol = 2,
         bty = "n")
  
  # diagnostics
  plot(cbind(log(surv_obs$km$time), 
             -qnorm(surv_obs$km$surv, mean = 0, sd = 1, lower.tail = TRUE, log.p = FALSE)), 
       pch = c(1, 8, 9)[surv_obs$km_names], 
       col = c("black", "lightgrey", "darkgrey")[surv_obs$km_names], cex = 0.6, 
       main = "C: Diagnostic plot (Spline, 3 knots, normal scale)", 
       xlim = c(floor(min(log(surv_obs$km$time)[surv_obs$km$surv != 1])), 
                ceiling(max(log(surv_obs$km$time)))), 
       xlab = "LN(time)", ylab = "- standard normal quartiles")
  lines(cbind(log(input$time_pred), 
              -qnorm(surv_pred$model$spl_normal3[, 2], mean = 0, sd = 1, lower.tail = TRUE, log.p = FALSE)), 
        col = "9", lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(log(input$time_pred), 
                -qnorm(surv_pred$model$spl_normal3[, 3], mean = 0, sd = 1, lower.tail = TRUE, log.p = FALSE)),
          col = "9", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(log(input$time_pred), 
                -qnorm(surv_pred$model$spl_normal3[, 4], mean = 0, sd = 1, lower.tail = TRUE, log.p = FALSE)),
          col = "9", lty = "5212", lwd = 2)
  }
  abline(v = surv_model$spl_normal3$knots[2], lty = 2, lwd = 1.5)
  abline(v = surv_model$spl_normal3$knots[3], lty = 2, lwd = 1.5)
  abline(v = surv_model$spl_normal3$knots[4], lty = 2, lwd = 1.5)
  abline(v = surv_model$spl_normal3$knots[1], lty = 3, lwd = 1)
  abline(v = surv_model$spl_normal3$knots[5], lty = 3, lwd = 1)
  legend("topleft", legend = c(misc$group_names, rep("", length(misc$group_names))), 
         col =  c(rep("9", misc$ngroups), c("black", "lightgrey", "darkgrey")[1:misc$ngroups]), 
         lty = c(as.integer(c(1, "2222", "5212")[1:misc$ngroups]), rep(NA, misc$ngroups)),
         pch = c(rep(NA, misc$ngroups), c(1, 8, 9)[1:misc$ngroups]),
         cex = 0.8, ncol = 2,
         bty = "n")
  
}, envir = PERSUADE)
```

\newpage

# Parametric (non-)mixture cure models 
If standard parametric models do not provide a satisfactory fit to the data based on previous observations, do cure models provide a more satisfactory fit to the data?  

mixture cure models: S * (1 - theta) + theta * 1 
(theta * 1 assumes that the cure fraction has 100% survival)
non-mixture cure models: exp((1-S) * log(theta))

```{r cure, echo=FALSE, eval = PERSUADE$input$cure_mod}
evalq({
  pie(rep(1, n), labels = misc$lbls_cure, 
      col = rainbow(n = n, s = 1, v = 1, start = 0, end = max(1, n - 1)/n, alpha = 1))
  
  kable_styling(kable(rbind(surv_model$IC[,1:2], surv_model$IC_cure[,1:2])[order(rbind(surv_model$IC[,1:2],
                                                                                       surv_model$IC_cure[,1:2])$AIC), ], 
                      format = "latex", row.names = FALSE, booktabs = TRUE, 
                      linesep = ""), latex_options = "striped")
}, envir = PERSUADE)

evalq({
  kable_styling(kable(surv_model$IC_cure[,-2], 
                      format = "latex", row.names = FALSE, booktabs = TRUE, 
                      linesep = ""), latex_options = c("scale_down", "striped"))
  
}, envir = PERSUADE)
```

`r if(PERSUADE$input$cure_mod == TRUE) {return("\\newpage")}`

## Mixture cure Weibull
```{r cure_weib_mix, echo=FALSE, out.height = "25%", fig.width=11, eval = PERSUADE$input$cure_mod}
evalq({
  # 1 knot
  plot(surv_obs$km, lwd = 2, main = "A: Kaplan-Meier (Weibull mixture cure)", 
       xlab = "time", ylab = "survival", col = c("black", "lightgrey", "darkgrey"))
  lines(cbind(input$time_pred, surv_pred$model$cure_weib_mix[, 2]), col = "1", lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(input$time_pred, surv_pred$model$cure_weib_mix[, 3]), col = "1", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(input$time_pred, surv_pred$model$cure_weib_mix[, 4]), col = "1", lty = "5212", lwd = 2)
  }
  # add shading confidence intervals
  polygon(na.omit(data.frame(c(surv_obs$km$time[surv_obs$km_names == 1], rev(surv_obs$km$time[surv_obs$km_names == 1])),
                             c(surv_obs$km$lower[surv_obs$km_names == 1], rev(surv_obs$km$upper[surv_obs$km_names == 1])))), 
          col = adjustcolor("black", alpha.f = 0.3), border = NA)
  if (misc$ngroups > 1) {
    polygon(na.omit(data.frame(c(surv_obs$km$time[surv_obs$km_names == 2], rev(surv_obs$km$time[surv_obs$km_names == 2])),
                               c(surv_obs$km$lower[surv_obs$km_names == 2], rev(surv_obs$km$upper[surv_obs$km_names == 2])))), 
            col = adjustcolor("lightgrey", alpha.f = 0.3), border = NA)
  }
  if (misc$ngroups > 2) {
    polygon(na.omit(data.frame(c(surv_obs$km$time[surv_obs$km_names == 3], rev(surv_obs$km$time[surv_obs$km_names == 3])),
                               c(surv_obs$km$lower[surv_obs$km_names == 3], rev(surv_obs$km$upper[surv_obs$km_names == 3])))), 
            col = adjustcolor("darkgrey", alpha.f = 0.3), border = NA)
  }
  legend("bottomleft", legend = c(misc$group_names, rep("", length(misc$group_names))), 
         col = c(rep("1", misc$ngroups), c("black", "lightgrey", "darkgrey")[1:misc$ngroups]), 
         lty = c(as.integer(c(1, "2222", "5212")[1:misc$ngroups]), rep(1, misc$ngroups)), 
         cex = 0.8, ncol = 2,
         bty = "n")
  
  # annual transition probabilities
  plot(cbind(surv_obs$tp$gr_1$time, surv_obs$tp$gr_1$smooth), lwd = 1, 
       lty = 1, type = "b", cex = 0.6, pch = 1, col = "black", 
       main = "B: Annual transition probability (Weibull mixture cure)", 
       xlab = "time", ylab = "annual transition probability (smoothed)", 
       ylim = c(0, ceiling(surv_obs$tp$max * 10)/10), xlim = c(0, ceiling(surv_obs$km$maxtime * 10)/10))
  lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_1[, 18 - if(input$spline_mod == FALSE) {9} else {0}]), 
        col = "1", lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(surv_obs$tp$gr_2$time, surv_obs$tp$gr_2$smooth), 
          col = "lightgrey", type = "b", lwd = 1, cex = 0.6, pch = 8)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_2[, 18 - if(input$spline_mod == FALSE) {9} else {0}]), 
          col = "1", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(surv_obs$tp$gr_3$time, surv_obs$tp$gr_3$smooth), 
          col = "darkgrey", type = "b", lwd = 1, cex = 0.6, pch = 9)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_3[, 18 - if(input$spline_mod == FALSE) {9} else {0}]), 
          col = "1", lty = "5212", lwd = 2)
  }
  # add shading confidence intervals
  polygon(c(surv_obs$tp$gr_1$time, rev(surv_obs$tp$gr_1$time)), 
          c(surv_obs$tp$gr_1$smooth_lower, rev(surv_obs$tp$gr_1$smooth_upper)), 
          col = adjustcolor("black", alpha.f = 0.3), border = NA)
  if (misc$ngroups > 1) {
    polygon(c(surv_obs$tp$gr_2$time, rev(surv_obs$tp$gr_2$time)), 
            c(surv_obs$tp$gr_2$smooth_lower, rev(surv_obs$tp$gr_2$smooth_upper)), 
            col = adjustcolor("lightgrey", alpha.f = 0.3), border = NA)
  }
  if (misc$ngroups > 2) {
    polygon(c(surv_obs$tp$gr_3$time, rev(surv_obs$tp$gr_3$time)), 
            c(surv_obs$tp$gr_3$smooth_lower, rev(surv_obs$tp$gr_3$smooth_upper)), 
            col = adjustcolor("darkgrey", alpha.f = 0.3), border = NA)
  }
  legend("topleft", legend = c(misc$group_names, rep("", length(misc$group_names))), 
         col =  c(rep("1", misc$ngroups), c("black", "lightgrey", "darkgrey")[1:misc$ngroups]), 
         lty = c(as.integer(c(1, "2222", "5212")[1:misc$ngroups]), rep(NA, misc$ngroups)),
         pch = c(rep(NA, misc$ngroups), c(1, 8, 9)[1:misc$ngroups]),
         cex = 0.8, ncol = 2,
         bty = "n")
  
  # diagnostics
  plot(cbind(log(surv_obs$km$time), log(-log(surv_obs$km$surv))), cex = 0.6, 
       pch = c(1, 8, 9)[surv_obs$km_names], 
       xlim = c(floor(min(log(surv_obs$km$time)[surv_obs$km$surv != 1])), 
                ceiling(max(log(surv_obs$km$time)))), 
       col = c("black", "lightgrey", "darkgrey")[surv_obs$km_names], 
       main = "C: Diagnostic plot (Weibull mixture cure)", 
       xlab = "LN(time)", ylab = "LN(cumulative hazard)")
  lines(cbind(log(input$time_pred), log(-log(surv_pred$model$cure_weib_mix[, 2]))), 
        col = "1", lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(log(input$time_pred), log(-log(surv_pred$model$cure_weib_mix[, 3]))), 
          col = "1", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(log(input$time_pred), log(-log(surv_pred$model$cure_weib_mix[, 4]))), 
          col = "1", lty = "5212", lwd = 2)
  }
  legend("topleft", legend = c(misc$group_names, rep("", length(misc$group_names))), 
         col =  c(rep("1", misc$ngroups), c("black", "lightgrey", "darkgrey")[1:misc$ngroups]), 
         lty = c(as.integer(c(1, "2222", "5212")[1:misc$ngroups]), rep(NA, misc$ngroups)),
         pch = c(rep(NA, misc$ngroups), c(1, 8, 9)[1:misc$ngroups]),
         cex = 0.8, ncol = 2,
         bty = "n")
  
}, envir = PERSUADE)
```

`r if(PERSUADE$input$cure_mod == TRUE) {return("\\newpage")}`

## Non-mixture cure Weibull
```{r cure_weib_nmix, echo=FALSE, out.height = "25%", fig.width=11, eval = PERSUADE$input$cure_mod}
evalq({
  # 1 knot
  plot(surv_obs$km, lwd = 2, main = "A: Kaplan-Meier (Weibull non-mixture cure)", 
       xlab = "time", ylab = "survival", col = c("black", "lightgrey", "darkgrey"))
  lines(cbind(input$time_pred, surv_pred$model$cure_weib_nmix[, 2]), col = "2", lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(input$time_pred, surv_pred$model$cure_weib_nmix[, 3]), col = "2", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(input$time_pred, surv_pred$model$cure_weib_nmix[, 4]), col = "2", lty = "5212", lwd = 2)
  }
  # add shading confidence intervals
  polygon(na.omit(data.frame(c(surv_obs$km$time[surv_obs$km_names == 1], rev(surv_obs$km$time[surv_obs$km_names == 1])),
                             c(surv_obs$km$lower[surv_obs$km_names == 1], rev(surv_obs$km$upper[surv_obs$km_names == 1])))), 
          col = adjustcolor("black", alpha.f = 0.3), border = NA)
  if (misc$ngroups > 1) {
    polygon(na.omit(data.frame(c(surv_obs$km$time[surv_obs$km_names == 2], rev(surv_obs$km$time[surv_obs$km_names == 2])),
                               c(surv_obs$km$lower[surv_obs$km_names == 2], rev(surv_obs$km$upper[surv_obs$km_names == 2])))), 
            col = adjustcolor("lightgrey", alpha.f = 0.3), border = NA)
  }
  if (misc$ngroups > 2) {
    polygon(na.omit(data.frame(c(surv_obs$km$time[surv_obs$km_names == 3], rev(surv_obs$km$time[surv_obs$km_names == 3])),
                               c(surv_obs$km$lower[surv_obs$km_names == 3], rev(surv_obs$km$upper[surv_obs$km_names == 3])))), 
            col = adjustcolor("darkgrey", alpha.f = 0.3), border = NA)
  }
  legend("bottomleft", legend = c(misc$group_names, rep("", length(misc$group_names))), 
         col = c(rep("1", misc$ngroups), c("black", "lightgrey", "darkgrey")[1:misc$ngroups]), 
         lty = c(as.integer(c(1, "2222", "5212")[1:misc$ngroups]), rep(1, misc$ngroups)), 
         cex = 0.8, ncol = 2,
         bty = "n")
  
  # annual transition probabilities
  plot(cbind(surv_obs$tp$gr_1$time, surv_obs$tp$gr_1$smooth), lwd = 1, 
       lty = 1, type = "b", cex = 0.6, pch = 1, col = "black", 
       main = "B: Annual transition probability (Weibull non-mixture cure)", 
       xlab = "time", ylab = "annual transition probability (smoothed)", 
       ylim = c(0, ceiling(surv_obs$tp$max * 10)/10), xlim = c(0, ceiling(surv_obs$km$maxtime * 10)/10))
  lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_1[, 19 - if(input$spline_mod == FALSE) {9} else {0}]), 
        col = "2", lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(surv_obs$tp$gr_2$time, surv_obs$tp$gr_2$smooth), 
          col = "lightgrey", type = "b", lwd = 1, cex = 0.6, pch = 8)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_2[, 19 - if(input$spline_mod == FALSE) {9} else {0}]),
          col = "2", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(surv_obs$tp$gr_3$time, surv_obs$tp$gr_3$smooth), 
          col = "darkgrey", type = "b", lwd = 1, cex = 0.6, pch = 9)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_3[, 19 - if(input$spline_mod == FALSE) {9} else {0}]), 
          col = "2", lty = "5212", lwd = 2)
  }
  # add shading confidence intervals
  polygon(c(surv_obs$tp$gr_1$time, rev(surv_obs$tp$gr_1$time)), 
          c(surv_obs$tp$gr_1$smooth_lower, rev(surv_obs$tp$gr_1$smooth_upper)), 
          col = adjustcolor("black", alpha.f = 0.3), border = NA)
  if (misc$ngroups > 1) {
    polygon(c(surv_obs$tp$gr_2$time, rev(surv_obs$tp$gr_2$time)), 
            c(surv_obs$tp$gr_2$smooth_lower, rev(surv_obs$tp$gr_2$smooth_upper)), 
            col = adjustcolor("lightgrey", alpha.f = 0.3), border = NA)
  }
  if (misc$ngroups > 2) {
    polygon(c(surv_obs$tp$gr_3$time, rev(surv_obs$tp$gr_3$time)), 
            c(surv_obs$tp$gr_3$smooth_lower, rev(surv_obs$tp$gr_3$smooth_upper)), 
            col = adjustcolor("darkgrey", alpha.f = 0.3), border = NA)
  }
  legend("topleft", legend = c(misc$group_names, rep("", length(misc$group_names))), 
         col =  c(rep("1", misc$ngroups), c("black", "lightgrey", "darkgrey")[1:misc$ngroups]), 
         lty = c(as.integer(c(1, "2222", "5212")[1:misc$ngroups]), rep(NA, misc$ngroups)),
         pch = c(rep(NA, misc$ngroups), c(1, 8, 9)[1:misc$ngroups]),
         cex = 0.8, ncol = 2,
         bty = "n")
  
  # diagnostics
  plot(cbind(log(surv_obs$km$time), log(-log(surv_obs$km$surv))), cex = 0.6, 
       pch = c(1, 8, 9)[surv_obs$km_names], 
       xlim = c(floor(min(log(surv_obs$km$time)[surv_obs$km$surv != 1])), 
                ceiling(max(log(surv_obs$km$time)))), 
       col = c("black", "lightgrey", "darkgrey")[surv_obs$km_names], 
       main = "C: Diagnostic plot (Weibull non-mixture cure)", 
       xlab = "LN(time)", ylab = "LN(cumulative hazard)")
  lines(cbind(log(input$time_pred), log(-log(surv_pred$model$cure_weib_nmix[, 2]))), 
        col = "2", lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(log(input$time_pred), log(-log(surv_pred$model$cure_weib_nmix[, 3]))), 
          col = "2", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(log(input$time_pred), log(-log(surv_pred$model$cure_weib_nmix[, 4]))), 
          col = "2", lty = "5212", lwd = 2)
  }
  legend("topleft", legend = c(misc$group_names, rep("", length(misc$group_names))), 
         col =  c(rep("1", misc$ngroups), c("black", "lightgrey", "darkgrey")[1:misc$ngroups]), 
         lty = c(as.integer(c(1, "2222", "5212")[1:misc$ngroups]), rep(NA, misc$ngroups)),
         pch = c(rep(NA, misc$ngroups), c(1, 8, 9)[1:misc$ngroups]),
         cex = 0.8, ncol = 2,
         bty = "n")
  
}, envir = PERSUADE)
```

`r if(PERSUADE$input$cure_mod == TRUE) {return("\\newpage")}`

## Mixture cure Log-normal
```{r cure_lnorm_mix, echo=FALSE, out.height = "25%", fig.width=11, eval = PERSUADE$input$cure_mod}
evalq({
  # 1 knot
  plot(surv_obs$km, lwd = 2, main = "A: Kaplan-Meier (Log-normal mixture cure)", 
       xlab = "time", ylab = "survival", col = c("black", "lightgrey", "darkgrey"))
  lines(cbind(input$time_pred, surv_pred$model$cure_lnorm_mix[, 2]), col = "3", lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(input$time_pred, surv_pred$model$cure_lnorm_mix[, 3]), col = "3", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(input$time_pred, surv_pred$model$cure_lnorm_mix[, 4]), col = "3", lty = "5212", lwd = 2)
  }
  # add shading confidence intervals
  polygon(na.omit(data.frame(c(surv_obs$km$time[surv_obs$km_names == 1], rev(surv_obs$km$time[surv_obs$km_names == 1])),
                             c(surv_obs$km$lower[surv_obs$km_names == 1], rev(surv_obs$km$upper[surv_obs$km_names == 1])))), 
          col = adjustcolor("black", alpha.f = 0.3), border = NA)
  if (misc$ngroups > 1) {
    polygon(na.omit(data.frame(c(surv_obs$km$time[surv_obs$km_names == 2], rev(surv_obs$km$time[surv_obs$km_names == 2])),
                               c(surv_obs$km$lower[surv_obs$km_names == 2], rev(surv_obs$km$upper[surv_obs$km_names == 2])))), 
            col = adjustcolor("lightgrey", alpha.f = 0.3), border = NA)
  }
  if (misc$ngroups > 2) {
    polygon(na.omit(data.frame(c(surv_obs$km$time[surv_obs$km_names == 3], rev(surv_obs$km$time[surv_obs$km_names == 3])),
                               c(surv_obs$km$lower[surv_obs$km_names == 3], rev(surv_obs$km$upper[surv_obs$km_names == 3])))), 
            col = adjustcolor("darkgrey", alpha.f = 0.3), border = NA)
  }
  legend("bottomleft", legend = c(misc$group_names, rep("", length(misc$group_names))), 
         col = c(rep("1", misc$ngroups), c("black", "lightgrey", "darkgrey")[1:misc$ngroups]), 
         lty = c(as.integer(c(1, "2222", "5212")[1:misc$ngroups]), rep(1, misc$ngroups)), 
         cex = 0.8, ncol = 2,
         bty = "n")
  
  # annual transition probabilities
  plot(cbind(surv_obs$tp$gr_1$time, surv_obs$tp$gr_1$smooth), lwd = 1, 
       lty = 1, type = "b", cex = 0.6, pch = 1, col = "black", 
       main = "B: Annual transition probability (Log-normal mixture cure)", 
       xlab = "time", ylab = "annual transition probability (smoothed)", 
       ylim = c(0, ceiling(surv_obs$tp$max * 10)/10), xlim = c(0, ceiling(surv_obs$km$maxtime * 10)/10))
  lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_1[, 20 - if(input$spline_mod == FALSE) {9} else {0}]), 
        col = "3", lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(surv_obs$tp$gr_2$time, surv_obs$tp$gr_2$smooth), 
          col = "lightgrey", type = "b", lwd = 1, cex = 0.6, pch = 8)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_2[, 20 - if(input$spline_mod == FALSE) {9} else {0}]),
          col = "3", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(surv_obs$tp$gr_3$time, surv_obs$tp$gr_3$smooth), 
          col = "darkgrey", type = "b", lwd = 1, cex = 0.6, pch = 9)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_3[, 20 - if(input$spline_mod == FALSE) {9} else {0}]),
          col = "3", lty = "5212", lwd = 2)
  }
  # add shading confidence intervals
  polygon(c(surv_obs$tp$gr_1$time, rev(surv_obs$tp$gr_1$time)), 
          c(surv_obs$tp$gr_1$smooth_lower, rev(surv_obs$tp$gr_1$smooth_upper)), 
          col = adjustcolor("black", alpha.f = 0.3), border = NA)
  if (misc$ngroups > 1) {
    polygon(c(surv_obs$tp$gr_2$time, rev(surv_obs$tp$gr_2$time)), 
            c(surv_obs$tp$gr_2$smooth_lower, rev(surv_obs$tp$gr_2$smooth_upper)), 
            col = adjustcolor("lightgrey", alpha.f = 0.3), border = NA)
  }
  if (misc$ngroups > 2) {
    polygon(c(surv_obs$tp$gr_3$time, rev(surv_obs$tp$gr_3$time)), 
            c(surv_obs$tp$gr_3$smooth_lower, rev(surv_obs$tp$gr_3$smooth_upper)), 
            col = adjustcolor("darkgrey", alpha.f = 0.3), border = NA)
  }
  legend("topleft", legend = c(misc$group_names, rep("", length(misc$group_names))), 
         col =  c(rep("1", misc$ngroups), c("black", "lightgrey", "darkgrey")[1:misc$ngroups]), 
         lty = c(as.integer(c(1, "2222", "5212")[1:misc$ngroups]), rep(NA, misc$ngroups)),
         pch = c(rep(NA, misc$ngroups), c(1, 8, 9)[1:misc$ngroups]),
         cex = 0.8, ncol = 2,
         bty = "n")
  
  # diagnostics
  plot(cbind(log(surv_obs$km$time), 
             -qnorm(surv_obs$km$surv, mean = 0, sd = 1, lower.tail = TRUE, log.p = FALSE)), 
       cex = 0.6, main = "C: Diagnostic plot (Log-normal mixture cure)", xlab = "LN(time)", 
       xlim = c(floor(min(log(surv_obs$km$time)[surv_obs$km$surv != 1])), ceiling(max(log(surv_obs$km$time)))),
       pch = c(1, 8, 9)[surv_obs$km_names], col = c("black", "lightgrey", "darkgrey")[surv_obs$km_names], 
       ylab = "- standard normal quartiles")
  lines(cbind(log(input$time_pred), 
              -qnorm(surv_pred$model$cure_lnorm_mix[, 2], mean = 0, sd = 1, lower.tail = TRUE, log.p = FALSE)), 
        col = "3", lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(log(input$time_pred), 
                -qnorm(surv_pred$model$cure_lnorm_mix[, 3], mean = 0, sd = 1, lower.tail = TRUE, log.p = FALSE)),
          col = "3", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(log(input$time_pred), 
                -qnorm(surv_pred$model$cure_lnorm_mix[, 4], mean = 0, sd = 1, lower.tail = TRUE, log.p = FALSE)), 
          col = "3", lty = "5212", lwd = 2)
  }
  legend("topleft", legend = c(misc$group_names, rep("", length(misc$group_names))), 
         col =  c(rep("4", misc$ngroups), c("black", "lightgrey", "darkgrey")[1:misc$ngroups]), 
         lty = c(as.integer(c(1, "2222", "5212")[1:misc$ngroups]), rep(NA, misc$ngroups)),
         pch = c(rep(NA, misc$ngroups), c(1, 8, 9)[1:misc$ngroups]),
         cex = 0.8, ncol = 2,
         bty = "n")
  
}, envir = PERSUADE)
```

`r if(PERSUADE$input$cure_mod == TRUE) {return("\\newpage")}`

## Non-mixture cure Log-normal
```{r cure_lnorm_nmix, echo=FALSE, out.height = "25%", fig.width=11, eval = PERSUADE$input$cure_mod}
evalq({
  # 1 knot
  plot(surv_obs$km, lwd = 2, main = "A: Kaplan-Meier (Log-normal non-mixture cure)", 
       xlab = "time", ylab = "survival", col = c("black", "lightgrey", "darkgrey"))
  lines(cbind(input$time_pred, surv_pred$model$cure_lnorm_nmix[, 2]), col = "4", lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(input$time_pred, surv_pred$model$cure_lnorm_nmix[, 3]), col = "4", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(input$time_pred, surv_pred$model$cure_lnorm_nmix[, 4]), col = "4", lty = "5212", lwd = 2)
  }
  # add shading confidence intervals
  polygon(na.omit(data.frame(c(surv_obs$km$time[surv_obs$km_names == 1], rev(surv_obs$km$time[surv_obs$km_names == 1])),
                             c(surv_obs$km$lower[surv_obs$km_names == 1], rev(surv_obs$km$upper[surv_obs$km_names == 1])))), 
          col = adjustcolor("black", alpha.f = 0.3), border = NA)
  if (misc$ngroups > 1) {
    polygon(na.omit(data.frame(c(surv_obs$km$time[surv_obs$km_names == 2], rev(surv_obs$km$time[surv_obs$km_names == 2])),
                               c(surv_obs$km$lower[surv_obs$km_names == 2], rev(surv_obs$km$upper[surv_obs$km_names == 2])))), 
            col = adjustcolor("lightgrey", alpha.f = 0.3), border = NA)
  }
  if (misc$ngroups > 2) {
    polygon(na.omit(data.frame(c(surv_obs$km$time[surv_obs$km_names == 3], rev(surv_obs$km$time[surv_obs$km_names == 3])),
                               c(surv_obs$km$lower[surv_obs$km_names == 3], rev(surv_obs$km$upper[surv_obs$km_names == 3])))), 
            col = adjustcolor("darkgrey", alpha.f = 0.3), border = NA)
  }
  legend("bottomleft", legend = c(misc$group_names, rep("", length(misc$group_names))), 
         col = c(rep("1", misc$ngroups), c("black", "lightgrey", "darkgrey")[1:misc$ngroups]), 
         lty = c(as.integer(c(1, "2222", "5212")[1:misc$ngroups]), rep(1, misc$ngroups)), 
         cex = 0.8, ncol = 2,
         bty = "n")
  
  # annual transition probabilities
  plot(cbind(surv_obs$tp$gr_1$time, surv_obs$tp$gr_1$smooth), lwd = 1, 
       lty = 1, type = "b", cex = 0.6, pch = 1, col = "black", 
       main = "B: Annual transition probability (Log-normal non-mixture cure)", 
       xlab = "time", ylab = "annual transition probability (smoothed)", 
       ylim = c(0, ceiling(surv_obs$tp$max * 10)/10), xlim = c(0, ceiling(surv_obs$km$maxtime * 10)/10))
  lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_1[, 21 - if(input$spline_mod == FALSE) {9} else {0}]),
        col = "4", lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(surv_obs$tp$gr_2$time, surv_obs$tp$gr_2$smooth), 
          col = "lightgrey", type = "b", lwd = 1, cex = 0.6, pch = 8)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_2[, 21 - if(input$spline_mod == FALSE) {9} else {0}]), 
          col = "4", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(surv_obs$tp$gr_3$time, surv_obs$tp$gr_3$smooth), 
          col = "darkgrey", type = "b", lwd = 1, cex = 0.6, pch = 9)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_3[, 21 - if(input$spline_mod == FALSE) {9} else {0}]), 
          col = "4", lty = "5212", lwd = 2)
  }
  # add shading confidence intervals
  polygon(c(surv_obs$tp$gr_1$time, rev(surv_obs$tp$gr_1$time)), 
          c(surv_obs$tp$gr_1$smooth_lower, rev(surv_obs$tp$gr_1$smooth_upper)), 
          col = adjustcolor("black", alpha.f = 0.3), border = NA)
  if (misc$ngroups > 1) {
    polygon(c(surv_obs$tp$gr_2$time, rev(surv_obs$tp$gr_2$time)), 
            c(surv_obs$tp$gr_2$smooth_lower, rev(surv_obs$tp$gr_2$smooth_upper)), 
            col = adjustcolor("lightgrey", alpha.f = 0.3), border = NA)
  }
  if (misc$ngroups > 2) {
    polygon(c(surv_obs$tp$gr_3$time, rev(surv_obs$tp$gr_3$time)), 
            c(surv_obs$tp$gr_3$smooth_lower, rev(surv_obs$tp$gr_3$smooth_upper)), 
            col = adjustcolor("darkgrey", alpha.f = 0.3), border = NA)
  }
  legend("topleft", legend = c(misc$group_names, rep("", length(misc$group_names))), 
         col =  c(rep("1", misc$ngroups), c("black", "lightgrey", "darkgrey")[1:misc$ngroups]), 
         lty = c(as.integer(c(1, "2222", "5212")[1:misc$ngroups]), rep(NA, misc$ngroups)),
         pch = c(rep(NA, misc$ngroups), c(1, 8, 9)[1:misc$ngroups]),
         cex = 0.8, ncol = 2,
         bty = "n")
  
  # diagnostics
  plot(cbind(log(surv_obs$km$time), 
             -qnorm(surv_obs$km$surv, mean = 0, sd = 1, lower.tail = TRUE, log.p = FALSE)), 
       cex = 0.6, main = "C: Diagnostic plot (Log-normal non-mixture cure)", xlab = "LN(time)", 
       xlim = c(floor(min(log(surv_obs$km$time)[surv_obs$km$surv != 1])), ceiling(max(log(surv_obs$km$time)))),
       pch = c(1, 8, 9)[surv_obs$km_names], col = c("black", "lightgrey", "darkgrey")[surv_obs$km_names], 
       ylab = "- standard normal quartiles")
  lines(cbind(log(input$time_pred), 
              -qnorm(surv_pred$model$cure_lnorm_nmix[, 2], mean = 0, sd = 1, lower.tail = TRUE, log.p = FALSE)), 
        col = "4", lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(log(input$time_pred), 
                -qnorm(surv_pred$model$cure_lnorm_nmix[, 3], mean = 0, sd = 1, lower.tail = TRUE, log.p = FALSE)),
          col = "4", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(log(input$time_pred), 
                -qnorm(surv_pred$model$cure_lnorm_nmix[, 4], mean = 0, sd = 1, lower.tail = TRUE, log.p = FALSE)), 
          col = "4", lty = "5212", lwd = 2)
  }
  legend("topleft", legend = c(misc$group_names, rep("", length(misc$group_names))), 
         col =  c(rep("4", misc$ngroups), c("black", "lightgrey", "darkgrey")[1:misc$ngroups]), 
         lty = c(as.integer(c(1, "2222", "5212")[1:misc$ngroups]), rep(NA, misc$ngroups)),
         pch = c(rep(NA, misc$ngroups), c(1, 8, 9)[1:misc$ngroups]),
         cex = 0.8, ncol = 2,
         bty = "n")
  
}, envir = PERSUADE)
```

`r if(PERSUADE$input$cure_mod == TRUE) {return("\\newpage")}`

## Mixture cure Log-logistic
```{r cure_llog_mix, echo=FALSE, out.height = "25%", fig.width=11, eval = PERSUADE$input$cure_mod}
evalq({
  # 1 knot
  plot(surv_obs$km, lwd = 2, main = "A: Kaplan-Meier (Log-logistic mixture cure)", 
       xlab = "time", ylab = "survival", col = c("black", "lightgrey", "darkgrey"))
  lines(cbind(input$time_pred, surv_pred$model$cure_llog_mix[, 2]), col = "5", lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(input$time_pred, surv_pred$model$cure_llog_mix[, 3]), col = "5", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(input$time_pred, surv_pred$model$cure_llog_mix[, 4]), col = "5", lty = "5212", lwd = 2)
  }
  # add shading confidence intervals
  polygon(na.omit(data.frame(c(surv_obs$km$time[surv_obs$km_names == 1], rev(surv_obs$km$time[surv_obs$km_names == 1])),
                             c(surv_obs$km$lower[surv_obs$km_names == 1], rev(surv_obs$km$upper[surv_obs$km_names == 1])))), 
          col = adjustcolor("black", alpha.f = 0.3), border = NA)
  if (misc$ngroups > 1) {
    polygon(na.omit(data.frame(c(surv_obs$km$time[surv_obs$km_names == 2], rev(surv_obs$km$time[surv_obs$km_names == 2])),
                               c(surv_obs$km$lower[surv_obs$km_names == 2], rev(surv_obs$km$upper[surv_obs$km_names == 2])))), 
            col = adjustcolor("lightgrey", alpha.f = 0.3), border = NA)
  }
  if (misc$ngroups > 2) {
    polygon(na.omit(data.frame(c(surv_obs$km$time[surv_obs$km_names == 3], rev(surv_obs$km$time[surv_obs$km_names == 3])),
                               c(surv_obs$km$lower[surv_obs$km_names == 3], rev(surv_obs$km$upper[surv_obs$km_names == 3])))), 
            col = adjustcolor("darkgrey", alpha.f = 0.3), border = NA)
  }
  legend("bottomleft", legend = c(misc$group_names, rep("", length(misc$group_names))), 
         col = c(rep("1", misc$ngroups), c("black", "lightgrey", "darkgrey")[1:misc$ngroups]), 
         lty = c(as.integer(c(1, "2222", "5212")[1:misc$ngroups]), rep(1, misc$ngroups)), 
         cex = 0.8, ncol = 2,
         bty = "n")
  
  # annual transition probabilities
  plot(cbind(surv_obs$tp$gr_1$time, surv_obs$tp$gr_1$smooth), lwd = 1, 
       lty = 1, type = "b", cex = 0.6, pch = 1, col = "black", 
       main = "B: Annual transition probability (Log-logistic mixture cure)", 
       xlab = "time", ylab = "annual transition probability (smoothed)", 
       ylim = c(0, ceiling(surv_obs$tp$max * 10)/10), xlim = c(0, ceiling(surv_obs$km$maxtime * 10)/10))
  lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_1[, 22 - if(input$spline_mod == FALSE) {9} else {0}]),
        col = "5", lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(surv_obs$tp$gr_2$time, surv_obs$tp$gr_2$smooth), 
          col = "lightgrey", type = "b", lwd = 1, cex = 0.6, pch = 8)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_2[, 22 - if(input$spline_mod == FALSE) {9} else {0}]), 
          col = "5", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(surv_obs$tp$gr_3$time, surv_obs$tp$gr_3$smooth), 
          col = "darkgrey", type = "b", lwd = 1, cex = 0.6, pch = 9)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_3[, 22 - if(input$spline_mod == FALSE) {9} else {0}]), 
          col = "5", lty = "5212", lwd = 2)
  }
  # add shading confidence intervals
  polygon(c(surv_obs$tp$gr_1$time, rev(surv_obs$tp$gr_1$time)), 
          c(surv_obs$tp$gr_1$smooth_lower, rev(surv_obs$tp$gr_1$smooth_upper)), 
          col = adjustcolor("black", alpha.f = 0.3), border = NA)
  if (misc$ngroups > 1) {
    polygon(c(surv_obs$tp$gr_2$time, rev(surv_obs$tp$gr_2$time)), 
            c(surv_obs$tp$gr_2$smooth_lower, rev(surv_obs$tp$gr_2$smooth_upper)), 
            col = adjustcolor("lightgrey", alpha.f = 0.3), border = NA)
  }
  if (misc$ngroups > 2) {
    polygon(c(surv_obs$tp$gr_3$time, rev(surv_obs$tp$gr_3$time)), 
            c(surv_obs$tp$gr_3$smooth_lower, rev(surv_obs$tp$gr_3$smooth_upper)), 
            col = adjustcolor("darkgrey", alpha.f = 0.3), border = NA)
  }
  legend("topleft", legend = c(misc$group_names, rep("", length(misc$group_names))), 
         col =  c(rep("1", misc$ngroups), c("black", "lightgrey", "darkgrey")[1:misc$ngroups]), 
         lty = c(as.integer(c(1, "2222", "5212")[1:misc$ngroups]), rep(NA, misc$ngroups)),
         pch = c(rep(NA, misc$ngroups), c(1, 8, 9)[1:misc$ngroups]),
         cex = 0.8, ncol = 2,
         bty = "n")
  
  # diagnostics
  plot(cbind(log(surv_obs$km$time), -log(surv_obs$km$surv/(1 - surv_obs$km$surv))), 
       cex = 0.6, pch = c(1, 8, 9)[surv_obs$km_names], 
       col = c("black", "lightgrey", "darkgrey")[surv_obs$km_names],
       xlim = c(floor(min(log(surv_obs$km$time)[surv_obs$km$surv != 1])), 
                ceiling(max(log(surv_obs$km$time)))), main = "C: Diagnostic plot (Log-logistic mixture cure)", 
       xlab = "LN(time)", ylab = "-LN(survival odds)")
  
  lines(cbind(log(input$time_pred), 
              -log(surv_pred$model$cure_llog_mix[, 2]/(1 - surv_pred$model$cure_llog_mix[, 2]))),
        col = "5", lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(log(input$time_pred), 
                -log(surv_pred$model$cure_llog_mix[, 3]/(1 - surv_pred$model$cure_llog_mix[, 3]))), 
          col = "5", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(log(input$time_pred), 
                -log(surv_pred$model$cure_llog_mix[, 4]/(1 - surv_pred$model$cure_llog_mix[, 4]))),
          col = "5", lty = "5212", lwd = 2)
  }
  legend("topleft", legend = c(misc$group_names, rep("", length(misc$group_names))), 
         col =  c(rep("5", misc$ngroups), c("black", "lightgrey", "darkgrey")[1:misc$ngroups]), 
         lty = c(as.integer(c(1, "2222", "5212")[1:misc$ngroups]), rep(NA, misc$ngroups)),
         pch = c(rep(NA, misc$ngroups), c(1, 8, 9)[1:misc$ngroups]),
         cex = 0.8, ncol = 2,
         bty = "n")
  
}, envir = PERSUADE)
```

`r if(PERSUADE$input$cure_mod == TRUE) {return("\\newpage")}`

## Non-mixture cure Log-logistic
```{r cure_llog_nmix, echo=FALSE, out.height = "25%", fig.width=11, eval = PERSUADE$input$cure_mod}
evalq({
  # 1 knot
  plot(surv_obs$km, lwd = 2, main = "A: Kaplan-Meier (Log-logistic non-mixture cure)", 
       xlab = "time", ylab = "survival", col = c("black", "lightgrey", "darkgrey"))
  lines(cbind(input$time_pred, surv_pred$model$cure_llog_nmix[, 2]), col = "6", lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(input$time_pred, surv_pred$model$cure_llog_nmix[, 3]), col = "6", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(input$time_pred, surv_pred$model$cure_llog_nmix[, 4]), col = "6", lty = "5212", lwd = 2)
  }
  # add shading confidence intervals
  polygon(na.omit(data.frame(c(surv_obs$km$time[surv_obs$km_names == 1], rev(surv_obs$km$time[surv_obs$km_names == 1])),
                             c(surv_obs$km$lower[surv_obs$km_names == 1], rev(surv_obs$km$upper[surv_obs$km_names == 1])))), 
          col = adjustcolor("black", alpha.f = 0.3), border = NA)
  if (misc$ngroups > 1) {
    polygon(na.omit(data.frame(c(surv_obs$km$time[surv_obs$km_names == 2], rev(surv_obs$km$time[surv_obs$km_names == 2])),
                               c(surv_obs$km$lower[surv_obs$km_names == 2], rev(surv_obs$km$upper[surv_obs$km_names == 2])))), 
            col = adjustcolor("lightgrey", alpha.f = 0.3), border = NA)
  }
  if (misc$ngroups > 2) {
    polygon(na.omit(data.frame(c(surv_obs$km$time[surv_obs$km_names == 3], rev(surv_obs$km$time[surv_obs$km_names == 3])),
                               c(surv_obs$km$lower[surv_obs$km_names == 3], rev(surv_obs$km$upper[surv_obs$km_names == 3])))), 
            col = adjustcolor("darkgrey", alpha.f = 0.3), border = NA)
  }
  legend("bottomleft", legend = c(misc$group_names, rep("", length(misc$group_names))), 
         col = c(rep("1", misc$ngroups), c("black", "lightgrey", "darkgrey")[1:misc$ngroups]), 
         lty = c(as.integer(c(1, "2222", "5212")[1:misc$ngroups]), rep(1, misc$ngroups)), 
         cex = 0.8, ncol = 2,
         bty = "n")
  
  # annual transition probabilities
  plot(cbind(surv_obs$tp$gr_1$time, surv_obs$tp$gr_1$smooth), lwd = 1, 
       lty = 1, type = "b", cex = 0.6, pch = 1, col = "black", 
       main = "B: Annual transition probability (Log-logistic non-mixture cure)", 
       xlab = "time", ylab = "annual transition probability (smoothed)", 
       ylim = c(0, ceiling(surv_obs$tp$max * 10)/10), xlim = c(0, ceiling(surv_obs$km$maxtime * 10)/10))
  lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_1[, 23 - if(input$spline_mod == FALSE) {9} else {0}]), 
        col = "6", lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(surv_obs$tp$gr_2$time, surv_obs$tp$gr_2$smooth), 
          col = "lightgrey", type = "b", lwd = 1, cex = 0.6, pch = 8)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_2[, 23 - if(input$spline_mod == FALSE) {9} else {0}]), 
          col = "6", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(surv_obs$tp$gr_3$time, surv_obs$tp$gr_3$smooth), 
          col = "darkgrey", type = "b", lwd = 1, cex = 0.6, pch = 9)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_3[, 23 - if(input$spline_mod == FALSE) {9} else {0}]), 
          col = "6", lty = "5212", lwd = 2)
  }
  # add shading confidence intervals
  polygon(c(surv_obs$tp$gr_1$time, rev(surv_obs$tp$gr_1$time)), 
          c(surv_obs$tp$gr_1$smooth_lower, rev(surv_obs$tp$gr_1$smooth_upper)), 
          col = adjustcolor("black", alpha.f = 0.3), border = NA)
  if (misc$ngroups > 1) {
    polygon(c(surv_obs$tp$gr_2$time, rev(surv_obs$tp$gr_2$time)), 
            c(surv_obs$tp$gr_2$smooth_lower, rev(surv_obs$tp$gr_2$smooth_upper)), 
            col = adjustcolor("lightgrey", alpha.f = 0.3), border = NA)
  }
  if (misc$ngroups > 2) {
    polygon(c(surv_obs$tp$gr_3$time, rev(surv_obs$tp$gr_3$time)), 
            c(surv_obs$tp$gr_3$smooth_lower, rev(surv_obs$tp$gr_3$smooth_upper)), 
            col = adjustcolor("darkgrey", alpha.f = 0.3), border = NA)
  }
  legend("topleft", legend = c(misc$group_names, rep("", length(misc$group_names))), 
         col =  c(rep("1", misc$ngroups), c("black", "lightgrey", "darkgrey")[1:misc$ngroups]), 
         lty = c(as.integer(c(1, "2222", "5212")[1:misc$ngroups]), rep(NA, misc$ngroups)),
         pch = c(rep(NA, misc$ngroups), c(1, 8, 9)[1:misc$ngroups]),
         cex = 0.8, ncol = 2,
         bty = "n")
  
  # diagnostics
  plot(cbind(log(surv_obs$km$time), -log(surv_obs$km$surv/(1 - surv_obs$km$surv))), 
       cex = 0.6, pch = c(1, 8, 9)[surv_obs$km_names], 
       col = c("black", "lightgrey", "darkgrey")[surv_obs$km_names],
       xlim = c(floor(min(log(surv_obs$km$time)[surv_obs$km$surv != 1])), 
                ceiling(max(log(surv_obs$km$time)))), main = "C: Diagnostic plot (Log-logistic non-mixture cure)", 
       xlab = "LN(time)", ylab = "-LN(survival odds)")
  
  lines(cbind(log(input$time_pred), 
              -log(surv_pred$model$cure_llog_nmix[, 2]/(1 - surv_pred$model$cure_llog_nmix[, 2]))),
        col = "6", lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(log(input$time_pred), 
                -log(surv_pred$model$cure_llog_nmix[, 3]/(1 - surv_pred$model$cure_llog_nmix[, 3]))), 
          col = "6", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(log(input$time_pred), 
                -log(surv_pred$model$cure_llog_nmix[, 4]/(1 - surv_pred$model$cure_llog_nmix[, 4]))),
          col = "6", lty = "5212", lwd = 2)
  }
  legend("topleft", legend = c(misc$group_names, rep("", length(misc$group_names))), 
         col =  c(rep("5", misc$ngroups), c("black", "lightgrey", "darkgrey")[1:misc$ngroups]), 
         lty = c(as.integer(c(1, "2222", "5212")[1:misc$ngroups]), rep(NA, misc$ngroups)),
         pch = c(rep(NA, misc$ngroups), c(1, 8, 9)[1:misc$ngroups]),
         cex = 0.8, ncol = 2,
         bty = "n")
}, envir = PERSUADE)
```




\newpage

# Long-term extrapolation

The plausibility of the estimated survival beyond the oberseved data period should be considered and is typically an influential aspect of health economic models. This includes considering model(s) is/are more appropriate/plausible for long-term extrapolation when compared to external data (including general population mortality)?  
In this section, the estimated survival probabilities for the period of time within and beyond data collection, i.e. the extrapolation are presented (can be specified by the user). This is done by 1) plotting the survival curves (Figures A, B and C), 2) displaying the survival probabilities at multiple time points (first Table), 3) ploting annual transition probabilities (Figures D, E and F), 3) ploting the smoothed hazard functions (Figures G, H and I), and providing the summary statistics of the estimated annual transition probabilities (second Table). This information is provided for each group separately.  
One way to assess the plausibility of the extrapolated survival probabilities is to compare the estimated survival probabilities at different time points with external data (e.g. observational data and/or expert opinion). Another way to check for plausibility is to compare the annual transition probability with those observed in the general population (general population mortality can be obtained through national statistics). Parametric survival models annual conditional transition probabilities more favourable than those observed for the general population may not be plausible. This would require either to select an alternative parametric survival model or to adjust the selected parametric survival model for general population probabilities.  

\newpage

## `r paste("Group", PERSUADE$misc$group_names[1])`
```{r validate_extrapolation1, echo=FALSE, out.height = "29%", fig.width=11, comment=NA}
evalq({
  # parametric curves
  plot(surv_obs$km[1], lwd = 2, col = "black", main = "A: Kaplan-Meier (parametric curves)", 
       xlab = "time", ylab = "survival", xlim = c(0, input$time_horizon))
  lines(cbind(input$time_pred, surv_pred$model$expo[, 2]), col = "1", lty = 1, lwd = 1)
  lines(cbind(input$time_pred, surv_pred$model$weib[, 2]), col = "2", lty = 1, lwd = 1)
  lines(cbind(input$time_pred, surv_pred$model$gom[, 2]), col = "3", lty = 1, lwd = 1)
  lines(cbind(input$time_pred, surv_pred$model$lnorm[, 2]), col = "4", lty = 1, lwd = 1)
  lines(cbind(input$time_pred, surv_pred$model$llog[, 2]), col = "5", lty = 1, lwd = 1)
  lines(cbind(input$time_pred, surv_pred$model$gam[, 2]), col = "6", lty = 1, lwd = 1)
  lines(cbind(input$time_pred, surv_pred$model$ggam[, 2]), col = "7", lty = 1, lwd = 1)
  legend("topright", legend = misc$lbls, col = 1:7, lty = 1, cex = 0.8)
  # spline curves
  if (input$spline_mod == TRUE) {
    plot(surv_obs$km[1], lwd = 2, col = "black", main = "B: Kaplan-Meier (spline curves)", 
         xlab = "time", ylab = "survival", xlim = c(0, input$time_horizon))
    lines(cbind(input$time_pred, surv_pred$model$spl_hazard1[, 2]), col = "1", lty = 1, lwd = 1)
    lines(cbind(input$time_pred, surv_pred$model$spl_hazard2[, 2]), col = "2", lty = 1, lwd = 1)
    lines(cbind(input$time_pred, surv_pred$model$spl_hazard3[, 2]), col = "3", lty = 1, lwd = 1)
    lines(cbind(input$time_pred, surv_pred$model$spl_odds1[, 2]), col = "4", lty = 1, lwd = 1)
    lines(cbind(input$time_pred, surv_pred$model$spl_odds2[, 2]), col = "5", lty = 1, lwd = 1)
    lines(cbind(input$time_pred, surv_pred$model$spl_odds3[, 2]), col = "6", lty = 1, lwd = 1)
    lines(cbind(input$time_pred, surv_pred$model$spl_normal1[, 2]), col = "7", lty = 1, lwd = 1)
    lines(cbind(input$time_pred, surv_pred$model$spl_normal2[, 2]), col = "8", lty = 1, lwd = 1)
    lines(cbind(input$time_pred, surv_pred$model$spl_normal3[, 2]), col = "9", lty = 1, lwd = 1)
    legend("topright", legend = misc$lbls_spline, col = 1:9, lty = 1, cex = 0.8)
  }
  # cure curves
  if (input$cure_mod == TRUE) {
    plot(surv_obs$km[1], lwd = 2, col = "black", main = "C: Kaplan-Meier (cure curves)", 
         xlab = "time", ylab = "survival", xlim = c(0, input$time_horizon))
    lines(cbind(input$time_pred, surv_pred$model$cure_weib_mix[, 2]), col = "1", lty = 1, lwd = 1)
    lines(cbind(input$time_pred, surv_pred$model$cure_weib_nmix[, 2]), col = "2", lty = 1, lwd = 1)
    lines(cbind(input$time_pred, surv_pred$model$cure_lnorm_mix[, 2]), col = "3", lty = 1, lwd = 1)
    lines(cbind(input$time_pred, surv_pred$model$cure_lnorm_nmix[, 2]), col = "4", lty = 1, lwd = 1)
    lines(cbind(input$time_pred, surv_pred$model$cure_llog_mix[, 2]), col = "5", lty = 1, lwd = 1)
    lines(cbind(input$time_pred, surv_pred$model$cure_llog_nmix[, 2]), col = "6", lty = 1, lwd = 1)
    legend("topright", legend = misc$lbls_cure, col = 1:6, lty = 1, cex = 0.8)
  }
  
}, envir = PERSUADE)
kable_styling(kable(t(round(
  PERSUADE$surv_pred$gr$gr_1[1 + PERSUADE$input$time_pred_surv_table, ], 3))[-1, ], 
  col.names = paste("T=", PERSUADE$surv_pred$gr$gr_1[1 + PERSUADE$input$time_pred_surv_table, ][, 1]), 
  format = "latex", booktabs = TRUE, 
  linesep = "", caption = "Survival probability at different time points"), latex_options = c("scale_down", "striped"), position = "left")

evalq({
  # parametric curves
  plot(cbind(surv_obs$tp$gr_1$time, surv_obs$tp$gr_1$smooth), 
       main = "D: Annual transition probability (parametric curves)", 
       xlab = "time", ylab = "annual transition probability", ylim = c(0, 1), 
       xlim = c(0, input$time_horizon), col = "black", type = "l", lwd = 2)
  lines(cbind(surv_obs$tp$gr_1$time, surv_obs$tp$gr_1$smooth_lower), 
        col = "black", type = "l", lwd = 2, lty = 2)
  lines(cbind(surv_obs$tp$gr_1$time, surv_obs$tp$gr_1$smooth_upper), 
        col = "black", type = "l", lwd = 2, lty = 2)
  lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_1[, 2]), col = "1", lty = 1, lwd = 1)
  lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_1[, 3]), col = "2", lty = 1, lwd = 1)
  lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_1[, 4]), col = "3", lty = 1, lwd = 1)
  lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_1[, 5]), col = "4", lty = 1, lwd = 1)
  lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_1[, 6]), col = "5", lty = 1, lwd = 1)
  lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_1[, 7]), col = "6", lty = 1, lwd = 1)
  lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_1[, 8]), col = "7", lty = 1, lwd = 1)
  legend("topleft", legend = misc$lbls, col = 1:7, lty = 1, cex = 0.8)
  # spline curves
  if (input$spline_mod == TRUE) {
    plot(cbind(surv_obs$tp$gr_1$time, surv_obs$tp$gr_1$smooth), 
         main = "E: Annual transition probability (spline curves)", xlab = "time", 
         ylab = "annual transition probability", ylim = c(0, 1), xlim = c(0, input$time_horizon), 
         col = "black", type = "l", lwd = 2)
    lines(cbind(surv_obs$tp$gr_1$time, surv_obs$tp$gr_1$smooth_lower), 
          col = "black", type = "l", lwd = 2, lty = 2)
    lines(cbind(surv_obs$tp$gr_1$time, surv_obs$tp$gr_1$smooth_upper), 
          col = "black", type = "l", lwd = 2, lty = 2)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_1[, 9]), col = "1", lty = 1, lwd = 1)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_1[, 10]), col = "2", lty = 1, lwd = 1)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_1[, 11]), col = "3", lty = 1, lwd = 1)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_1[, 12]), col = "4", lty = 1, lwd = 1)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_1[, 13]), col = "5", lty = 1, lwd = 1)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_1[, 14]), col = "6", lty = 1, lwd = 1)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_1[, 15]), col = "7", lty = 1, lwd = 1)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_1[, 16]), col = "8", lty = 1, lwd = 1)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_1[, 17]), col = "9", lty = 1, lwd = 1)
    legend("topleft", legend = misc$lbls_spline, col = 1:9, lty = 1, cex = 0.8)
  }
  # cure curves
  if (input$cure_mod == TRUE) {
    plot(cbind(surv_obs$tp$gr_1$time, surv_obs$tp$gr_1$smooth), 
         main = "F: Annual transition probability (cure curves)", xlab = "time", 
         ylab = "annual transition probability", ylim = c(0, 1), xlim = c(0, input$time_horizon), 
         col = "black", type = "l", lwd = 2)
    lines(cbind(surv_obs$tp$gr_1$time, surv_obs$tp$gr_1$smooth_lower), 
          col = "black", type = "l", lwd = 2, lty = 2)
    lines(cbind(surv_obs$tp$gr_1$time, surv_obs$tp$gr_1$smooth_upper), 
          col = "black", type = "l", lwd = 2, lty = 2)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_1[, 18 - if(input$spline_mod == FALSE) {9} else {0}]), 
          col = "1", lty = 1, lwd = 1)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_1[, 19 - if(input$spline_mod == FALSE) {9} else {0}]), 
          col = "2", lty = 1, lwd = 1)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_1[, 20 - if(input$spline_mod == FALSE) {9} else {0}]), 
          col = "3", lty = 1, lwd = 1)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_1[, 21 - if(input$spline_mod == FALSE) {9} else {0}]), 
          col = "4", lty = 1, lwd = 1)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_1[, 22 - if(input$spline_mod == FALSE) {9} else {0}]), 
          col = "5", lty = 1, lwd = 1)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_1[, 23 - if(input$spline_mod == FALSE) {9} else {0}]), 
          col = "6", lty = 1, lwd = 1)
    legend("topleft", legend = misc$lbls_cure, col = 1:6, lty = 1, cex = 0.8)
  }
}, envir = PERSUADE)
suppressWarnings(kable_styling(kable(descr(
  PERSUADE$surv_pred$tp_gr$gr_1[, 2:PERSUADE$misc$cols_tp], stats = c("mean", "sd", "min", "q1", "med", "q3", "max", "iqr"), transpose = TRUE), 
  format = "latex", booktabs = TRUE, linesep = "", caption = "Summary statistics of annual transition probabilities"), 
  latex_options = c("scale_down", "striped"), position = "left"))

evalq({
  plot(cbind(surv_obs$haz$smooth_gr1$est.grid, surv_obs$haz$smooth_gr1$haz.est),
       main = "G: Hazard function (parametric curves)", 
       type = "l", col = "black", lty = 1, lwd = 2, xlab = "time", ylab = "smoothed hazard rate", 
       xlim = c(0, input$time_horizon), ylim = c(0, surv_obs$haz$max$smooth))
  lines(cbind(surv_pred$model$expo_h[[1]]$time, surv_pred$model$expo_h[[1]]$est), 
        col = "1", lty = 1, lwd = 1)
  lines(cbind(surv_pred$model$weib_h[[1]]$time, surv_pred$model$weib_h[[1]]$est), 
        col = "2", lty = 1, lwd = 1)
  lines(cbind(surv_pred$model$gom_h[[1]]$time, surv_pred$model$gom_h[[1]]$est), 
        col = "3", lty = 1, lwd = 1)
  lines(cbind(surv_pred$model$lnorm_h[[1]]$time, surv_pred$model$lnorm_h[[1]]$est), 
        col = "4", lty = 1, lwd = 1)
  lines(cbind(surv_pred$model$llog_h[[1]]$time, surv_pred$model$llog_h[[1]]$est), 
        col = "5", lty = 1, lwd = 1)
  lines(cbind(surv_pred$model$gam_h[[1]]$time, surv_pred$model$gam_h[[1]]$est), 
        col = "6", lty = 1, lwd = 1)
  lines(cbind(surv_pred$model$ggam_h[[1]]$time, surv_pred$model$ggam_h[[1]]$est), 
        col = "7", lty = 1, lwd = 1)
  legend("topleft", legend = misc$lbls, col = 1:7, lty = 1, cex = 0.8)
  
  if (input$spline_mod == TRUE) {
    plot(cbind(surv_obs$haz$smooth_gr1$est.grid, surv_obs$haz$smooth_gr1$haz.est),
         main = "H: Hazard function (spline curves)",
         type = "l", col = "black", lty = 1, lwd = 2, xlab = "time", ylab = "smoothed hazard rate", 
         xlim = c(0, input$time_horizon), ylim = c(0, surv_obs$haz$max$smooth))
    lines(cbind(surv_pred$model$spl_hazard1_h[[1]]$time, surv_pred$model$spl_hazard1_h[[1]]$est), 
          col = "1", lty = 1, lwd = 1)
    lines(cbind(surv_pred$model$spl_hazard2_h[[1]]$time, surv_pred$model$spl_hazard2_h[[1]]$est), 
          col = "2", lty = 1, lwd = 1)
    lines(cbind(surv_pred$model$spl_hazard3_h[[1]]$time, surv_pred$model$spl_hazard3_h[[1]]$est), 
          col = "3", lty = 1, lwd = 1)
    lines(cbind(surv_pred$model$spl_odds1_h[[1]]$time, surv_pred$model$spl_odds1_h[[1]]$est), 
          col = "4", lty = 1, lwd = 1)
    lines(cbind(surv_pred$model$spl_odds2_h[[1]]$time, surv_pred$model$spl_odds2_h[[1]]$est), 
          col = "5", lty = 1, lwd = 1)
    lines(cbind(surv_pred$model$spl_odds3_h[[1]]$time, surv_pred$model$spl_odds3_h[[1]]$est), 
          col = "6", lty = 1, lwd = 1)
    lines(cbind(surv_pred$model$spl_normal1_h[[1]]$time, surv_pred$model$spl_normal1_h[[1]]$est), 
          col = "7", lty = 1, lwd = 1)
    lines(cbind(surv_pred$model$spl_normal2_h[[1]]$time, surv_pred$model$spl_normal2_h[[1]]$est), 
          col = "8", lty = 1, lwd = 1)
    lines(cbind(surv_pred$model$spl_normal3_h[[1]]$time, surv_pred$model$spl_normal3_h[[1]]$est), 
          col = "9", lty = 1, lwd = 1)
    legend("topleft", legend = misc$lbls_spline, col = 1:9, lty = 1, cex = 0.8)
  }
  
  if (input$cure_mod == TRUE) {
    plot(cbind(surv_obs$haz$smooth_gr1$est.grid, surv_obs$haz$smooth_gr1$haz.est),
         main = "I: Hazard function (cure curves)",
         type = "l", col = "black", lty = 1, lwd = 2, xlab = "time", ylab = "smoothed hazard rate", 
         xlim = c(0, input$time_horizon), ylim = c(0, surv_obs$haz$max$smooth))
    lines(cbind(surv_pred$model$cure_weib_mix_h[, 1], surv_pred$model$cure_weib_mix_h[,2]), 
          col = "1", lty = 1, lwd = 1)
    lines(cbind(surv_pred$model$cure_weib_nmix_h[, 1], surv_pred$model$cure_weib_nmix_h[,2]), 
          col = "2", lty = 1, lwd = 1)
    lines(cbind(surv_pred$model$cure_lnorm_mix_h[, 1], surv_pred$model$cure_lnorm_mix_h[,2]), 
          col = "3", lty = 1, lwd = 1)
    lines(cbind(surv_pred$model$cure_lnorm_nmix_h[, 1], surv_pred$model$cure_lnorm_nmix_h[,2]), 
          col = "4", lty = 1, lwd = 1)
    lines(cbind(surv_pred$model$cure_llog_mix_h[, 1], surv_pred$model$cure_llog_mix_h[,2]), 
          col = "5", lty = 1, lwd = 1)
    lines(cbind(surv_pred$model$cure_llog_nmix_h[, 1], surv_pred$model$cure_llog_nmix_h[,2]), 
          col = "6", lty = 1, lwd = 1)
    legend("topleft", legend = misc$lbls_cure, col = 1:9, lty = 1, cex = 0.8)
  }
  
}, envir = PERSUADE)
```

\newpage

## `r paste("Group", PERSUADE$misc$group_names[2])`
```{r validate_extrapolation2, echo=FALSE, out.height = "29%", fig.width=11, eval=if (PERSUADE$misc$ngroups>1) {TRUE} else {FALSE}, comment=NA}
evalq({
  # parametric curves
  plot(surv_obs$km[2], lwd = 2, col = "black", main = "A: Kaplan-Meier (parametric curves)", 
       xlab = "time", ylab = "survival", xlim = c(0, input$time_horizon))
  lines(cbind(input$time_pred, surv_pred$model$expo[, 3]), col = "1", lty = "2222", lwd = 1)
  lines(cbind(input$time_pred, surv_pred$model$weib[, 3]), col = "2", lty = "2222", lwd = 1)
  lines(cbind(input$time_pred, surv_pred$model$gom[, 3]), col = "3", lty = "2222", lwd = 1)
  lines(cbind(input$time_pred, surv_pred$model$lnorm[, 3]), col = "4", lty = "2222", lwd = 1)
  lines(cbind(input$time_pred, surv_pred$model$llog[, 3]), col = "5", lty = "2222", lwd = 1)
  lines(cbind(input$time_pred, surv_pred$model$gam[, 3]), col = "6", lty = "2222", lwd = 1)
  lines(cbind(input$time_pred, surv_pred$model$ggam[, 3]), col = "7", lty = "2222", lwd = 1)
  legend("topright", legend = misc$lbls, col = 1:7, lty = "2222", cex = 0.8)
  # spline curves
  if (input$spline_mod == TRUE) {
    plot(surv_obs$km[2], lwd = 2, col = "black", main = "B: Kaplan-Meier (spline curves)", 
         xlab = "time", ylab = "survival", xlim = c(0, input$time_horizon))
    lines(cbind(input$time_pred, surv_pred$model$spl_hazard1[, 3]), col = "1", lty = "2222", lwd = 1)
    lines(cbind(input$time_pred, surv_pred$model$spl_hazard2[, 3]), col = "2", lty = "2222", lwd = 1)
    lines(cbind(input$time_pred, surv_pred$model$spl_hazard3[, 3]), col = "3", lty = "2222", lwd = 1)
    lines(cbind(input$time_pred, surv_pred$model$spl_odds1[, 3]), col = "4", lty = "2222", lwd = 1)
    lines(cbind(input$time_pred, surv_pred$model$spl_odds2[, 3]), col = "5", lty = "2222", lwd = 1)
    lines(cbind(input$time_pred, surv_pred$model$spl_odds3[, 3]), col = "6", lty = "2222", lwd = 1)
    lines(cbind(input$time_pred, surv_pred$model$spl_normal1[, 3]), col = "7", lty = "2222", lwd = 1)
    lines(cbind(input$time_pred, surv_pred$model$spl_normal2[, 3]), col = "8", lty = "2222", lwd = 1)
    lines(cbind(input$time_pred, surv_pred$model$spl_normal3[, 3]), col = "9", lty = "2222", lwd = 1)
    legend("topright", legend = misc$lbls_spline, col = 1:9, lty = "2222", cex = 0.8)
  }
  # cure curves
  if (input$cure_mod == TRUE) {
    plot(surv_obs$km[2], lwd = 2, col = "black", main = "C: Kaplan-Meier (cure curves)", 
         xlab = "time", ylab = "survival", xlim = c(0, input$time_horizon))
    lines(cbind(input$time_pred, surv_pred$model$cure_weib_mix[, 3]), col = "1", lty = "2222", lwd = 1)
    lines(cbind(input$time_pred, surv_pred$model$cure_weib_nmix[, 3]), col = "2", lty = "2222", lwd = 1)
    lines(cbind(input$time_pred, surv_pred$model$cure_lnorm_mix[, 3]), col = "3", lty = "2222", lwd = 1)
    lines(cbind(input$time_pred, surv_pred$model$cure_lnorm_nmix[, 3]), col = "4", lty = "2222", lwd = 1)
    lines(cbind(input$time_pred, surv_pred$model$cure_llog_mix[, 3]), col = "5", lty = "2222", lwd = 1)
    lines(cbind(input$time_pred, surv_pred$model$cure_llog_nmix[, 3]), col = "6", lty = "2222", lwd = 1)
    legend("topright", legend = misc$lbls_cure, col = 1:6, lty = "2222", cex = 0.8)
  }
}, envir = PERSUADE)
kable_styling(kable(t(round(
  PERSUADE$surv_pred$gr$gr_2[1 + PERSUADE$input$time_pred_surv_table, ], 3))[-1, ], 
  col.names = paste("T=", PERSUADE$surv_pred$gr$gr_2[1 + PERSUADE$input$time_pred_surv_table, ][, 1]),
  format = "latex", booktabs = TRUE, linesep = "", caption = "Survival probability at different time points"), 
  latex_options = c("scale_down", "striped"), position = "left")

evalq({
  # parametric curves
  plot(cbind(surv_obs$tp$gr_2$time, surv_obs$tp$gr_2$smooth), 
       main = "D: Annual transition probability (parametric curves)", 
       xlab = "time", ylab = "annual transition probability", ylim = c(0, 1), 
       xlim = c(0, input$time_horizon), col = "black", type = "l", lwd = 2)
  lines(cbind(surv_obs$tp$gr_2$time, surv_obs$tp$gr_2$smooth_lower), 
        col = "black", type = "l", lwd = 2, lty = 2)
  lines(cbind(surv_obs$tp$gr_2$time, surv_obs$tp$gr_2$smooth_upper), 
        col = "black", type = "l", lwd = 2, lty = 2)
  lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_2[, 2]), col = "1", lty = "2222", lwd = 1)
  lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_2[, 3]), col = "2", lty = "2222", lwd = 1)
  lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_2[, 4]), col = "3", lty = "2222", lwd = 1)
  lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_2[, 5]), col = "4", lty = "2222", lwd = 1)
  lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_2[, 6]), col = "5", lty = "2222", lwd = 1)
  lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_2[, 7]), col = "6", lty = "2222", lwd = 1)
  lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_2[, 8]), col = "7", lty = "2222", lwd = 1)
  legend("topleft", legend = misc$lbls, col = 1:7, lty = "2222", cex = 0.8)
  # spline curves
  if (input$spline_mod == TRUE) {
    plot(cbind(surv_obs$tp$gr_2$time, surv_obs$tp$gr_2$smooth), 
         main = "E: Annual transition probability (spline curves)", xlab = "time", 
         ylab = "annual transition probability", ylim = c(0, 1), xlim = c(0, input$time_horizon), 
         col = "black", type = "l", lwd = 2)
    lines(cbind(surv_obs$tp$gr_2$time, surv_obs$tp$gr_2$smooth_lower), 
          col = "black", type = "l", lwd = 2, lty = 2)
    lines(cbind(surv_obs$tp$gr_2$time, surv_obs$tp$gr_2$smooth_upper), 
          col = "black", type = "l", lwd = 2, lty = 2)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_2[, 9]), col = "1", lty = "2222", lwd = 1)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_2[, 10]), col = "2", lty = "2222", lwd = 1)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_2[, 11]), col = "3", lty = "2222", lwd = 1)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_2[, 12]), col = "4", lty = "2222", lwd = 1)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_2[, 13]), col = "5", lty = "2222", lwd = 1)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_2[, 14]), col = "6", lty = "2222", lwd = 1)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_2[, 15]), col = "7", lty = "2222", lwd = 1)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_2[, 16]), col = "8", lty = "2222", lwd = 1)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_2[, 17]), col = "9", lty = "2222", lwd = 1)
    legend("topleft", legend = misc$lbls_spline, col = 1:9, lty = "2222", cex = 0.8)
  }
  # cure curves
  if (input$cure_mod == TRUE) {
    plot(cbind(surv_obs$tp$gr_2$time, surv_obs$tp$gr_2$smooth), 
         main = "F: Annual transition probability (cure curves)", xlab = "time", 
         ylab = "annual transition probability", ylim = c(0, 1), xlim = c(0, input$time_horizon), 
         col = "black", type = "l", lwd = 2)
    lines(cbind(surv_obs$tp$gr_2$time, surv_obs$tp$gr_2$smooth_lower), 
          col = "black", type = "l", lwd = 2, lty = 2)
    lines(cbind(surv_obs$tp$gr_2$time, surv_obs$tp$gr_2$smooth_upper), 
          col = "black", type = "l", lwd = 2, lty = 2)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_2[, 18 - if(input$spline_mod == FALSE) {9} else {0}]), 
          col = "1", lty = "2222", lwd = 1)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_2[, 19 - if(input$spline_mod == FALSE) {9} else {0}]), 
          col = "2", lty = "2222", lwd = 1)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_2[, 20 - if(input$spline_mod == FALSE) {9} else {0}]), 
          col = "3", lty = "2222", lwd = 1)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_2[, 21 - if(input$spline_mod == FALSE) {9} else {0}]), 
          col = "4", lty = "2222", lwd = 1)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_2[, 22 - if(input$spline_mod == FALSE) {9} else {0}]), 
          col = "5", lty = "2222", lwd = 1)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_2[, 23 - if(input$spline_mod == FALSE) {9} else {0}]), 
          col = "6", lty = "2222", lwd = 1)
    legend("topleft", legend = misc$lbls_cure, col = 1:6, lty = "2222", cex = 0.8)
  }
}, envir = PERSUADE)
suppressWarnings(kable_styling(kable(descr(
  PERSUADE$surv_pred$tp_gr$gr_2[, 2:PERSUADE$misc$cols_tp], stats = c("mean", "sd", "min", "q1", "med", "q3", "max", "iqr"), transpose = TRUE), 
  format = "latex", booktabs = TRUE, linesep = "", caption = "Summary statistics of annual transition probabilities"), 
  latex_options = c("scale_down", "striped"), position = "left"))

evalq({
  plot(cbind(surv_obs$haz$smooth_gr2$est.grid, surv_obs$haz$smooth_gr2$haz.est), 
       main = "G: Hazard function (parametric curves)",
       type = "l", col = "black", lty = "2222", lwd = 2, xlab = "time", ylab = "smoothed hazard rate", 
       xlim = c(0, input$time_horizon), ylim = c(0, surv_obs$haz$max$smooth))
  lines(cbind(surv_pred$model$expo_h[[2]]$time, surv_pred$model$expo_h[[2]]$est), 
        col = "1", lty = "2222", lwd = 1)
  lines(cbind(surv_pred$model$weib_h[[2]]$time, surv_pred$model$weib_h[[2]]$est), 
        col = "2", lty = "2222", lwd = 1)
  lines(cbind(surv_pred$model$gom_h[[2]]$time, surv_pred$model$gom_h[[2]]$est), 
        col = "3", lty = "2222", lwd = 1)
  lines(cbind(surv_pred$model$lnorm_h[[2]]$time, surv_pred$model$lnorm_h[[2]]$est), 
        col = "4", lty = "2222", lwd = 1)
  lines(cbind(surv_pred$model$llog_h[[2]]$time, surv_pred$model$llog_h[[2]]$est), 
        col = "5", lty = "2222", lwd = 1)
  lines(cbind(surv_pred$model$gam_h[[2]]$time, surv_pred$model$gam_h[[2]]$est), 
        col = "6", lty = "2222", lwd = 1)
  lines(cbind(surv_pred$model$ggam_h[[2]]$time, surv_pred$model$ggam_h[[2]]$est), 
        col = "7", lty = "2222", lwd = 1)
  legend("topleft", legend = misc$lbls, col = 1:7, lty = "2222", cex = 0.8)
  
  if (input$spline_mod == TRUE) {
    plot(cbind(surv_obs$haz$smooth_gr2$est.grid, surv_obs$haz$smooth_gr2$haz.est),
         main = "H: Hazard function (spline curves)",
         type = "l", col = "black", lty = "2222", lwd = 2, xlab = "time", ylab = "smoothed hazard rate", 
         xlim = c(0, input$time_horizon), ylim = c(0, surv_obs$haz$max$smooth))
    lines(cbind(surv_pred$model$spl_hazard1_h[[2]]$time, surv_pred$model$spl_hazard1_h[[2]]$est), 
          col = "1", lty = "2222", lwd = 1)
    lines(cbind(surv_pred$model$spl_hazard2_h[[2]]$time, surv_pred$model$spl_hazard2_h[[2]]$est), 
          col = "2", lty = "2222", lwd = 1)
    lines(cbind(surv_pred$model$spl_hazard3_h[[2]]$time, surv_pred$model$spl_hazard3_h[[2]]$est), 
          col = "3", lty = "2222", lwd = 1)
    lines(cbind(surv_pred$model$spl_odds1_h[[2]]$time, surv_pred$model$spl_odds1_h[[2]]$est), 
          col = "4", lty = "2222", lwd = 1)
    lines(cbind(surv_pred$model$spl_odds2_h[[2]]$time, surv_pred$model$spl_odds2_h[[2]]$est), 
          col = "5", lty = "2222", lwd = 1)
    lines(cbind(surv_pred$model$spl_odds3_h[[2]]$time, surv_pred$model$spl_odds3_h[[2]]$est), 
          col = "6", lty = "2222", lwd = 1)
    lines(cbind(surv_pred$model$spl_normal1_h[[2]]$time, surv_pred$model$spl_normal1_h[[2]]$est), 
          col = "7", lty = "2222", lwd = 1)
    lines(cbind(surv_pred$model$spl_normal2_h[[2]]$time, surv_pred$model$spl_normal2_h[[2]]$est), 
          col = "8", lty = "2222", lwd = 1)
    lines(cbind(surv_pred$model$spl_normal3_h[[2]]$time, surv_pred$model$spl_normal3_h[[2]]$est), 
          col = "9", lty = "2222", lwd = 1)
    legend("topleft", legend = misc$lbls_spline, col = 1:9, lty = "2222", cex = 0.8)
  }
  if (input$cure_mod == TRUE) {
    plot(cbind(surv_obs$haz$smooth_gr2$est.grid, surv_obs$haz$smooth_gr2$haz.est),
         main = "I: Hazard function (cure curves)",
         type = "l", col = "black", lty = "2222", lwd = 2, xlab = "time", ylab = "smoothed hazard rate", 
         xlim = c(0, input$time_horizon), ylim = c(0, surv_obs$haz$max$smooth))
    lines(cbind(surv_pred$model$cure_weib_mix_h[, 1], surv_pred$model$cure_weib_mix_h[,3]), 
          col = "1", lty = "2222", lwd = 1)
    lines(cbind(surv_pred$model$cure_weib_nmix_h[, 1], surv_pred$model$cure_weib_nmix_h[,3]),
          col = "2", lty = "2222", lwd = 1)
    lines(cbind(surv_pred$model$cure_lnorm_mix_h[, 1], surv_pred$model$cure_lnorm_mix_h[,3]), 
          col = "3", lty = "2222", lwd = 1)
    lines(cbind(surv_pred$model$cure_lnorm_nmix_h[, 1], surv_pred$model$cure_lnorm_nmix_h[,3]), 
          col = "4", lty = "2222", lwd = 1)
    lines(cbind(surv_pred$model$cure_llog_mix_h[, 1], surv_pred$model$cure_llog_mix_h[,3]), 
          col = "5", lty = "2222", lwd = 1)
    lines(cbind(surv_pred$model$cure_llog_nmix_h[, 1], surv_pred$model$cure_llog_nmix_h[,3]), 
          col = "6", lty = "2222", lwd = 1)
    legend("topleft", legend = misc$lbls_cure, col = 1:6, lty = "2222", cex = 0.8)
  }
}, envir = PERSUADE)
```

\newpage

## `r paste("Group", PERSUADE$misc$group_names[3])`
```{r validate_extrapolation3, echo=FALSE, out.height = "29%", fig.width=11, eval=if (PERSUADE$misc$ngroups>2) {TRUE} else {FALSE}, comment=NA}
evalq({
  # parametric curves
  plot(surv_obs$km[3], lwd = 2, col = "black", main = "A: Kaplan-Meier (parametric curves)", 
       xlab = "time", ylab = "survival", xlim = c(0, input$time_horizon))
  lines(cbind(input$time_pred, surv_pred$model$expo[, 4]), col = "1", lty = "5212", lwd = 1)
  lines(cbind(input$time_pred, surv_pred$model$weib[, 4]), col = "2", lty = "5212", lwd = 1)
  lines(cbind(input$time_pred, surv_pred$model$gom[, 4]), col = "3", lty = "5212", lwd = 1)
  lines(cbind(input$time_pred, surv_pred$model$lnorm[, 4]), col = "4", lty = "5212", lwd = 1)
  lines(cbind(input$time_pred, surv_pred$model$llog[, 4]), col = "5", lty = "5212", lwd = 1)
  lines(cbind(input$time_pred, surv_pred$model$gam[, 4]), col = "6", lty = "5212", lwd = 1)
  lines(cbind(input$time_pred, surv_pred$model$ggam[, 4]), col = "7", lty = "5212", lwd = 1)
  legend("topright", legend = misc$lbls, col = 1:7, lty = "5212", cex = 0.8)
  # spline curves
  if (input$spline_mod == TRUE) {
    plot(surv_obs$km[3], lwd = 2, col = "black", main = "B: Kaplan-Meier (spline curves)", 
         xlab = "time", ylab = "survival", xlim = c(0, input$time_horizon))
    lines(cbind(input$time_pred, surv_pred$model$spl_hazard1[, 4]), col = "1", lty = "5212", lwd = 1)
    lines(cbind(input$time_pred, surv_pred$model$spl_hazard2[, 4]), col = "2", lty = "5212", lwd = 1)
    lines(cbind(input$time_pred, surv_pred$model$spl_hazard3[, 4]), col = "3", lty = "5212", lwd = 1)
    lines(cbind(input$time_pred, surv_pred$model$spl_odds1[, 4]), col = "4", lty = "5212", lwd = 1)
    lines(cbind(input$time_pred, surv_pred$model$spl_odds2[, 4]), col = "5", lty = "5212", lwd = 1)
    lines(cbind(input$time_pred, surv_pred$model$spl_odds3[, 4]), col = "6", lty = "5212", lwd = 1)
    lines(cbind(input$time_pred, surv_pred$model$spl_normal1[, 4]), col = "7", lty = "5212", lwd = 1)
    lines(cbind(input$time_pred, surv_pred$model$spl_normal2[, 4]), col = "8", lty = "5212", lwd = 1)
    lines(cbind(input$time_pred, surv_pred$model$spl_normal3[, 4]), col = "9", lty = "5212", lwd = 1)
    legend("topright", legend = misc$lbls_spline, col = 1:9, lty = "5212", cex = 0.8)
  }
  # cure curves
  if (input$cure_mod == TRUE) {
    plot(surv_obs$km[3], lwd = 2, col = "black", main = "C: Kaplan-Meier (cure curves)", 
         xlab = "time", ylab = "survival", xlim = c(0, input$time_horizon))
    lines(cbind(input$time_pred, surv_pred$model$cure_weib_mix[, 4]), col = "1", lty = "5212", lwd = 1)
    lines(cbind(input$time_pred, surv_pred$model$cure_weib_nmix[, 4]), col = "2", lty = "5212", lwd = 1)
    lines(cbind(input$time_pred, surv_pred$model$cure_lnorm_mix[, 4]), col = "3", lty = "5212", lwd = 1)
    lines(cbind(input$time_pred, surv_pred$model$cure_lnorm_nmix[, 4]), col = "4", lty = "5212", lwd = 1)
    lines(cbind(input$time_pred, surv_pred$model$cure_llog_mix[, 4]), col = "5", lty = "5212", lwd = 1)
    lines(cbind(input$time_pred, surv_pred$model$cure_llog_nmix[, 4]), col = "6", lty = "5212", lwd = 1)
    legend("topright", legend = misc$lbls_cure, col = 1:6, lty = "5212", cex = 0.8)
  }
}, envir = PERSUADE)
kable_styling(kable(t(round(
  PERSUADE$surv_pred$gr$gr_3[1 + PERSUADE$input$time_pred_surv_table, ], 3))[-1, ], 
  col.names = paste("T=", PERSUADE$surv_pred$gr$gr_3[1 + PERSUADE$input$time_pred_surv_table, ][, 1]),
  format = "latex", booktabs = TRUE, linesep = "", caption = "Survival probability at different time points"), 
  latex_options = c("scale_down", "striped"), position = "left")

evalq({
  # parametric curves
  plot(cbind(surv_obs$tp$gr_3$time, surv_obs$tp$gr_3$smooth), 
       main = "D: Annual transition probability (parametric curves)", 
       xlab = "time", ylab = "annual transition probability", 
       ylim = c(0, 1), xlim = c(0, input$time_horizon), col = "black", type = "l", lwd = 2)
  lines(cbind(surv_obs$tp$gr_3$time, surv_obs$tp$gr_3$smooth_lower), 
        col = "black", type = "l", lwd = 2, lty = 2)
  lines(cbind(surv_obs$tp$gr_3$time, surv_obs$tp$gr_3$smooth_upper), 
        col = "black", type = "l", lwd = 2, lty = 2)
  lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_3[, 2]), col = "1", lty = "5212", lwd = 1)
  lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_3[, 3]), col = "2", lty = "5212", lwd = 1)
  lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_3[, 4]), col = "3", lty = "5212", lwd = 1)
  lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_3[, 5]), col = "4", lty = "5212", lwd = 1)
  lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_3[, 6]), col = "5", lty = "5212", lwd = 1)
  lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_3[, 7]), col = "6", lty = "5212", lwd = 1)
  lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_3[, 8]), col = "7", lty = "5212", lwd = 1)
  legend("topleft", legend = misc$lbls, col = 1:7, lty = "5212", cex = 0.8)
  # spline curves
  if (input$spline_mod == TRUE) {
    plot(cbind(surv_obs$tp$gr_3$time, surv_obs$tp$gr_3$smooth), 
         main = "E: Annual transition probability (spline curves)", xlab = "time", 
         ylab = "annual transition probability", ylim = c(0, 1), xlim = c(0, input$time_horizon), 
         col = "black", type = "l", lwd = 2)
    lines(cbind(surv_obs$tp$gr_3$time, surv_obs$tp$gr_3$smooth_lower), 
          col = "black", type = "l", lwd = 2, lty = 2)
    lines(cbind(surv_obs$tp$gr_3$time, surv_obs$tp$gr_3$smooth_upper), 
          col = "black", type = "l", lwd = 2, lty = 2)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_3[, 9]), col = "1", lty = "5212", lwd = 1)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_3[, 10]), col = "2", lty = "5212", lwd = 1)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_3[, 11]), col = "3", lty = "5212", lwd = 1)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_3[, 12]), col = "4", lty = "5212", lwd = 1)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_3[, 13]), col = "5", lty = "5212", lwd = 1)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_3[, 14]), col = "6", lty = "5212", lwd = 1)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_3[, 15]), col = "7", lty = "5212", lwd = 1)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_3[, 16]), col = "8", lty = "5212", lwd = 1)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_3[, 17]), col = "9", lty = "5212", lwd = 1)
    legend("topleft", legend = misc$lbls_spline, col = 1:9, lty = "5212", cex = 0.8)
  }
  # cure curves
  if (input$cure_mod == TRUE) {
    plot(cbind(surv_obs$tp$gr_3$time, surv_obs$tp$gr_3$smooth), 
         main = "F: Annual transition probability (cure curves)", xlab = "time", 
         ylab = "annual transition probability", ylim = c(0, 1), xlim = c(0, input$time_horizon), 
         col = "black", type = "l", lwd = 2)
    lines(cbind(surv_obs$tp$gr_3$time, surv_obs$tp$gr_3$smooth_lower), 
          col = "black", type = "l", lwd = 2, lty = 2)
    lines(cbind(surv_obs$tp$gr_3$time, surv_obs$tp$gr_3$smooth_upper), 
          col = "black", type = "l", lwd = 2, lty = 2)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_3[, 18 - if(input$spline_mod == FALSE) {9} else {0}]), 
          col = "1", lty = "5212", lwd = 1)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_3[, 19 - if(input$spline_mod == FALSE) {9} else {0}]), 
          col = "2", lty = "5212", lwd = 1)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_3[, 20 - if(input$spline_mod == FALSE) {9} else {0}]), 
          col = "3", lty = "5212", lwd = 1)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_3[, 21 - if(input$spline_mod == FALSE) {9} else {0}]), 
          col = "4", lty = "5212", lwd = 1)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_3[, 22 - if(input$spline_mod == FALSE) {9} else {0}]),
          col = "5", lty = "5212", lwd = 1)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_3[, 23 - if(input$spline_mod == FALSE) {9} else {0}]), 
          col = "6", lty = "5212", lwd = 1)
    legend("topleft", legend = misc$lbls_cure, col = 1:6, lty = "5212", cex = 0.8)
  }
  
}, envir = PERSUADE)
suppressWarnings(kable_styling(kable(descr(
  PERSUADE$surv_pred$tp_gr$gr_3[, 2:PERSUADE$misc$cols_tp], stats = c("mean", "sd", "min", "q1", "med", "q3", "max", "iqr"), transpose = TRUE), 
  format = "latex", booktabs = TRUE, linesep = "", caption = "Summary statistics of annual transition probabilities"), 
  latex_options = c("scale_down", "striped"), position = "left"))

evalq({
  plot(cbind(surv_obs$haz$smooth_gr3$est.grid, surv_obs$haz$smooth_gr3$haz.est), 
       main = "G: Hazard function (parametric curves)",
       type = "l", col = "black", lty = "5212", lwd = 2, xlab = "time", ylab = "smoothed hazard rate", 
       xlim = c(0, input$time_horizon), ylim = c(0, surv_obs$haz$max$smooth))
  lines(cbind(surv_pred$model$expo_h[[3]]$time, surv_pred$model$expo_h[[3]]$est), 
        col = "1", lty = "5212", lwd = 1)
  lines(cbind(surv_pred$model$weib_h[[3]]$time, surv_pred$model$weib_h[[3]]$est), 
        col = "2", lty = "5212", lwd = 1)
  lines(cbind(surv_pred$model$gom_h[[3]]$time, surv_pred$model$gom_h[[3]]$est), 
        col = "3", lty = "5212", lwd = 1)
  lines(cbind(surv_pred$model$lnorm_h[[3]]$time, surv_pred$model$lnorm_h[[3]]$est), 
        col = "4", lty = "5212", lwd = 1)
  lines(cbind(surv_pred$model$llog_h[[3]]$time, surv_pred$model$llog_h[[3]]$est), 
        col = "5", lty = "5212", lwd = 1)
  lines(cbind(surv_pred$model$gam_h[[3]]$time, surv_pred$model$gam_h[[3]]$est), 
        col = "6", lty = "5212", lwd = 1)
  lines(cbind(surv_pred$model$ggam_h[[3]]$time, surv_pred$model$ggam_h[[3]]$est), 
        col = "7", lty = "5212", lwd = 1)
  legend("topleft", legend = misc$lbls, col = 1:7, lty = "5212", cex = 0.8)
  
  if (input$spline_mod == TRUE) {
    plot(cbind(surv_obs$haz$smooth_gr3$est.grid, surv_obs$haz$smooth_gr3$haz.est), 
         main = "H: Hazard function (spline curves)",
         type = "l", col = "black", lty = "5212", lwd = 2, xlab = "time", ylab = "smoothed hazard rate", 
         xlim = c(0, input$time_horizon), ylim = c(0, surv_obs$haz$max$smooth))
    lines(cbind(surv_pred$model$spl_hazard1_h[[3]]$time, surv_pred$model$spl_hazard1_h[[3]]$est), 
          col = "1", lty = "5212", lwd = 1)
    lines(cbind(surv_pred$model$spl_hazard2_h[[3]]$time, surv_pred$model$spl_hazard2_h[[3]]$est), 
          col = "2", lty = "5212", lwd = 1)
    lines(cbind(surv_pred$model$spl_hazard3_h[[3]]$time, surv_pred$model$spl_hazard3_h[[3]]$est), 
          col = "3", lty = "5212", lwd = 1)
    lines(cbind(surv_pred$model$spl_odds1_h[[3]]$time, surv_pred$model$spl_odds1_h[[3]]$est), 
          col = "4", lty = "5212", lwd = 1)
    lines(cbind(surv_pred$model$spl_odds2_h[[3]]$time, surv_pred$model$spl_odds2_h[[3]]$est), 
          col = "5", lty = "5212", lwd = 1)
    lines(cbind(surv_pred$model$spl_odds3_h[[3]]$time, surv_pred$model$spl_odds3_h[[3]]$est), 
          col = "6", lty = "5212", lwd = 1)
    lines(cbind(surv_pred$model$spl_normal1_h[[3]]$time, surv_pred$model$spl_normal1_h[[3]]$est), 
          col = "7", lty = "5212", lwd = 1)
    lines(cbind(surv_pred$model$spl_normal2_h[[3]]$time, surv_pred$model$spl_normal2_h[[3]]$est), 
          col = "8", lty = "5212", lwd = 1)
    lines(cbind(surv_pred$model$spl_normal3_h[[3]]$time, surv_pred$model$spl_normal3_h[[3]]$est), 
          col = "9", lty = "5212", lwd = 1)
    legend("topleft", legend = misc$lbls_spline, col = 1:9, lty = "5212", cex = 0.8)
  }
  if (input$cure_mod == TRUE) {
    plot(cbind(surv_obs$haz$smooth_gr3$est.grid, surv_obs$haz$smooth_gr3$haz.est), 
         main = "I: Hazard function (cure curves)",
         type = "l", col = "black", lty = "5212", lwd = 2, xlab = "time", ylab = "smoothed hazard rate", 
         xlim = c(0, input$time_horizon), ylim = c(0, surv_obs$haz$max$smooth))
    lines(cbind(surv_pred$model$cure_weib_mix_h[, 1], surv_pred$model$cure_weib_mix_h[,4]),
          col = "1", lty = "5212", lwd = 1)
    lines(cbind(surv_pred$model$cure_weib_nmix_h[, 1], surv_pred$model$cure_weib_nmix_h[,4]),
          col = "2", lty = "5212", lwd = 1)
    lines(cbind(surv_pred$model$cure_lnorm_mix_h[, 1], surv_pred$model$cure_lnorm_mix_h[,4]),
          col = "3", lty = "5212", lwd = 1)
    lines(cbind(surv_pred$model$cure_lnorm_nmix_h[, 1], surv_pred$model$cure_lnorm_nmix_h[,4]),
          col = "4", lty = "5212", lwd = 1)
    lines(cbind(surv_pred$model$cure_llog_mix_h[, 1], surv_pred$model$cure_llog_mix_h[,4]),
          col = "5", lty = "5212", lwd = 1)
    lines(cbind(surv_pred$model$cure_llog_nmix_h[, 1], surv_pred$model$cure_llog_nmix_h[,4]),
          col = "6", lty = "5212", lwd = 1)
    legend("topleft", legend = misc$lbls_cure, col = 1:6, lty = "5212", cex = 0.8)
  }
}, envir = PERSUADE)

```

\newpage

# PERSUADE object information
```{r oi, echo=FALSE}
print(str(PERSUADE, max.level = 2))
```

\newpage

# Session information
```{r si, echo=FALSE}
print(sessionInfo(), RNG = TRUE, locale = FALSE)
```


