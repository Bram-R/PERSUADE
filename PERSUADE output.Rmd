---
output:
  pdf_document:
    toc: yes
    keep_tex: TRUE
urlcolor: blue
---

---
title: "PERSUADE `r basename(getwd())`"
date: "`r Sys.Date()`"
---

```{r setup, include=FALSE}
#code is formatted using formatR::tidy_source(width.cutoff = 80)
knitr::opts_chunk$set(echo = TRUE, fig.align = "left", fig.path = "Images/", dev = c('pdf', 'png'), dpi=300)
```

```{r preparation, echo=FALSE, warning = FALSE, message = FALSE, results = "hide"}
packages <- c("rms", "survival", "flexsurv", "muhaz", "survminer", "ggplot2", "data.table",
              "summarytools", "knitr", "kableExtra", "sft")
new.packages <- packages[!(packages %in% installed.packages()[, "Package"])]  #check for new packages
if (length(new.packages)) install.packages(new.packages)  #install new packages (if needed)
suppressPackageStartupMessages(lapply(packages, require, character.only = TRUE))  #load packages

# COLOUR PALETTE
n <- 8  #number of different colors (to be used for palette)
palette(rainbow(n = n, s = 1, v = 1, start = 0, end = max(1, n - 1)/n, alpha = 1))
```

```{r input, echo=FALSE, warning = FALSE, message = FALSE, results = "hide"}
# INPUT DATA
load(paste0(getwd(), "/PERSUADE.RData"))
```

\  
\

[Link to PERSUADE GitHub page](https://github.com/Bram-R/PERSUADE)
\newpage

#Kaplan-Meier
```{r plot_KM, echo=FALSE, fig.height=8, fig.width=7}
evalq({
  suppressWarnings(if (misc$ngroups > 1) {
    ggsurvplot(surv_fit(misc$form, data = data.frame(input[1:3])), 
               linetype = as.integer(c(1, "2222", "5212")), legend.labs = misc$group_names, risk.table = TRUE, 
               conf.int = TRUE, surv.median.line = "hv", ncensor.plot = TRUE, censor = FALSE, 
               ggtheme = theme_light(), color = "strata", size = 0.5)
  } else {
    ggsurvplot(surv_fit(misc$form, data = data.frame(input[1:2])), legend.labs = misc$group_names, 
               risk.table = TRUE, conf.int = TRUE, surv.median.line = "hv", ncensor.plot = FALSE, 
               censor = TRUE, ggtheme = theme_light(), color = "black", size = 0.5)
  })
}, envir = PERSUADE)

kable_styling(kable(summary(PERSUADE$surv_obs$km)$table, format = "latex", 
                    row.names = TRUE, booktabs = TRUE, linesep = ""), latex_options = "striped")
```

\newpage

#Stratified models?
Should stratified parametric survival models be used?
```{r PH_assumption, echo=FALSE, eval=if (PERSUADE$misc$ngroups>1) {TRUE} else {FALSE}, out.height = "29%", fig.width=11}
evalq({
  plot(cbind(log(surv_obs$km$time), log(-log(surv_obs$km$surv))), main = "A: LN(cumulative hazard)", 
       xlim = c(floor(min(log(surv_obs$km$time)[surv_obs$km$surv != 1])), ceiling(max(log(surv_obs$km$time)))), 
       cex = 0.6, xlab = "LN(time)", ylab = "LN(cumulative hazard)", 
       pch = c(1, 8, 9)[surv_obs$km_names], col = c("black", "lightgrey", "darkgrey")[surv_obs$km_names])
  
  plot(cox.zph(surv_obs$cox_reg, terms = FALSE)[1], col = "5", lwd = 2, xlab = "time", 
       main = "B: Scaled Schoenfeld residuals", ylab = "Beta(t) for group 2 vs group 1")
  abline(0, 0, lty = 3)
  abline(lm(cox.zph(surv_obs$cox_reg, terms = FALSE)$y[, 1] ~ cox.zph(surv_obs$cox_reg)$x)$coefficients, 
         col = "7", lty = 1, lwd = 2)
  legend(0, -2, col = c("5", "7"), lty = 1, cex = 0.8, 
         legend = c("smoothed line (natural spline with df = 4)", "regression line"))
  if (misc$ngroups > 2) {
    plot(cox.zph(surv_obs$cox_reg, terms = FALSE)[2], col = "5", lwd = 2, xlab = "time", 
         main = "C: Scaled Schoenfeld residuals", ylab = "Beta(t) for group 3 vs group 1")
    abline(0, 0, lty = 3)
    abline(lm(cox.zph(surv_obs$cox_reg, terms = FALSE)$y[, 2] ~ cox.zph(surv_obs$cox_reg)$x)$coefficients, 
           col = "7", lty = 1, lwd = 2)
    legend(0, -2, col = c("5", "7"), lty = 1, cex = 0.8, 
           legend = c("smoothed line (natural spline with df = 4)", "regression line"))
  }
}, envir = PERSUADE)
```

\newpage

#Shape of the observed smoothed hazard function
Should parametric survival models assuming a monotonic hazard rate (i.e. exponential, Weibull, Gompertz) be used?
```{r plot_hr, echo=FALSE}
evalq({
  plot(cbind(surv_obs$haz$smooth_gr1$est.grid, surv_obs$haz$smooth_gr1$haz.est), 
       type = "l", col = "red", lty = 1, lwd = 2, xlab = "time", ylab = "smoothed hazard rate", 
       xlim = c(0, surv_obs$haz$max$time), ylim = c(0, surv_obs$haz$max$smooth))
  if (misc$ngroups > 1) {
    lines(cbind(surv_obs$haz$smooth_gr2$est.grid, surv_obs$haz$smooth_gr2$haz.est), 
          col = "green", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(surv_obs$haz$smooth_gr3$est.grid, surv_obs$haz$smooth_gr3$haz.est), 
          col = "blue", lty = "5212", lwd = 2)
  }
  legend("topleft", legend = misc$group_names, col = c("red", "green", "blue"), 
         lty = as.integer(c(1, "2222", "5212")), cex = 0.8)
}, envir = PERSUADE)
```

\newpage

#Shape of the predicted hazard function
```{r plot_haz_pred, out.height = "29%", fig.width=11, echo=FALSE}

# GROUP 1
evalq({
  plot(cbind(surv_obs$haz$smooth_gr1$est.grid, surv_obs$haz$smooth_gr1$haz.est),
       main = paste("Group", misc$group_names[1]),
       type = "l", col = "black", lty = 1, lwd = 2, xlab = "time", ylab = "smoothed hazard rate", 
       xlim = c(0, surv_obs$haz$max$time), ylim = c(0, surv_obs$haz$max$smooth))
  lines(cbind(surv_pred$model$expo_h[[1]]$time, surv_pred$model$expo_h[[1]]$est), 
        col = "1", lty = 1, lwd = 1)
  lines(cbind(surv_pred$model$weib_h[[1]]$time, surv_pred$model$weib_h[[1]]$est), 
        col = "2", lty = 1, lwd = 1)
  lines(cbind(surv_pred$model$gom_h[[1]]$time, surv_pred$model$gom_h[[1]]$est), 
        col = "3", lty = 1, lwd = 1)
  lines(cbind(surv_pred$model$lnorm_h[[1]]$time, surv_pred$model$lnorm_h[[1]]$est), 
        col = "4", lty = 1, lwd = 1)
  lines(cbind(surv_pred$model$llog_h[[1]]$time, surv_pred$model$llog_h[[1]]$est), 
        col = "5", lty = 1, lwd = 1)
  lines(cbind(surv_pred$model$gam_h[[1]]$time, surv_pred$model$gam_h[[1]]$est), 
        col = "6", lty = 1, lwd = 1)
  lines(cbind(surv_pred$model$ggam_h[[1]]$time, surv_pred$model$ggam_h[[1]]$est), 
        col = "7", lty = 1, lwd = 1)
  legend("topleft", legend = misc$lbls, col = 1:7, lty = 1, cex = 0.8)
  
  if (input$spline_mod == TRUE) {
    plot(cbind(surv_pred$model$spl_hazard1_h[[1]]$time, surv_pred$model$spl_hazard1_h[[1]]$est), 
         main = paste("Group", misc$group_names[1]),
         type = "l", col = "black", lty = 1, lwd = 2, xlab = "time", ylab = "smoothed hazard rate", 
         xlim = c(0, surv_obs$haz$max$time), ylim = c(0, surv_obs$haz$max$smooth))
    lines(cbind(surv_pred$model$spl_hazard1_h[[1]]$time, surv_pred$model$spl_hazard1_h[[1]]$est), 
          col = "1", lty = 1, lwd = 1)
    lines(cbind(surv_pred$model$spl_hazard2_h[[1]]$time, surv_pred$model$spl_hazard1_h[[1]]$est), 
          col = "2", lty = 1, lwd = 1)
    lines(cbind(surv_pred$model$spl_odds1_h[[1]]$time, surv_pred$model$spl_odds1_h[[1]]$est), 
          col = "3", lty = 1, lwd = 1)
    lines(cbind(surv_pred$model$spl_odds2_h[[1]]$time, surv_pred$model$spl_odds2_h[[1]]$est), 
          col = "4", lty = 1, lwd = 1)
    lines(cbind(surv_pred$model$spl_normal1_h[[1]]$time, surv_pred$model$spl_normal1_h[[1]]$est), 
          col = "5", lty = 1, lwd = 1)
    lines(cbind(surv_pred$model$spl_normal2_h[[1]]$time, surv_pred$model$spl_normal2_h[[1]]$est), 
          col = "6", lty = 1, lwd = 1)
    legend("topleft", legend = misc$lbls_spline, col = 1:6, lty = 1, cex = 0.8)
  }
}, envir = PERSUADE)


# GROUP 2
evalq({
  if (misc$ngroups > 1) {
    plot(cbind(surv_obs$haz$smooth_gr2$est.grid, surv_obs$haz$smooth_gr2$haz.est), 
         main = paste("Group", misc$group_names[2]),
         type = "l", col = "black", lty = "2222", lwd = 2, xlab = "time", ylab = "smoothed hazard rate", 
         xlim = c(0, surv_obs$haz$max$time), ylim = c(0, surv_obs$haz$max$smooth))
    lines(cbind(surv_pred$model$expo_h[[2]]$time, surv_pred$model$expo_h[[2]]$est), 
          col = "1", lty = "2222", lwd = 1)
    lines(cbind(surv_pred$model$weib_h[[2]]$time, surv_pred$model$weib_h[[2]]$est), 
          col = "2", lty = "2222", lwd = 1)
    lines(cbind(surv_pred$model$gom_h[[2]]$time, surv_pred$model$gom_h[[2]]$est), 
          col = "3", lty = "2222", lwd = 1)
    lines(cbind(surv_pred$model$lnorm_h[[2]]$time, surv_pred$model$lnorm_h[[2]]$est), 
          col = "4", lty = "2222", lwd = 1)
    lines(cbind(surv_pred$model$llog_h[[2]]$time, surv_pred$model$llog_h[[2]]$est), 
          col = "5", lty = "2222", lwd = 1)
    lines(cbind(surv_pred$model$gam_h[[2]]$time, surv_pred$model$gam_h[[2]]$est), 
          col = "6", lty = "2222", lwd = 1)
    lines(cbind(surv_pred$model$ggam_h[[2]]$time, surv_pred$model$ggam_h[[2]]$est), 
          col = "7", lty = "2222", lwd = 1)
    legend("topleft", legend = misc$lbls, col = 1:7, lty = "2222", cex = 0.8)
    
    if (input$spline_mod == TRUE) {
      plot(cbind(surv_obs$haz$smooth_gr2$est.grid, surv_obs$haz$smooth_gr2$haz.est),
           main = paste("Group", misc$group_names[2]),
           type = "l", col = "black", lty = "2222", lwd = 2, xlab = "time", ylab = "smoothed hazard rate", 
           xlim = c(0, surv_obs$haz$max$time), ylim = c(0, surv_obs$haz$max$smooth))
      lines(cbind(surv_pred$model$spl_hazard1_h[[2]]$time, surv_pred$model$spl_hazard1_h[[2]]$est), 
            col = "1", lty = "2222", lwd = 1)
      lines(cbind(surv_pred$model$spl_hazard2_h[[2]]$time, surv_pred$model$spl_hazard1_h[[2]]$est), 
            col = "2", lty = "2222", lwd = 1)
      lines(cbind(surv_pred$model$spl_odds1_h[[2]]$time, surv_pred$model$spl_odds1_h[[2]]$est), 
            col = "3", lty = "2222", lwd = 1)
      lines(cbind(surv_pred$model$spl_odds2_h[[2]]$time, surv_pred$model$spl_odds2_h[[2]]$est), 
            col = "4", lty = "2222", lwd = 1)
      lines(cbind(surv_pred$model$spl_normal1_h[[2]]$time, surv_pred$model$spl_normal1_h[[2]]$est), 
            col = "5", lty = "2222", lwd = 1)
      lines(cbind(surv_pred$model$spl_normal2_h[[2]]$time, surv_pred$model$spl_normal2_h[[2]]$est), 
            col = "6", lty = "2222", lwd = 1)
      legend("topleft", legend = misc$lbls_spline, col = 1:6, lty = "2222", cex = 0.8)
    }
  }
}, envir = PERSUADE)

# GROUP 3
evalq({
  if (misc$ngroups > 2) {
    plot(cbind(surv_obs$haz$smooth_gr3$est.grid, surv_obs$haz$smooth_gr3$haz.est), 
         main = paste("Group", misc$group_names[3]),
         type = "l", col = "black", lty = "5212", lwd = 2, xlab = "time", ylab = "smoothed hazard rate", 
         xlim = c(0, surv_obs$haz$max$time), ylim = c(0, surv_obs$haz$max$smooth))
    lines(cbind(surv_pred$model$expo_h[[3]]$time, surv_pred$model$expo_h[[3]]$est), 
          col = "1", lty = "5212", lwd = 1)
    lines(cbind(surv_pred$model$weib_h[[3]]$time, surv_pred$model$weib_h[[3]]$est), 
          col = "2", lty = "5212", lwd = 1)
    lines(cbind(surv_pred$model$gom_h[[3]]$time, surv_pred$model$gom_h[[3]]$est), 
          col = "3", lty = "5212", lwd = 1)
    lines(cbind(surv_pred$model$lnorm_h[[3]]$time, surv_pred$model$lnorm_h[[3]]$est), 
          col = "4", lty = "5212", lwd = 1)
    lines(cbind(surv_pred$model$llog_h[[3]]$time, surv_pred$model$llog_h[[3]]$est), 
          col = "5", lty = "5212", lwd = 1)
    lines(cbind(surv_pred$model$gam_h[[3]]$time, surv_pred$model$gam_h[[3]]$est), 
          col = "6", lty = "5212", lwd = 1)
    lines(cbind(surv_pred$model$ggam_h[[3]]$time, surv_pred$model$ggam_h[[3]]$est), 
          col = "7", lty = "5212", lwd = 1)
    legend("topleft", legend = misc$lbls, col = 1:7, lty = "5212", cex = 0.8)
    
    if (input$spline_mod == TRUE) {
      plot(cbind(surv_obs$haz$smooth_gr3$est.grid, surv_obs$haz$smooth_gr3$haz.est), 
           main = paste("Group", misc$group_names[3]),
           type = "l", col = "black", lty = "5212", lwd = 2, xlab = "time", ylab = "smoothed hazard rate", 
           xlim = c(0, surv_obs$haz$max$time), ylim = c(0, surv_obs$haz$max$smooth))
      lines(cbind(surv_pred$model$spl_hazard1_h[[3]]$time, surv_pred$model$spl_hazard1_h[[3]]$est), 
            col = "1", lty = "5212", lwd = 1)
      lines(cbind(surv_pred$model$spl_hazard2_h[[3]]$time, surv_pred$model$spl_hazard1_h[[3]]$est), 
            col = "2", lty = "5212", lwd = 1)
      lines(cbind(surv_pred$model$spl_odds1_h[[3]]$time, surv_pred$model$spl_odds1_h[[3]]$est), 
            col = "3", lty = "5212", lwd = 1)
      lines(cbind(surv_pred$model$spl_odds2_h[[3]]$time, surv_pred$model$spl_odds2_h[[3]]$est), 
            col = "4", lty = "5212", lwd = 1)
      lines(cbind(surv_pred$model$spl_normal1_h[[3]]$time, surv_pred$model$spl_normal1_h[[3]]$est), 
            col = "5", lty = "5212", lwd = 1)
      lines(cbind(surv_pred$model$spl_normal2_h[[3]]$time, surv_pred$model$spl_normal2_h[[3]]$est), 
            col = "6", lty = "5212", lwd = 1)
      legend("topleft", legend = misc$lbls_spline, col = 1:6, lty = "5212", cex = 0.8)
    }
  }
}, envir = PERSUADE)

```

\newpage

#Standard parametric models?
Do standard parametric models provide an appropriate fit to the data?
```{r plot_parametric, echo=FALSE}
evalq({
  pie(rep(1, n), labels = misc$lbls, col = rainbow(n = n, s = 1, v = 1, start = 0, 
                                                   end = max(1, n - 1)/n, alpha = 1))
  kable_styling(kable(surv_model$IC[order(surv_model$IC$AIC), ], format = "latex", 
                      row.names = FALSE, booktabs = TRUE, linesep = ""), latex_options = "striped")
}, envir = PERSUADE)
```

##Exponential
```{r expo, echo=FALSE, out.height = "30%", fig.width=11}
evalq({
  # constant hazard
  plot(surv_obs$km, lwd = 2, main = "A: Kaplan-Meier (Exponential)", xlab = "time", 
       ylab = "survival", col = c("black", "lightgrey", "darkgrey"))
  lines(cbind(input$time_pred, surv_pred$model$expo[, 2]), col = "1", lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(input$time_pred, surv_pred$model$expo[, 3]), col = "1", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(input$time_pred, surv_pred$model$expo[, 4]), col = "1", lty = "5212", lwd = 2)
  }
  # add shading confidence intervals
  polygon(c(surv_obs$km$time[surv_obs$km_names == 1], rev(surv_obs$km$time[surv_obs$km_names == 1])),
          c(surv_obs$km$lower[surv_obs$km_names == 1], rev(surv_obs$km$upper[surv_obs$km_names == 1])), 
          col = adjustcolor("black", alpha.f = 0.3), border = NA)
  if (misc$ngroups > 1) {
    polygon(c(surv_obs$km$time[surv_obs$km_names == 2], rev(surv_obs$km$time[surv_obs$km_names == 2])),
            c(surv_obs$km$lower[surv_obs$km_names == 2], rev(surv_obs$km$upper[surv_obs$km_names == 2])), 
            col = adjustcolor("lightgrey", alpha.f = 0.3), border = NA)
  }
  if (misc$ngroups > 2) {
    polygon(c(surv_obs$km$time[surv_obs$km_names == 3], rev(surv_obs$km$time[surv_obs$km_names ==3])),
            c(surv_obs$km$lower[surv_obs$km_names == 3], rev(surv_obs$km$upper[surv_obs$km_names == 3])),
            col = adjustcolor("darkgrey", alpha.f = 0.3), border = NA)
  }
  legend("bottomleft", legend = misc$group_names, col = "1", lty = as.integer(c(1, 
                                                                                "2222", "5212")), cex = 0.8)
  
  # annual transition probabilities
  plot(cbind(surv_obs$tp$gr_1$time, surv_obs$tp$gr_1$smooth), lwd = 1, 
       lty = 1, type = "b", cex = 0.6, pch = 1, col = "black", 
       main = "B: Annual transition probability (Exponential)", 
       xlab = "time", ylab = "annual transition probability (smoothed)", 
       ylim = c(0, ceiling(surv_obs$tp$max * 10)/10), xlim = c(0, ceiling(surv_obs$km$maxtime * 10)/10))
  lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_1[, 2]), col = "1", 
        lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(surv_obs$tp$gr_2$time, surv_obs$tp$gr_2$smooth), 
          col = "lightgrey", type = "b", lwd = 1, cex = 0.6, pch = 8)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_2[, 2]), col = "1", 
          lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(surv_obs$tp$gr_3$time, surv_obs$tp$gr_3$smooth), 
          col = "darkgrey", type = "b", lwd = 1, cex = 0.6, pch = 9)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_3[, 2]), col = "1", 
          lty = "5212", lwd = 2)
  }
  # add shading confidence intervals
  polygon(c(surv_obs$tp$gr_1$time, rev(surv_obs$tp$gr_1$time)), 
          c(surv_obs$tp$gr_1$smooth_lower, rev(surv_obs$tp$gr_1$smooth_upper)), 
          col = adjustcolor("black", alpha.f = 0.3), border = NA)
  if (misc$ngroups > 1) {
    polygon(c(surv_obs$tp$gr_2$time, rev(surv_obs$tp$gr_2$time)), 
            c(surv_obs$tp$gr_2$smooth_lower, rev(surv_obs$tp$gr_2$smooth_upper)), 
            col = adjustcolor("lightgrey", alpha.f = 0.3), border = NA)
  }
  if (misc$ngroups > 2) {
    polygon(c(surv_obs$tp$gr_3$time, rev(surv_obs$tp$gr_3$time)), 
            c(surv_obs$tp$gr_3$smooth_lower, rev(surv_obs$tp$gr_3$smooth_upper)), 
            col = adjustcolor("darkgrey", alpha.f = 0.3), border = NA)
  }
  legend("topleft", legend = misc$group_names, col = "1", 
         lty = as.integer(c(1, "2222", "5212")), cex = 0.8)
  
  # diagnostics
  plot(cbind(surv_obs$km$time, -log(surv_obs$km$surv)), cex = 0.6, 
       pch = c(1, 8, 9)[surv_obs$km_names], col = c("black", "lightgrey", "darkgrey")[surv_obs$km_names], 
       main = "C: Diagnostic plot (Exponential)", xlab = "time", ylab = "cumulative hazard")
  lines(cbind(input$time_pred, -log(surv_pred$model$expo[, 2])), col = "1", lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(input$time_pred, -log(surv_pred$model$expo[, 3])), col = "1", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(input$time_pred, -log(surv_pred$model$expo[, 4])), col = "1", lty = "5212", lwd = 2)
  }
  legend("topleft", legend = misc$group_names, col = "1", lty = as.integer(c(1, "2222", "5212")), cex = 0.8)
}, envir = PERSUADE)
```

##Weibull
```{r weib, echo=FALSE, out.height = "30%", fig.width=11}
evalq({
  # monotonically increasing or decreasing hazard
  plot(surv_obs$km, lwd = 2, main = "A: Kaplan-Meier (Weibull)", xlab = "time", 
       ylab = "survival", col = c("black", "lightgrey", "darkgrey"))
  lines(cbind(input$time_pred, surv_pred$model$weib[, 2]), col = "2", lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(input$time_pred, surv_pred$model$weib[, 3]), col = "2", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(input$time_pred, surv_pred$model$weib[, 4]), col = "2", lty = "5212", lwd = 2)
  }
  # add shading confidence intervals
  polygon(c(surv_obs$km$time[surv_obs$km_names == 1], rev(surv_obs$km$time[surv_obs$km_names == 1])),
          c(surv_obs$km$lower[surv_obs$km_names == 1], rev(surv_obs$km$upper[surv_obs$km_names == 1])), 
          col = adjustcolor("black", alpha.f = 0.3), border = NA)
  if (misc$ngroups > 1) {
    polygon(c(surv_obs$km$time[surv_obs$km_names == 2], rev(surv_obs$km$time[surv_obs$km_names == 2])),
            c(surv_obs$km$lower[surv_obs$km_names == 2], rev(surv_obs$km$upper[surv_obs$km_names == 2])),
            col = adjustcolor("lightgrey", alpha.f = 0.3), border = NA)
  }
  if (misc$ngroups > 2) {
    polygon(c(surv_obs$km$time[surv_obs$km_names == 3], rev(surv_obs$km$time[surv_obs$km_names == 3])),
            c(surv_obs$km$lower[surv_obs$km_names == 3], rev(surv_obs$km$upper[surv_obs$km_names == 3])),
            col = adjustcolor("darkgrey", alpha.f = 0.3), border = NA)
  }
  legend("bottomleft", legend = misc$group_names, col = "2", 
         lty = as.integer(c(1, "2222", "5212")), cex = 0.8)
  
  # annual transition probabilities
  plot(cbind(surv_obs$tp$gr_1$time, surv_obs$tp$gr_1$smooth), lwd = 1, 
       lty = 1, type = "b", cex = 0.6, pch = 1, col = "black", 
       main = "B: Annual transition probability (Weibull)", 
       xlab = "time", ylab = "annual transition probability (smoothed)", 
       ylim = c(0, ceiling(surv_obs$tp$max * 10)/10), xlim = c(0, ceiling(surv_obs$km$maxtime * 10)/10))
  lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_1[, 3]), col = "2", lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(surv_obs$tp$gr_2$time, surv_obs$tp$gr_2$smooth), 
          col = "lightgrey", type = "b", lwd = 1, cex = 0.6, pch = 8)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_2[, 3]), col = "2", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(surv_obs$tp$gr_3$time, surv_obs$tp$gr_3$smooth), 
          col = "darkgrey", type = "b", lwd = 1, cex = 0.6, pch = 9)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_3[, 3]), col = "2", 
          lty = "5212", lwd = 2)
  }
  # add shading confidence intervals
  polygon(c(surv_obs$tp$gr_1$time, rev(surv_obs$tp$gr_1$time)), 
          c(surv_obs$tp$gr_1$smooth_lower, rev(surv_obs$tp$gr_1$smooth_upper)), 
          col = adjustcolor("black", alpha.f = 0.3), border = NA)
  if (misc$ngroups > 1) {
    polygon(c(surv_obs$tp$gr_2$time, rev(surv_obs$tp$gr_2$time)), 
            c(surv_obs$tp$gr_2$smooth_lower, rev(surv_obs$tp$gr_2$smooth_upper)), 
            col = adjustcolor("lightgrey", alpha.f = 0.3), border = NA)
  }
  if (misc$ngroups > 2) {
    polygon(c(surv_obs$tp$gr_3$time, rev(surv_obs$tp$gr_3$time)), 
            c(surv_obs$tp$gr_3$smooth_lower, rev(surv_obs$tp$gr_3$smooth_upper)), 
            col = adjustcolor("darkgrey", alpha.f = 0.3), border = NA)
  }
  legend("topleft", legend = misc$group_names, col = "2", 
         lty = as.integer(c(1, "2222", "5212")), cex = 0.8)
  
  # diagnostics
  plot(cbind(log(surv_obs$km$time), log(-log(surv_obs$km$surv))), cex = 0.6, pch = c(1, 8, 9)[surv_obs$km_names],
       xlim = c(floor(min(log(surv_obs$km$time)[surv_obs$km$surv != 1])), ceiling(max(log(surv_obs$km$time)))),
       col = c("black", "lightgrey", "darkgrey")[surv_obs$km_names], main = "C: Diagnostic plot (Weibull)", 
       xlab = "LN(time)", ylab = "LN(cumulative hazard)")
  lines(cbind(log(input$time_pred), log(-log(surv_pred$model$weib[, 2]))), col = "2", lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(log(input$time_pred), log(-log(surv_pred$model$weib[, 3]))), col = "2", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(log(input$time_pred), log(-log(surv_pred$model$weib[, 4]))), col = "2", lty = "5212", lwd = 2)
  }
  legend("topleft", legend = misc$group_names, col = "2", lty = as.integer(c(1, "2222", "5212")), cex = 0.8)
}, envir = PERSUADE)
```

##Gompertz
```{r gom, echo=FALSE, out.height = "30%", fig.width=11}
evalq({
  # monotonically increasing or decreasing hazard
  plot(surv_obs$km, lwd = 2, main = "A: Kaplan-Meier (Gompertz)", xlab = "time", 
       ylab = "survival", col = c("black", "lightgrey", "darkgrey"))
  lines(cbind(input$time_pred, surv_pred$model$gom[, 2]), col = "3", lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(input$time_pred, surv_pred$model$gom[, 3]), col = "3", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(input$time_pred, surv_pred$model$gom[, 4]), col = "3", lty = "5212", lwd = 2)
  }
  # add shading confidence intervals
  polygon(c(surv_obs$km$time[surv_obs$km_names == 1], rev(surv_obs$km$time[surv_obs$km_names == 1])),
          c(surv_obs$km$lower[surv_obs$km_names == 1], rev(surv_obs$km$upper[surv_obs$km_names == 1])), 
          col = adjustcolor("black", alpha.f = 0.3), border = NA)
  if (misc$ngroups > 1) {
    polygon(c(surv_obs$km$time[surv_obs$km_names == 2], rev(surv_obs$km$time[surv_obs$km_names == 2])),
            c(surv_obs$km$lower[surv_obs$km_names == 2], rev(surv_obs$km$upper[surv_obs$km_names == 2])),
            col = adjustcolor("lightgrey", alpha.f = 0.3), border = NA)
  }
  if (misc$ngroups > 2) {
    polygon(c(surv_obs$km$time[surv_obs$km_names == 3], rev(surv_obs$km$time[surv_obs$km_names == 3])),
            c(surv_obs$km$lower[surv_obs$km_names == 3], rev(surv_obs$km$upper[surv_obs$km_names == 3])), 
            col = adjustcolor("darkgrey", alpha.f = 0.3), border = NA)
  }
  legend("bottomleft", legend = misc$group_names, col = "3", lty = as.integer(c(1, "2222", "5212")), cex = 0.8)
  
  # annual transition probabilities
  plot(cbind(surv_obs$tp$gr_1$time, surv_obs$tp$gr_1$smooth), lwd = 1, 
       lty = 1, type = "b", cex = 0.6, pch = 1, col = "black", 
       main = "B: Annual transition probability (Gompertz)", 
       xlab = "time", ylab = "annual transition probability (smoothed)", 
       ylim = c(0, ceiling(surv_obs$tp$max * 10)/10), xlim = c(0, ceiling(surv_obs$km$maxtime * 10)/10))
  lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_1[, 4]), col = "3", 
        lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(surv_obs$tp$gr_2$time, surv_obs$tp$gr_2$smooth), 
          col = "lightgrey", type = "b", lwd = 1, cex = 0.6, pch = 8)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_2[, 4]), col = "3", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(surv_obs$tp$gr_3$time, surv_obs$tp$gr_3$smooth), 
          col = "darkgrey", type = "b", lwd = 1, cex = 0.6, pch = 9)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_3[, 4]), col = "3", lty = "5212", lwd = 2)
  }
  # add shading confidence intervals
  polygon(c(surv_obs$tp$gr_1$time, rev(surv_obs$tp$gr_1$time)), 
          c(surv_obs$tp$gr_1$smooth_lower, rev(surv_obs$tp$gr_1$smooth_upper)), 
          col = adjustcolor("black", alpha.f = 0.3), border = NA)
  if (misc$ngroups > 1) {
    polygon(c(surv_obs$tp$gr_2$time, rev(surv_obs$tp$gr_2$time)), 
            c(surv_obs$tp$gr_2$smooth_lower, rev(surv_obs$tp$gr_2$smooth_upper)), 
            col = adjustcolor("lightgrey", alpha.f = 0.3), border = NA)
  }
  if (misc$ngroups > 2) {
    polygon(c(surv_obs$tp$gr_3$time, rev(surv_obs$tp$gr_3$time)), 
            c(surv_obs$tp$gr_3$smooth_lower, rev(surv_obs$tp$gr_3$smooth_upper)), 
            col = adjustcolor("darkgrey", alpha.f = 0.3), border = NA)
  }
  legend("topleft", legend = misc$group_names, col = "3", 
         lty = as.integer(c(1, "2222", "5212")), cex = 0.8)
  
  # diagnostics
  plot(cbind(c(surv_obs$haz$smooth_gr1$est.grid, 
               if (misc$ngroups > 1) {surv_obs$haz$smooth_gr2$est.grid} else {NA}, 
               if (misc$ngroups > 2) {surv_obs$haz$smooth_gr3$est.grid} else {NA}),
             c(log(surv_obs$haz$smooth_gr1$haz.est), 
               if (misc$ngroups > 1) {log(surv_obs$haz$smooth_gr2$haz.est)} else {NA}, 
               if (misc$ngroups > 2) {log(surv_obs$haz$smooth_gr3$haz.est)} else {NA})), 
       cex = 0.6, main = "C: Diagnostic plot (Gompertz)", xlab = "time", ylab = "LN(smoothed hazard)", 
       pch = c(1, 8, 9)[surv_obs$haz$names], col = c("black", "lightgrey", "darkgrey")[surv_obs$haz$names])
  lines(cbind(surv_pred$model$gom_h[[1]]$time, log(surv_pred$model$gom_h[[1]]$est)), col = "3", lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(surv_pred$model$gom_h[[2]]$time, log(surv_pred$model$gom_h[[2]]$est)), 
          col = "3", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(surv_pred$model$gom_h[[3]]$time, log(surv_pred$model$gom_h[[3]]$est)), 
          col = "3", lty = "5212", lwd = 2)
  }
  legend("topleft", legend = misc$group_names, col = "3", 
         lty = as.integer(c(1, "2222", "5212")), cex = 0.8)
}, envir = PERSUADE)
```

##Log-normal
```{r lnorm, echo=FALSE, out.height = "30%", fig.width=11}
evalq({
  # hazard can be non-monotonic with respect to time; initially an increasing
  # hazard, followed by a decreasing hazard
  plot(surv_obs$km, lwd = 2, main = "A: Kaplan-Meier (Log-normal)", xlab = "time", 
       ylab = "survival", col = c("black", "lightgrey", "darkgrey"))
  lines(cbind(input$time_pred, surv_pred$model$lnorm[, 2]), col = "4", lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(input$time_pred, surv_pred$model$lnorm[, 3]), col = "4", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(input$time_pred, surv_pred$model$lnorm[, 4]), col = "4", lty = "5212", lwd = 2)
  }
  # add shading confidence intervals
  polygon(c(surv_obs$km$time[surv_obs$km_names == 1], rev(surv_obs$km$time[surv_obs$km_names == 1])),
          c(surv_obs$km$lower[surv_obs$km_names == 1], rev(surv_obs$km$upper[surv_obs$km_names == 1])), 
          col = adjustcolor("black", alpha.f = 0.3), border = NA)
  if (misc$ngroups > 1) {
    polygon(c(surv_obs$km$time[surv_obs$km_names == 2], rev(surv_obs$km$time[surv_obs$km_names == 2])),
            c(surv_obs$km$lower[surv_obs$km_names == 2], rev(surv_obs$km$upper[surv_obs$km_names == 2])),
            col = adjustcolor("lightgrey", alpha.f = 0.3), border = NA)
  }
  if (misc$ngroups > 2) {
    polygon(c(surv_obs$km$time[surv_obs$km_names == 3], rev(surv_obs$km$time[surv_obs$km_names == 3])),
            c(surv_obs$km$lower[surv_obs$km_names == 3], rev(surv_obs$km$upper[surv_obs$km_names == 3])),
            col = adjustcolor("darkgrey", alpha.f = 0.3), border = NA)
  }
  legend("bottomleft", legend = misc$group_names, col = "4", lty = as.integer(c(1, "2222", "5212")), cex = 0.8)
  
  # annual transition probabilities
  plot(cbind(surv_obs$tp$gr_1$time, surv_obs$tp$gr_1$smooth), lwd = 1, 
       lty = 1, type = "b", cex = 0.6, pch = 1, col = "black", 
       main = "B: Annual transition probability (Log-normal)", 
       xlab = "time", ylab = "annual transition probability (smoothed)", 
       ylim = c(0, ceiling(surv_obs$tp$max * 10)/10), xlim = c(0, ceiling(surv_obs$km$maxtime * 10)/10))
  lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_1[, 5]), col = "4", lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(surv_obs$tp$gr_2$time, surv_obs$tp$gr_2$smooth), 
          col = "lightgrey", type = "b", lwd = 1, cex = 0.6, pch = 8)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_2[, 5]), col = "4", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(surv_obs$tp$gr_3$time, surv_obs$tp$gr_3$smooth), 
          col = "darkgrey", type = "b", lwd = 1, cex = 0.6, pch = 9)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_3[, 5]), col = "4", lty = "5212", lwd = 2)
  }
  # add shading confidence intervals
  polygon(c(surv_obs$tp$gr_1$time, rev(surv_obs$tp$gr_1$time)), 
          c(surv_obs$tp$gr_1$smooth_lower, rev(surv_obs$tp$gr_1$smooth_upper)), 
          col = adjustcolor("black", alpha.f = 0.3), border = NA)
  if (misc$ngroups > 1) {
    polygon(c(surv_obs$tp$gr_2$time, rev(surv_obs$tp$gr_2$time)), 
            c(surv_obs$tp$gr_2$smooth_lower, rev(surv_obs$tp$gr_2$smooth_upper)), 
            col = adjustcolor("lightgrey", alpha.f = 0.3), border = NA)
  }
  if (misc$ngroups > 2) {
    polygon(c(surv_obs$tp$gr_3$time, rev(surv_obs$tp$gr_3$time)), 
            c(surv_obs$tp$gr_3$smooth_lower, rev(surv_obs$tp$gr_3$smooth_upper)), 
            col = adjustcolor("darkgrey", alpha.f = 0.3), border = NA)
  }
  legend("topleft", legend = misc$group_names, col = "4", 
         lty = as.integer(c(1, "2222", "5212")), cex = 0.8)
  
  # diagnostics
  plot(cbind(log(surv_obs$km$time), 
             -qnorm(surv_obs$km$surv, mean = 0, sd = 1, lower.tail = TRUE, log.p = FALSE)), 
       cex = 0.6, main = "C: Diagnostic plot (Log-normal)", xlab = "LN(time)", 
       xlim = c(floor(min(log(surv_obs$km$time)[surv_obs$km$surv != 1])), ceiling(max(log(surv_obs$km$time)))),
       pch = c(1, 8, 9)[surv_obs$km_names], col = c("black", "lightgrey", "darkgrey")[surv_obs$km_names], 
       ylab = "- standard normal quartiles")
  lines(cbind(log(input$time_pred), 
              -qnorm(surv_pred$model$lnorm[, 2], mean = 0, sd = 1, lower.tail = TRUE, log.p = FALSE)), 
        col = "4", lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(log(input$time_pred), 
                -qnorm(surv_pred$model$lnorm[, 3], mean = 0, sd = 1, lower.tail = TRUE, log.p = FALSE)),
          col = "4", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(log(input$time_pred), 
                -qnorm(surv_pred$model$lnorm[, 4], mean = 0, sd = 1, lower.tail = TRUE, log.p = FALSE)), 
          col = "4", lty = "5212", lwd = 2)
  }
  legend("topleft", legend = misc$group_names, col = "4", 
         lty = as.integer(c(1, "2222", "5212")), cex = 0.8)
}, envir = PERSUADE)
```

##Log-logistic
```{r llog, echo=FALSE, out.height = "30%", fig.width=11}
evalq({
  # hazard can be non-monotonic with respect to time; initially an increasing
  # hazard, followed by a decreasing hazard
  plot(surv_obs$km, lwd = 2, main = "A: Kaplan-Meier (Log-logistic)", xlab = "time", 
       ylab = "survival", col = c("black", "lightgrey", "darkgrey"))
  lines(cbind(input$time_pred, surv_pred$model$llog[, 2]), col = "5", lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(input$time_pred, surv_pred$model$llog[, 3]), col = "5", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(input$time_pred, surv_pred$model$llog[, 4]), col = "5", lty = "5212", lwd = 2)
  }
  # add shading confidence intervals
  polygon(c(surv_obs$km$time[surv_obs$km_names == 1], rev(surv_obs$km$time[surv_obs$km_names == 1])),
          c(surv_obs$km$lower[surv_obs$km_names == 1], rev(surv_obs$km$upper[surv_obs$km_names == 1])), 
          col = adjustcolor("black", alpha.f = 0.3), border = NA)
  if (misc$ngroups > 1) {
    polygon(c(surv_obs$km$time[surv_obs$km_names == 2], rev(surv_obs$km$time[surv_obs$km_names == 2])),
            c(surv_obs$km$lower[surv_obs$km_names == 2], rev(surv_obs$km$upper[surv_obs$km_names == 2])), 
            col = adjustcolor("lightgrey", alpha.f = 0.3), border = NA)
  }
  if (misc$ngroups > 2) {
    polygon(c(surv_obs$km$time[surv_obs$km_names == 3], rev(surv_obs$km$time[surv_obs$km_names == 3])),
            c(surv_obs$km$lower[surv_obs$km_names == 3], rev(surv_obs$km$upper[surv_obs$km_names == 3])),
            col = adjustcolor("darkgrey", alpha.f = 0.3), border = NA)
  }
  legend("bottomleft", legend = misc$group_names, col = "5", 
         lty = as.integer(c(1, "2222", "5212")), cex = 0.8)
  
  # annual transition probabilities
  plot(cbind(surv_obs$tp$gr_1$time, surv_obs$tp$gr_1$smooth), lwd = 1, 
       lty = 1, type = "b", cex = 0.6, pch = 1, col = "black", 
       main = "B: Annual transition probability (Log-logistic)", 
       xlab = "time", ylab = "annual transition probability (smoothed)", 
       ylim = c(0, ceiling(surv_obs$tp$max * 10)/10), xlim = c(0, ceiling(surv_obs$km$maxtime * 10)/10))
  lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_1[, 6]), col = "5", 
        lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(surv_obs$tp$gr_2$time, surv_obs$tp$gr_2$smooth), 
          col = "lightgrey", type = "b", lwd = 1, cex = 0.6, pch = 8)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_2[, 6]), col = "5", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(surv_obs$tp$gr_3$time, surv_obs$tp$gr_3$smooth), 
          col = "darkgrey", type = "b", lwd = 1, cex = 0.6, pch = 9)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_3[, 6]), col = "5", lty = "5212", lwd = 2)
  }
  # add shading confidence intervals
  polygon(c(surv_obs$tp$gr_1$time, rev(surv_obs$tp$gr_1$time)), 
          c(surv_obs$tp$gr_1$smooth_lower, rev(surv_obs$tp$gr_1$smooth_upper)), 
          col = adjustcolor("black", alpha.f = 0.3), border = NA)
  if (misc$ngroups > 1) {
    polygon(c(surv_obs$tp$gr_2$time, rev(surv_obs$tp$gr_2$time)), 
            c(surv_obs$tp$gr_2$smooth_lower, rev(surv_obs$tp$gr_2$smooth_upper)), 
            col = adjustcolor("lightgrey", alpha.f = 0.3), border = NA)
  }
  if (misc$ngroups > 2) {
    polygon(c(surv_obs$tp$gr_3$time, rev(surv_obs$tp$gr_3$time)), 
            c(surv_obs$tp$gr_3$smooth_lower, rev(surv_obs$tp$gr_3$smooth_upper)), 
            col = adjustcolor("darkgrey", alpha.f = 0.3), border = NA)
  }
  legend("topleft", legend = misc$group_names, col = "5", 
         lty = as.integer(c(1, "2222", "5212")), cex = 0.8)
  
  # diagnostics
  plot(cbind(log(surv_obs$km$time), -log(surv_obs$km$surv/(1 - surv_obs$km$surv))), 
       cex = 0.6, pch = c(1, 8, 9)[surv_obs$km_names], 
       col = c("black", "lightgrey", "darkgrey")[surv_obs$km_names],
       xlim = c(floor(min(log(surv_obs$km$time)[surv_obs$km$surv != 1])), 
                ceiling(max(log(surv_obs$km$time)))), main = "C: Diagnostic plot (Log-logistic)", 
       xlab = "LN(time)", ylab = "-LN(survival odds)")
  lines(cbind(log(input$time_pred), 
              -log(surv_pred$model$llog[, 2]/(1 - surv_pred$model$llog[, 2]))),
        col = "5", lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(log(input$time_pred), 
                -log(surv_pred$model$llog[, 3]/(1 - surv_pred$model$llog[, 3]))), 
          col = "5", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(log(input$time_pred), 
                -log(surv_pred$model$llog[, 4]/(1 - surv_pred$model$llog[, 4]))),
          col = "5", lty = "5212", lwd = 2)
  }
  legend("topleft", legend = misc$group_names, col = "5", 
         lty = as.integer(c(1, "2222", "5212")), cex = 0.8)
}, envir = PERSUADE)
```

##Gamma
```{r gam, echo=FALSE, out.height = "30%", fig.width=11}
evalq({
  # hazard rate has (inverted) 'U' shape over time
  plot(surv_obs$km, lwd = 2, main = "A: Kaplan-Meier (Gamma)", xlab = "time", ylab = "survival", 
       col = c("black", "lightgrey", "darkgrey"))
  lines(cbind(input$time_pred, surv_pred$model$gam[, 2]), col = "6", lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(input$time_pred, surv_pred$model$gam[, 3]), col = "6", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(input$time_pred, surv_pred$model$gam[, 4]), col = "6", lty = "5212", lwd = 2)
  }
  # add shading confidence intervals
  polygon(c(surv_obs$km$time[surv_obs$km_names == 1], rev(surv_obs$km$time[surv_obs$km_names == 1])), 
          c(surv_obs$km$lower[surv_obs$km_names == 1], rev(surv_obs$km$upper[surv_obs$km_names == 1])), 
          col = adjustcolor("black", alpha.f = 0.3), border = NA)
  if (misc$ngroups > 1) {
    polygon(c(surv_obs$km$time[surv_obs$km_names == 2], rev(surv_obs$km$time[surv_obs$km_names == 2])),
            c(surv_obs$km$lower[surv_obs$km_names == 2], rev(surv_obs$km$upper[surv_obs$km_names == 2])),
            col = adjustcolor("lightgrey", alpha.f = 0.3), border = NA)
  }
  if (misc$ngroups > 2) {
    polygon(c(surv_obs$km$time[surv_obs$km_names == 3], rev(surv_obs$km$time[surv_obs$km_names == 3])),
            c(surv_obs$km$lower[surv_obs$km_names == 3], rev(surv_obs$km$upper[surv_obs$km_names == 3])), 
            col = adjustcolor("darkgrey", alpha.f = 0.3), border = NA)
  }
  legend("bottomleft", legend = misc$group_names, col = "6", 
         lty = as.integer(c(1, "2222", "5212")), cex = 0.8)
  
  # annual transition probabilities
  plot(cbind(surv_obs$tp$gr_1$time, surv_obs$tp$gr_1$smooth), lwd = 1, 
       lty = 1, type = "b", cex = 0.6, pch = 1, col = "black", 
       main = "B: Annual transition probability (Gamma)", 
       xlab = "time", ylab = "annual transition probability (smoothed)", 
       ylim = c(0, ceiling(surv_obs$tp$max * 10)/10), xlim = c(0, ceiling(surv_obs$km$maxtime * 10)/10))
  lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_1[, 7]), col = "6", lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(surv_obs$tp$gr_2$time, surv_obs$tp$gr_2$smooth), 
          col = "lightgrey", type = "b", lwd = 1, cex = 0.6, pch = 8)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_2[, 7]), col = "6", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(surv_obs$tp$gr_3$time, surv_obs$tp$gr_3$smooth), 
          col = "darkgrey", type = "b", lwd = 1, cex = 0.6, pch = 9)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_3[, 7]), col = "6", lty = "5212", lwd = 2)
  }
  # add shading confidence intervals
  polygon(c(surv_obs$tp$gr_1$time, rev(surv_obs$tp$gr_1$time)), 
          c(surv_obs$tp$gr_1$smooth_lower, rev(surv_obs$tp$gr_1$smooth_upper)), 
          col = adjustcolor("black", alpha.f = 0.3), border = NA)
  if (misc$ngroups > 1) {
    polygon(c(surv_obs$tp$gr_2$time, rev(surv_obs$tp$gr_2$time)), 
            c(surv_obs$tp$gr_2$smooth_lower, rev(surv_obs$tp$gr_2$smooth_upper)), 
            col = adjustcolor("lightgrey", alpha.f = 0.3), border = NA)
  }
  if (misc$ngroups > 2) {
    polygon(c(surv_obs$tp$gr_3$time, rev(surv_obs$tp$gr_3$time)), 
            c(surv_obs$tp$gr_3$smooth_lower, rev(surv_obs$tp$gr_3$smooth_upper)), 
            col = adjustcolor("darkgrey", alpha.f = 0.3), border = NA)
  }
  legend("topleft", legend = misc$group_names, col = "6", 
         lty = as.integer(c(1, "2222", "5212")), cex = 0.8)
  
  # diagnostics --> not linear!
  plot(cbind(log(surv_obs$km$time), log(-log(surv_obs$km$surv))), cex = 0.6, 
       pch = c(1, 8, 9)[surv_obs$km_names], 
       xlim = c(floor(min(log(surv_obs$km$time)[surv_obs$km$surv != 1])), 
                ceiling(max(log(surv_obs$km$time)))), 
       col = c("black", "lightgrey", "darkgrey")[surv_obs$km_names], 
       main = "C: Diagnostic plot (Gamma)", xlab = "LN(time)", ylab = "LN(cumulative hazard)")
  lines(cbind(log(input$time_pred), log(-log(surv_pred$model$gam[, 2]))), col = "6", lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(log(input$time_pred), log(-log(surv_pred$model$gam[, 3]))), col = "6", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(log(input$time_pred), log(-log(surv_pred$model$gam[, 4]))), col = "6", lty = "5212", lwd = 2)
  }
  legend("topleft", legend = misc$group_names, col = "6", 
         lty = as.integer(c(1, "2222", "5212")), cex = 0.8)
}, envir = PERSUADE)
```

##Generalised Gamma 
```{r ggam, echo=FALSE, out.height = "30%", fig.width=11}
evalq({
  # more flexible: can take form of Exponential, Weibull, Gamma or Log-normal
  plot(surv_obs$km, lwd = 2, main = "A: Kaplan-Meier (Generalised gamma)", xlab = "time", 
       ylab = "survival", col = c("black", "lightgrey", "darkgrey"))
  lines(cbind(input$time_pred, surv_pred$model$ggam[, 2]), col = "7", lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(input$time_pred, surv_pred$model$ggam[, 3]), col = "7", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(input$time_pred, surv_pred$model$ggam[, 4]), col = "7", lty = "5212", lwd = 2)
  }
  # add shading confidence intervals
  polygon(c(surv_obs$km$time[surv_obs$km_names == 1], rev(surv_obs$km$time[surv_obs$km_names == 1])),
          c(surv_obs$km$lower[surv_obs$km_names == 1], rev(surv_obs$km$upper[surv_obs$km_names == 1])), 
          col = adjustcolor("black", alpha.f = 0.3), border = NA)
  if (misc$ngroups > 1) {
    polygon(c(surv_obs$km$time[surv_obs$km_names == 2], rev(surv_obs$km$time[surv_obs$km_names == 2])),
            c(surv_obs$km$lower[surv_obs$km_names == 2], rev(surv_obs$km$upper[surv_obs$km_names == 2])), 
            col = adjustcolor("lightgrey", alpha.f = 0.3), border = NA)
  }
  if (misc$ngroups > 2) {
    polygon(c(surv_obs$km$time[surv_obs$km_names == 3], rev(surv_obs$km$time[surv_obs$km_names == 3])),
            c(surv_obs$km$lower[surv_obs$km_names == 3], rev(surv_obs$km$upper[surv_obs$km_names == 3])), 
            col = adjustcolor("darkgrey", alpha.f = 0.3), border = NA)
  }
  legend("bottomleft", legend = misc$group_names, col = "7", 
         lty = as.integer(c(1, "2222", "5212")), cex = 0.8)
  
  # annual transition probabilities
  plot(cbind(surv_obs$tp$gr_1$time, surv_obs$tp$gr_1$smooth), lwd = 1, 
       lty = 1, type = "b", cex = 0.6, pch = 1, col = "black", 
       main = "B: Annual transition probability (Generalised Gamma)", 
       xlab = "time", ylab = "annual transition probability (smoothed)", 
       ylim = c(0, ceiling(surv_obs$tp$max * 10)/10), xlim = c(0, ceiling(surv_obs$km$maxtime * 10)/10))
  lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_1[, 8]), col = "7", lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(surv_obs$tp$gr_2$time, surv_obs$tp$gr_2$smooth), 
          col = "lightgrey", type = "b", lwd = 1, cex = 0.6, pch = 8)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_2[, 8]), col = "7", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(surv_obs$tp$gr_3$time, surv_obs$tp$gr_3$smooth), 
          col = "darkgrey", type = "b", lwd = 1, cex = 0.6, pch = 9)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_3[, 8]), col = "7", lty = "5212", lwd = 2)
  }
  # add shading confidence intervals
  polygon(c(surv_obs$tp$gr_1$time, rev(surv_obs$tp$gr_1$time)), 
          c(surv_obs$tp$gr_1$smooth_lower, rev(surv_obs$tp$gr_1$smooth_upper)), 
          col = adjustcolor("black", alpha.f = 0.3), border = NA)
  if (misc$ngroups > 1) {
    polygon(c(surv_obs$tp$gr_2$time, rev(surv_obs$tp$gr_2$time)), 
            c(surv_obs$tp$gr_2$smooth_lower, rev(surv_obs$tp$gr_2$smooth_upper)), 
            col = adjustcolor("lightgrey", alpha.f = 0.3), border = NA)
  }
  if (misc$ngroups > 2) {
    polygon(c(surv_obs$tp$gr_3$time, rev(surv_obs$tp$gr_3$time)), 
            c(surv_obs$tp$gr_3$smooth_lower, rev(surv_obs$tp$gr_3$smooth_upper)), 
            col = adjustcolor("darkgrey", alpha.f = 0.3), border = NA)
  }
  legend("topleft", legend = misc$group_names, col = "7", 
         lty = as.integer(c(1, "2222", "5212")), cex = 0.8)
  
  # diagnostics --> not linear!
  plot(cbind(log(surv_obs$km$time), log(-log(surv_obs$km$surv))), cex = 0.6, 
       pch = c(1, 8, 9)[surv_obs$km_names], 
       xlim = c(floor(min(log(surv_obs$km$time)[surv_obs$km$surv != 1])), 
                ceiling(max(log(surv_obs$km$time)))), 
       col = c("black", "lightgrey", "darkgrey")[surv_obs$km_names], 
       main = "C: Diagnostic plot (Generalised gamma)", 
       xlab = "LN(time)", ylab = "LN(cumulative hazard)")
  lines(cbind(log(input$time_pred), log(-log(surv_pred$model$ggam[, 2]))), col = "7", lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(log(input$time_pred), log(-log(surv_pred$model$ggam[, 3]))), col = "7", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(log(input$time_pred), log(-log(surv_pred$model$ggam[, 4]))), col = "7", lty = "5212", lwd = 2)
  }
  legend("topleft", legend = misc$group_names, col = "7", lty = as.integer(c(1, "2222", "5212")), cex = 0.8)
}, envir = PERSUADE)
```

\newpage

#Parametric spline models?
If standard parametric models are not appropriate, are spline models a more appropriate fit to the data?

```{r spline, echo=FALSE, eval = PERSUADE$input$spline_mod}
evalq({
  # k=0 gives a Weibull, log-logistic or log-normal model, if 'scale' is 'hazard',
  # 'odds' or 'normal' respectively. The knots are then chosen as equally-spaced
  # quantiles of the log uncensored survival times, for example, at the median with
  # one knot, or at the 33% and 67% quantiles of log time (or time, see
  # 'timescale') with two knots.
  
  pie(rep(1, n), labels = misc$lbls_spline, 
      col = rainbow(n = n, s = 1, v = 1, start = 0, end = max(1, n - 1)/n, alpha = 1))
  
  kable_styling(kable(rbind(surv_model$IC, 
                            surv_model$IC_spl)[order(rbind(surv_model$IC, surv_model$IC_spl)$AIC), ], 
                      format = "latex", row.names = FALSE, booktabs = TRUE, 
                      linesep = ""), latex_options = "striped")
}, envir = PERSUADE)
```

##Spline hazard 1 knot
```{r spline_hazard1, echo=FALSE, out.height = "30%", fig.width=11, eval = PERSUADE$input$spline_mod}
evalq({
  # 1 knot
  plot(surv_obs$km, lwd = 2, main = "A: Kaplan-Meier (Spline, 1 knot, hazard scale)", 
       xlab = "time", ylab = "survival", col = c("black", "lightgrey", "darkgrey"))
  lines(cbind(input$time_pred, surv_pred$model$spl_hazard1[, 2]), col = "1", lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(input$time_pred, surv_pred$model$spl_hazard1[, 3]), col = "1", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(input$time_pred, surv_pred$model$spl_hazard1[, 4]), col = "1", lty = "5212", lwd = 2)
  }
  # add shading confidence intervals
  polygon(c(surv_obs$km$time[surv_obs$km_names == 1], rev(surv_obs$km$time[surv_obs$km_names == 1])),
          c(surv_obs$km$lower[surv_obs$km_names == 1], rev(surv_obs$km$upper[surv_obs$km_names == 1])), 
          col = adjustcolor("black", alpha.f = 0.3), border = NA)
  if (misc$ngroups > 1) {
    polygon(c(surv_obs$km$time[surv_obs$km_names == 2], rev(surv_obs$km$time[surv_obs$km_names == 2])),
            c(surv_obs$km$lower[surv_obs$km_names == 2], rev(surv_obs$km$upper[surv_obs$km_names == 2])), 
            col = adjustcolor("lightgrey", alpha.f = 0.3), border = NA)
  }
  if (misc$ngroups > 2) {
    polygon(c(surv_obs$km$time[surv_obs$km_names == 3], rev(surv_obs$km$time[surv_obs$km_names == 3])),
            c(surv_obs$km$lower[surv_obs$km_names == 3], rev(surv_obs$km$upper[surv_obs$km_names == 3])), 
            col = adjustcolor("darkgrey", alpha.f = 0.3), border = NA)
  }
  abline(v = exp(surv_model$spl_hazard1$knots[2]), lty = 2, lwd = 1.5)
  abline(v = exp(surv_model$spl_hazard1$knots[1]), lty = 3, lwd = 1)
  abline(v = exp(surv_model$spl_hazard1$knots[3]), lty = 3, lwd = 1)
  legend("bottomleft", legend = misc$group_names, col = "1", 
         lty = as.integer(c(1, "2222", "5212")), cex = 0.8)
  
  # annual transition probabilities
  plot(cbind(surv_obs$tp$gr_1$time, surv_obs$tp$gr_1$smooth), lwd = 1, 
       lty = 1, type = "b", cex = 0.6, pch = 1, col = "black", 
       main = "B: Annual transition probability (Spline, 1 knot, hazard scale)", 
       xlab = "time", ylab = "annual transition probability (smoothed)", 
       ylim = c(0, ceiling(surv_obs$tp$max * 10)/10), xlim = c(0, ceiling(surv_obs$km$maxtime * 10)/10))
  lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_1[, 9]), col = "1", lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(surv_obs$tp$gr_2$time, surv_obs$tp$gr_2$smooth), 
          col = "lightgrey", type = "b", lwd = 1, cex = 0.6, pch = 8)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_2[, 9]), col = "1", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(surv_obs$tp$gr_3$time, surv_obs$tp$gr_3$smooth), 
          col = "darkgrey", type = "b", lwd = 1, cex = 0.6, pch = 9)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_3[, 9]), col = "1", lty = "5212", lwd = 2)
  }
  # add shading confidence intervals
  polygon(c(surv_obs$tp$gr_1$time, rev(surv_obs$tp$gr_1$time)), 
          c(surv_obs$tp$gr_1$smooth_lower, rev(surv_obs$tp$gr_1$smooth_upper)), 
          col = adjustcolor("black", alpha.f = 0.3), border = NA)
  if (misc$ngroups > 1) {
    polygon(c(surv_obs$tp$gr_2$time, rev(surv_obs$tp$gr_2$time)), 
            c(surv_obs$tp$gr_2$smooth_lower, rev(surv_obs$tp$gr_2$smooth_upper)), 
            col = adjustcolor("lightgrey", alpha.f = 0.3), border = NA)
  }
  if (misc$ngroups > 2) {
    polygon(c(surv_obs$tp$gr_3$time, rev(surv_obs$tp$gr_3$time)), 
            c(surv_obs$tp$gr_3$smooth_lower, rev(surv_obs$tp$gr_3$smooth_upper)), 
            col = adjustcolor("darkgrey", alpha.f = 0.3), border = NA)
  }
  abline(v = exp(surv_model$spl_hazard1$knots[2]), lty = 2, lwd = 1.5)
  abline(v = exp(surv_model$spl_hazard1$knots[1]), lty = 3, lwd = 1)
  abline(v = exp(surv_model$spl_hazard1$knots[3]), lty = 3, lwd = 1)
  legend("topleft", legend = misc$group_names, col = "1", 
         lty = as.integer(c(1, "2222", "5212")), cex = 0.8)
  
  # diagnostics
  plot(cbind(log(surv_obs$km$time), log(-log(surv_obs$km$surv))), cex = 0.6, 
       pch = c(1, 8, 9)[surv_obs$km_names], 
       xlim = c(floor(min(log(surv_obs$km$time)[surv_obs$km$surv != 1])), 
                ceiling(max(log(surv_obs$km$time)))), 
       col = c("black", "lightgrey", "darkgrey")[surv_obs$km_names], 
       main = "C: Diagnostic plot (Spline, 1 knot, hazard scale)", 
       xlab = "LN(time)", ylab = "LN(cumulative hazard)")
  lines(cbind(log(input$time_pred), log(-log(surv_pred$model$spl_hazard1[, 2]))), 
        col = "1", lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(log(input$time_pred), log(-log(surv_pred$model$spl_hazard1[, 3]))), 
          col = "1", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(log(input$time_pred), log(-log(surv_pred$model$spl_hazard1[, 4]))), 
          col = "1", lty = "5212", lwd = 2)
  }
  abline(v = surv_model$spl_hazard1$knots[2], lty = 2, lwd = 1.5)
  abline(v = surv_model$spl_hazard1$knots[1], lty = 3, lwd = 1)
  abline(v = surv_model$spl_hazard1$knots[3], lty = 3, lwd = 1)
  legend("topleft", legend = misc$group_names, col = "1", 
         lty = as.integer(c(1, "2222", "5212")), cex = 0.8)
}, envir = PERSUADE)
```

##Spline hazard 2 knots
```{r spline_hazard2, echo=FALSE, out.height = "30%", fig.width=11, eval = PERSUADE$input$spline_mod}
evalq({
  # 2 knots
  plot(surv_obs$km, lwd = 2, main = "A: Kaplan-Meier (Spline, 2 knots, hazard scale)", 
       xlab = "time", ylab = "survival", col = c("black", "lightgrey", "darkgrey"))
  lines(cbind(input$time_pred, surv_pred$model$spl_hazard2[, 2]), col = "2", lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(input$time_pred, surv_pred$model$spl_hazard2[, 3]), col = "2", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(input$time_pred, surv_pred$model$spl_hazard2[, 4]), col = "2", lty = "5212", lwd = 2)
  }
  # add shading confidence intervals
  polygon(c(surv_obs$km$time[surv_obs$km_names == 1], rev(surv_obs$km$time[surv_obs$km_names == 1])),
          c(surv_obs$km$lower[surv_obs$km_names == 1], rev(surv_obs$km$upper[surv_obs$km_names == 1])), 
          col = adjustcolor("black", alpha.f = 0.3), border = NA)
  if (misc$ngroups > 1) {
    polygon(c(surv_obs$km$time[surv_obs$km_names == 2], rev(surv_obs$km$time[surv_obs$km_names == 2])), c(surv_obs$km$lower[surv_obs$km_names == 2], rev(surv_obs$km$upper[surv_obs$km_names == 2])), 
            col = adjustcolor("lightgrey", alpha.f = 0.3), border = NA)
  }
  if (misc$ngroups > 2) {
    polygon(c(surv_obs$km$time[surv_obs$km_names == 3], rev(surv_obs$km$time[surv_obs$km_names == 3])),
            c(surv_obs$km$lower[surv_obs$km_names == 3], rev(surv_obs$km$upper[surv_obs$km_names == 3])),
            col = adjustcolor("darkgrey", alpha.f = 0.3), border = NA)
  }
  abline(v = exp(surv_model$spl_hazard2$knots[2]), lty = 2, lwd = 1.5)
  abline(v = exp(surv_model$spl_hazard2$knots[3]), lty = 2, lwd = 1.5)
  abline(v = exp(surv_model$spl_hazard2$knots[1]), lty = 3, lwd = 1)
  abline(v = exp(surv_model$spl_hazard2$knots[4]), lty = 3, lwd = 1)
  legend("bottomleft", legend = misc$group_names, col = "2", 
         lty = as.integer(c(1, "2222", "5212")), cex = 0.8)
  
  # annual transition probabilities
  plot(cbind(surv_obs$tp$gr_1$time, surv_obs$tp$gr_1$smooth), lwd = 1, 
       lty = 1, type = "b", cex = 0.6, pch = 1, col = "black", 
       main = "B: Annual transition probability (Spline, 2 knots, hazard scale)", 
       xlab = "time", ylab = "annual transition probability (smoothed)", 
       ylim = c(0, ceiling(surv_obs$tp$max * 10)/10), xlim = c(0, ceiling(surv_obs$km$maxtime * 10)/10))
  lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_1[, 10]), col = "2", lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(surv_obs$tp$gr_2$time, surv_obs$tp$gr_2$smooth), 
          col = "lightgrey", type = "b", lwd = 1, cex = 0.6, pch = 8)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_2[, 10]), col = "2", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(surv_obs$tp$gr_3$time, surv_obs$tp$gr_3$smooth), 
          col = "darkgrey", type = "b", lwd = 1, cex = 0.6, pch = 9)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_3[, 10]), col = "2", lty = "5212", lwd = 2)
  }
  # add shading confidence intervals
  polygon(c(surv_obs$tp$gr_1$time, rev(surv_obs$tp$gr_1$time)), 
          c(surv_obs$tp$gr_1$smooth_lower, rev(surv_obs$tp$gr_1$smooth_upper)), 
          col = adjustcolor("black", alpha.f = 0.3), border = NA)
  if (misc$ngroups > 1) {
    polygon(c(surv_obs$tp$gr_2$time, rev(surv_obs$tp$gr_2$time)), 
            c(surv_obs$tp$gr_2$smooth_lower, rev(surv_obs$tp$gr_2$smooth_upper)), 
            col = adjustcolor("lightgrey", alpha.f = 0.3), border = NA)
  }
  if (misc$ngroups > 2) {
    polygon(c(surv_obs$tp$gr_3$time, rev(surv_obs$tp$gr_3$time)), 
            c(surv_obs$tp$gr_3$smooth_lower, rev(surv_obs$tp$gr_3$smooth_upper)), 
            col = adjustcolor("darkgrey", alpha.f = 0.3), border = NA)
  }
  abline(v = exp(surv_model$spl_hazard2$knots[2]), lty = 2, lwd = 1.5)
  abline(v = exp(surv_model$spl_hazard2$knots[3]), lty = 2, lwd = 1.5)
  abline(v = exp(surv_model$spl_hazard2$knots[1]), lty = 3, lwd = 1)
  abline(v = exp(surv_model$spl_hazard2$knots[4]), lty = 3, lwd = 1)
  legend("topleft", legend = misc$group_names, col = "2", 
         lty = as.integer(c(1, "2222", "5212")), cex = 0.8)
  
  # diagnostics
  plot(cbind(log(surv_obs$km$time), log(-log(surv_obs$km$surv))), cex = 0.6, 
       pch = c(1, 8, 9)[surv_obs$km_names], 
       xlim = c(floor(min(log(surv_obs$km$time)[surv_obs$km$surv != 1])), 
                ceiling(max(log(surv_obs$km$time)))), 
       col = c("black", "lightgrey", "darkgrey")[surv_obs$km_names], 
       main = "C: Diagnostic plot (Spline, 2 knots, hazard scale)", 
       xlab = "LN(time)", ylab = "LN(cumulative hazard)")
  lines(cbind(log(input$time_pred), log(-log(surv_pred$model$spl_hazard2[, 2]))), 
        col = "2", lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(log(input$time_pred), log(-log(surv_pred$model$spl_hazard2[, 3]))), 
          col = "2", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(log(input$time_pred), log(-log(surv_pred$model$spl_hazard2[, 4]))), 
          col = "2", lty = "5212", lwd = 2)
  }
  abline(v = surv_model$spl_hazard2$knots[2], lty = 2, lwd = 1.5)
  abline(v = surv_model$spl_hazard2$knots[3], lty = 2, lwd = 1.5)
  abline(v = surv_model$spl_hazard2$knots[1], lty = 3, lwd = 1)
  abline(v = surv_model$spl_hazard2$knots[4], lty = 3, lwd = 1)
  legend("topleft", legend = misc$group_names, col = "2", 
         lty = as.integer(c(1, "2222", "5212")), cex = 0.8)
}, envir = PERSUADE)
```

##Spline odds 1 knot
```{r spline_odds1, echo=FALSE, out.height = "30%", fig.width=11, eval = PERSUADE$input$spline_mod}
evalq({
  # 1 knot
  plot(surv_obs$km, lwd = 2, main = "A: Kaplan-Meier (Spline, 1 knot, odds scale)", 
       xlab = "time", ylab = "survival", col = c("black", "lightgrey", "darkgrey"))
  lines(cbind(input$time_pred, surv_pred$model$spl_odds1[, 2]), col = "3", lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(input$time_pred, surv_pred$model$spl_odds1[, 3]), col = "3", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(input$time_pred, surv_pred$model$spl_odds1[, 4]), col = "3", lty = "5212", lwd = 2)
  }
  # add shading confidence intervals
  polygon(c(surv_obs$km$time[surv_obs$km_names == 1], rev(surv_obs$km$time[surv_obs$km_names == 1])),
          c(surv_obs$km$lower[surv_obs$km_names == 1], rev(surv_obs$km$upper[surv_obs$km_names == 1])), 
          col = adjustcolor("black", alpha.f = 0.3), border = NA)
  if (misc$ngroups > 1) {
    polygon(c(surv_obs$km$time[surv_obs$km_names == 2], rev(surv_obs$km$time[surv_obs$km_names == 2])),
            c(surv_obs$km$lower[surv_obs$km_names == 2], rev(surv_obs$km$upper[surv_obs$km_names == 2])), 
            col = adjustcolor("lightgrey", alpha.f = 0.3), border = NA)
  }
  if (misc$ngroups > 2) {
    polygon(c(surv_obs$km$time[surv_obs$km_names == 3], rev(surv_obs$km$time[surv_obs$km_names == 3])),
            c(surv_obs$km$lower[surv_obs$km_names == 3], rev(surv_obs$km$upper[surv_obs$km_names == 3])), 
            col = adjustcolor("darkgrey", alpha.f = 0.3), border = NA)
  }
  abline(v = exp(surv_model$spl_odds1$knots[2]), lty = 2, lwd = 1.5)
  abline(v = exp(surv_model$spl_odds1$knots[1]), lty = 3, lwd = 1)
  abline(v = exp(surv_model$spl_odds1$knots[3]), lty = 3, lwd = 1)
  legend("bottomleft", legend = misc$group_names, col = "3", 
         lty = as.integer(c(1, "2222", "5212")), cex = 0.8)
  
  # annual transition probabilities
  plot(cbind(surv_obs$tp$gr_1$time, surv_obs$tp$gr_1$smooth), lwd = 1, 
       lty = 1, type = "b", cex = 0.6, pch = 1, col = "black",
       main = "B: Annual transition probability (Spline, 1 knot, odds scale)", 
       xlab = "time", ylab = "annual transition probability (smoothed)", 
       ylim = c(0, ceiling(surv_obs$tp$max * 10)/10), xlim = c(0, ceiling(surv_obs$km$maxtime * 10)/10))
  lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_1[, 11]), col = "3", lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(surv_obs$tp$gr_2$time, surv_obs$tp$gr_2$smooth), 
          col = "lightgrey", type = "b", lwd = 1, cex = 0.6, pch = 8)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_2[, 11]), col = "3", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(surv_obs$tp$gr_3$time, surv_obs$tp$gr_3$smooth), 
          col = "darkgrey", type = "b", lwd = 1, cex = 0.6, pch = 9)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_3[, 11]), col = "3", lty = "5212", lwd = 2)
  }
  # add shading confidence intervals
  polygon(c(surv_obs$tp$gr_1$time, rev(surv_obs$tp$gr_1$time)), 
          c(surv_obs$tp$gr_1$smooth_lower, rev(surv_obs$tp$gr_1$smooth_upper)), 
          col = adjustcolor("black", alpha.f = 0.3), border = NA)
  if (misc$ngroups > 1) {
    polygon(c(surv_obs$tp$gr_2$time, rev(surv_obs$tp$gr_2$time)), 
            c(surv_obs$tp$gr_2$smooth_lower, rev(surv_obs$tp$gr_2$smooth_upper)), 
            col = adjustcolor("lightgrey", alpha.f = 0.3), border = NA)
  }
  if (misc$ngroups > 2) {
    polygon(c(surv_obs$tp$gr_3$time, rev(surv_obs$tp$gr_3$time)), 
            c(surv_obs$tp$gr_3$smooth_lower, rev(surv_obs$tp$gr_3$smooth_upper)), 
            col = adjustcolor("darkgrey", alpha.f = 0.3), border = NA)
  }
  abline(v = exp(surv_model$spl_odds1$knots[2]), lty = 2, lwd = 1.5)
  abline(v = exp(surv_model$spl_odds1$knots[1]), lty = 3, lwd = 1)
  abline(v = exp(surv_model$spl_odds1$knots[3]), lty = 3, lwd = 1)
  legend("topleft", legend = misc$group_names, col = "3", 
         lty = as.integer(c(1, "2222", "5212")), cex = 0.8)
  
  # diagnostics
  plot(cbind(log(surv_obs$km$time), -log(surv_obs$km$surv/(1 - surv_obs$km$surv))), 
       cex = 0.6, pch = c(1, 8, 9)[surv_obs$km_names], 
       col = c("black", "lightgrey", "darkgrey")[surv_obs$km_names], 
       main = "C: Diagnostic plot (Spline, 1 knot, odds scale)", 
       xlim = c(floor(min(log(surv_obs$km$time)[surv_obs$km$surv != 1])), ceiling(max(log(surv_obs$km$time)))), 
       xlab = "LN(time)", ylab = "-LN(survival odds)")
  lines(cbind(log(input$time_pred), 
              -log(surv_pred$model$spl_odds1[, 2]/(1 - surv_pred$model$spl_odds1[, 2]))), 
        col = "3", lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(log(input$time_pred), 
                -log(surv_pred$model$spl_odds1[, 3]/(1 - surv_pred$model$spl_odds1[, 3]))),
          col = "3", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(log(input$time_pred), 
                -log(surv_pred$model$spl_odds1[, 4]/(1 - surv_pred$model$spl_odds1[, 4]))), 
          col = "3", lty = "5212", lwd = 2)
  }
  abline(v = surv_model$spl_odds1$knots[2], lty = 2, lwd = 1.5)
  abline(v = surv_model$spl_odds1$knots[1], lty = 3, lwd = 1)
  abline(v = surv_model$spl_odds1$knots[3], lty = 3, lwd = 1)
  legend("topleft", legend = misc$group_names, col = "3", 
         lty = as.integer(c(1, "2222", "5212")), cex = 0.8)
}, envir = PERSUADE)
```

##Spline odds 2 knots
```{r spline_odds2, echo=FALSE, out.height = "30%", fig.width=11, eval = PERSUADE$input$spline_mod}
evalq({
  # 2 knots
  plot(surv_obs$km, lwd = 2, main = "A: Kaplan-Meier (Spline, 2 knots, odds scale)", 
       xlab = "time", ylab = "survival", col = c("black", "lightgrey", "darkgrey"))
  lines(cbind(input$time_pred, surv_pred$model$spl_odds2[, 2]), col = "4", lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(input$time_pred, surv_pred$model$spl_odds2[, 3]), col = "4", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(input$time_pred, surv_pred$model$spl_odds2[, 4]), col = "4", lty = "5212", lwd = 2)
  }
  # add shading confidence intervals
  polygon(c(surv_obs$km$time[surv_obs$km_names == 1], rev(surv_obs$km$time[surv_obs$km_names == 1])),
          c(surv_obs$km$lower[surv_obs$km_names == 1], rev(surv_obs$km$upper[surv_obs$km_names == 1])), 
          col = adjustcolor("black", alpha.f = 0.3), border = NA)
  if (misc$ngroups > 1) {
    polygon(c(surv_obs$km$time[surv_obs$km_names == 2], rev(surv_obs$km$time[surv_obs$km_names == 2])),
            c(surv_obs$km$lower[surv_obs$km_names == 2], rev(surv_obs$km$upper[surv_obs$km_names == 2])),
            col = adjustcolor("lightgrey", alpha.f = 0.3), border = NA)
  }
  if (misc$ngroups > 2) {
    polygon(c(surv_obs$km$time[surv_obs$km_names == 3], rev(surv_obs$km$time[surv_obs$km_names == 3])),
            c(surv_obs$km$lower[surv_obs$km_names == 3], rev(surv_obs$km$upper[surv_obs$km_names == 3])), 
            col = adjustcolor("darkgrey", alpha.f = 0.3), border = NA)
  }
  abline(v = exp(surv_model$spl_odds2$knots[2]), lty = 2, lwd = 1.5)
  abline(v = exp(surv_model$spl_odds2$knots[3]), lty = 2, lwd = 1.5)
  abline(v = exp(surv_model$spl_odds2$knots[1]), lty = 3, lwd = 1)
  abline(v = exp(surv_model$spl_odds2$knots[4]), lty = 3, lwd = 1)
  legend("bottomleft", legend = misc$group_names, col = "4", 
         lty = as.integer(c(1, "2222", "5212")), cex = 0.8)
  
  # annual transition probabilities
  plot(cbind(surv_obs$tp$gr_1$time, surv_obs$tp$gr_1$smooth), lwd = 1, 
       lty = 1, type = "b", cex = 0.6, pch = 1, col = "black", 
       main = "B: Annual transition probability (Spline, 2 knots, odds scale)", 
       xlab = "time", ylab = "annual transition probability (smoothed)", 
       ylim = c(0, ceiling(surv_obs$tp$max * 10)/10), xlim = c(0, ceiling(surv_obs$km$maxtime * 10)/10))
  lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_1[, 12]), col = "4", lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(surv_obs$tp$gr_2$time, surv_obs$tp$gr_2$smooth), 
          col = "lightgrey", type = "b", lwd = 1, cex = 0.6, pch = 8)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_2[, 12]), col = "4", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(surv_obs$tp$gr_3$time, surv_obs$tp$gr_3$smooth), 
          col = "darkgrey", type = "b", lwd = 1, cex = 0.6, pch = 9)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_3[, 12]), col = "4", lty = "5212", lwd = 2)
  }
  # add shading confidence intervals
  polygon(c(surv_obs$tp$gr_1$time, rev(surv_obs$tp$gr_1$time)), 
          c(surv_obs$tp$gr_1$smooth_lower, rev(surv_obs$tp$gr_1$smooth_upper)), 
          col = adjustcolor("black", alpha.f = 0.3), border = NA)
  if (misc$ngroups > 1) {
    polygon(c(surv_obs$tp$gr_2$time, rev(surv_obs$tp$gr_2$time)), 
            c(surv_obs$tp$gr_2$smooth_lower, rev(surv_obs$tp$gr_2$smooth_upper)), 
            col = adjustcolor("lightgrey", alpha.f = 0.3), border = NA)
  }
  if (misc$ngroups > 2) {
    polygon(c(surv_obs$tp$gr_3$time, rev(surv_obs$tp$gr_3$time)), 
            c(surv_obs$tp$gr_3$smooth_lower, rev(surv_obs$tp$gr_3$smooth_upper)), 
            col = adjustcolor("darkgrey", alpha.f = 0.3), border = NA)
  }
  abline(v = exp(surv_model$spl_odds2$knots[2]), lty = 2, lwd = 1.5)
  abline(v = exp(surv_model$spl_odds2$knots[3]), lty = 2, lwd = 1.5)
  abline(v = exp(surv_model$spl_odds2$knots[1]), lty = 3, lwd = 1)
  abline(v = exp(surv_model$spl_odds2$knots[4]), lty = 3, lwd = 1)
  legend("topleft", legend = misc$group_names, col = "4", 
         lty = as.integer(c(1, "2222", "5212")), cex = 0.8)
  
  # diagnostics
  plot(cbind(log(surv_obs$km$time), -log(surv_obs$km$surv/(1 - surv_obs$km$surv))), 
       cex = 0.6, pch = c(1, 8, 9)[surv_obs$km_names], 
       col = c("black", "lightgrey", "darkgrey")[surv_obs$km_names],
       main = "C: Diagnostic plot (Spline, 2 knots, odds scale)", 
       xlim = c(floor(min(log(surv_obs$km$time)[surv_obs$km$surv != 1])), ceiling(max(log(surv_obs$km$time)))), 
       xlab = "LN(time)", ylab = "-LN(survival odds)")
  lines(cbind(log(input$time_pred), 
              -log(surv_pred$model$spl_odds2[, 2]/(1 - surv_pred$model$spl_odds2[, 2]))), 
        col = "4", lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(log(input$time_pred), 
                -log(surv_pred$model$spl_odds2[, 3]/(1 - surv_pred$model$spl_odds2[, 3]))), 
          col = "4", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(log(input$time_pred), 
                -log(surv_pred$model$spl_odds2[, 4]/(1 - surv_pred$model$spl_odds2[, 4]))), 
          col = "4", lty = "5212", lwd = 2)
  }
  abline(v = surv_model$spl_odds2$knots[2], lty = 2, lwd = 1.5)
  abline(v = surv_model$spl_odds2$knots[3], lty = 2, lwd = 1.5)
  abline(v = surv_model$spl_odds2$knots[1], lty = 3, lwd = 1)
  abline(v = surv_model$spl_odds2$knots[4], lty = 3, lwd = 1)
  legend("topleft", legend = misc$group_names, col = "4", 
         lty = as.integer(c(1, "2222", "5212")), cex = 0.8)
}, envir = PERSUADE)
```

##Spline normal 1 knot
```{r spline_norm1, echo=FALSE, out.height = "30%", fig.width=11, eval = PERSUADE$input$spline_mod}
evalq({
  # 1 knot
  plot(surv_obs$km, lwd = 2, main = "A: Kaplan-Meier (Spline, 1 knot, normal scale)", 
       xlab = "time", ylab = "survival", col = c("black", "lightgrey", "darkgrey"))
  lines(cbind(input$time_pred, surv_pred$model$spl_normal1[, 2]), col = "5", lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(input$time_pred, surv_pred$model$spl_normal1[, 3]), col = "5", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(input$time_pred, surv_pred$model$spl_normal1[, 4]), col = "5", lty = "5212", lwd = 2)
  }
  # add shading confidence intervals
  polygon(c(surv_obs$km$time[surv_obs$km_names == 1], rev(surv_obs$km$time[surv_obs$km_names == 1])),
          c(surv_obs$km$lower[surv_obs$km_names == 1], rev(surv_obs$km$upper[surv_obs$km_names == 1])), 
          col = adjustcolor("black", alpha.f = 0.3), border = NA)
  if (misc$ngroups > 1) {
    polygon(c(surv_obs$km$time[surv_obs$km_names == 2], rev(surv_obs$km$time[surv_obs$km_names == 2])),
            c(surv_obs$km$lower[surv_obs$km_names == 2], rev(surv_obs$km$upper[surv_obs$km_names == 2])), 
            col = adjustcolor("lightgrey", alpha.f = 0.3), border = NA)
  }
  if (misc$ngroups > 2) {
    polygon(c(surv_obs$km$time[surv_obs$km_names == 3], rev(surv_obs$km$time[surv_obs$km_names == 3])),
            c(surv_obs$km$lower[surv_obs$km_names == 3], rev(surv_obs$km$upper[surv_obs$km_names == 3])), 
            col = adjustcolor("darkgrey", alpha.f = 0.3), border = NA)
  }
  abline(v = exp(surv_model$spl_normal1$knots[2]), lty = 2, lwd = 1.5)
  abline(v = exp(surv_model$spl_normal1$knots[1]), lty = 3, lwd = 1)
  abline(v = exp(surv_model$spl_normal1$knots[3]), lty = 3, lwd = 1)
  legend("bottomleft", legend = misc$group_names, col = "5", 
         lty = as.integer(c(1, "2222", "5212")), cex = 0.8)
  
  # annual transition probabilities
  plot(cbind(surv_obs$tp$gr_1$time, surv_obs$tp$gr_1$smooth), lwd = 1, 
       lty = 1, type = "b", cex = 0.6, pch = 1, col = "black",
       main = "B: Annual transition probability (Spline, 1 knot, normal scale)", 
       xlab = "time", ylab = "annual transition probability (smoothed)", 
       ylim = c(0, ceiling(surv_obs$tp$max * 10)/10), xlim = c(0, ceiling(surv_obs$km$maxtime * 10)/10))
  lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_1[, 13]), col = "5", lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(surv_obs$tp$gr_2$time, surv_obs$tp$gr_2$smooth), 
          col = "lightgrey", type = "b", lwd = 1, cex = 0.6, pch = 8)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_2[, 13]), col = "5", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(surv_obs$tp$gr_3$time, surv_obs$tp$gr_3$smooth), 
          col = "darkgrey", type = "b", lwd = 1, cex = 0.6, pch = 9)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_3[, 13]), col = "5", lty = "5212", lwd = 2)
  }
  # add shading confidence intervals
  polygon(c(surv_obs$tp$gr_1$time, rev(surv_obs$tp$gr_1$time)), 
          c(surv_obs$tp$gr_1$smooth_lower, rev(surv_obs$tp$gr_1$smooth_upper)), 
          col = adjustcolor("black", alpha.f = 0.3), border = NA)
  if (misc$ngroups > 1) {
    polygon(c(surv_obs$tp$gr_2$time, rev(surv_obs$tp$gr_2$time)), 
            c(surv_obs$tp$gr_2$smooth_lower, rev(surv_obs$tp$gr_2$smooth_upper)), 
            col = adjustcolor("lightgrey", alpha.f = 0.3), border = NA)
  }
  if (misc$ngroups > 2) {
    polygon(c(surv_obs$tp$gr_3$time, rev(surv_obs$tp$gr_3$time)), 
            c(surv_obs$tp$gr_3$smooth_lower, rev(surv_obs$tp$gr_3$smooth_upper)), 
            col = adjustcolor("darkgrey", alpha.f = 0.3), border = NA)
  }
  abline(v = exp(surv_model$spl_normal1$knots[2]), lty = 2, lwd = 1.5)
  abline(v = exp(surv_model$spl_normal1$knots[1]), lty = 3, lwd = 1)
  abline(v = exp(surv_model$spl_normal1$knots[3]), lty = 3, lwd = 1)
  legend("topleft", legend = misc$group_names, col = "5", 
         lty = as.integer(c(1, "2222", "5212")), cex = 0.8)
  
  # diagnostics
  plot(cbind(log(surv_obs$km$time), 
             -qnorm(surv_obs$km$surv, mean = 0, sd = 1, lower.tail = TRUE, log.p = FALSE)), 
       pch = c(1, 8, 9)[surv_obs$km_names], 
       col = c("black", "lightgrey", "darkgrey")[surv_obs$km_names], cex = 0.6, 
       main = "C: Diagnostic plot (Spline, 1 knot, normal scale)", 
       xlim = c(floor(min(log(surv_obs$km$time)[surv_obs$km$surv != 1])), 
                ceiling(max(log(surv_obs$km$time)))), xlab = "LN(time)", ylab = "- standard normal quartiles")
  lines(cbind(log(input$time_pred), 
              -qnorm(surv_pred$model$spl_normal1[, 2], mean = 0, sd = 1, lower.tail = TRUE, log.p = FALSE)), 
        col = "5", lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(log(input$time_pred), 
                -qnorm(surv_pred$model$spl_normal1[, 3], mean = 0, sd = 1, lower.tail = TRUE, log.p = FALSE)),
          col = "5", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(log(input$time_pred), 
                -qnorm(surv_pred$model$spl_normal1[, 4], mean = 0, sd = 1, lower.tail = TRUE, log.p = FALSE)),
          col = "5", lty = "5212", lwd = 2)
  }
  abline(v = surv_model$spl_normal1$knots[2], lty = 2, lwd = 1.5)
  abline(v = surv_model$spl_normal1$knots[1], lty = 3, lwd = 1)
  abline(v = surv_model$spl_normal1$knots[3], lty = 3, lwd = 1)
  legend("topleft", legend = misc$group_names, col = "5", 
         lty = as.integer(c(1, "2222", "5212")), cex = 0.8)
}, envir = PERSUADE)
```

##Spline normal 2 knots
```{r spline_norm2, echo=FALSE, out.height = "30%", fig.width=11, eval = PERSUADE$input$spline_mod}
evalq({
  # 2 knots
  plot(surv_obs$km, lwd = 2, main = "A: Kaplan-Meier (Spline, 2 knots, normal scale)", 
       xlab = "time", ylab = "survival", col = c("black", "lightgrey", "darkgrey"))
  lines(cbind(input$time_pred, surv_pred$model$spl_normal2[, 2]), col = "6", lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(input$time_pred, surv_pred$model$spl_normal2[, 3]), col = "6", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(input$time_pred, surv_pred$model$spl_normal2[, 4]), col = "6", lty = "5212", lwd = 2)
  }
  # add shading confidence intervals
  polygon(c(surv_obs$km$time[surv_obs$km_names == 1], rev(surv_obs$km$time[surv_obs$km_names == 1])),
          c(surv_obs$km$lower[surv_obs$km_names == 1], rev(surv_obs$km$upper[surv_obs$km_names == 1])), 
          col = adjustcolor("black", alpha.f = 0.3), border = NA)
  if (misc$ngroups > 1) {
    polygon(c(surv_obs$km$time[surv_obs$km_names == 2], rev(surv_obs$km$time[surv_obs$km_names == 2])),
            c(surv_obs$km$lower[surv_obs$km_names == 2], rev(surv_obs$km$upper[surv_obs$km_names == 2])), 
            col = adjustcolor("lightgrey", alpha.f = 0.3), border = NA)
  }
  if (misc$ngroups > 2) {
    polygon(c(surv_obs$km$time[surv_obs$km_names == 3], rev(surv_obs$km$time[surv_obs$km_names == 3])),
            c(surv_obs$km$lower[surv_obs$km_names == 3], rev(surv_obs$km$upper[surv_obs$km_names == 3])), 
            col = adjustcolor("darkgrey", alpha.f = 0.3), border = NA)
  }
  abline(v = exp(surv_model$spl_normal2$knots[2]), lty = 2, lwd = 1.5)
  abline(v = exp(surv_model$spl_normal2$knots[3]), lty = 2, lwd = 1.5)
  abline(v = exp(surv_model$spl_normal2$knots[1]), lty = 3, lwd = 1)
  abline(v = exp(surv_model$spl_normal2$knots[4]), lty = 3, lwd = 1)
  legend("bottomleft", legend = misc$group_names, col = "6", 
         lty = as.integer(c(1, "2222", "5212")), cex = 0.8)
  
  # annual transition probabilities
  plot(cbind(surv_obs$tp$gr_1$time, surv_obs$tp$gr_1$smooth), lwd = 1, 
       lty = 1, type = "b", cex = 0.6, pch = 1, col = "black", 
       main = "B: Annual transition probability (Spline, 2 knots, normal scale)", 
       xlab = "time", ylab = "annual transition probability (smoothed)", 
       ylim = c(0, ceiling(surv_obs$tp$max * 10)/10), xlim = c(0, ceiling(surv_obs$km$maxtime * 10)/10))
  lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_1[, 14]), col = "6", lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(surv_obs$tp$gr_2$time, surv_obs$tp$gr_2$smooth), 
          col = "lightgrey", type = "b", lwd = 1, cex = 0.6, pch = 8)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_2[, 14]), col = "6", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(surv_obs$tp$gr_3$time, surv_obs$tp$gr_3$smooth), 
          col = "darkgrey", type = "b", lwd = 1, cex = 0.6, pch = 9)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_3[, 14]), col = "6", lty = "5212", lwd = 2)
  }
  # add shading confidence intervals
  polygon(c(surv_obs$tp$gr_1$time, rev(surv_obs$tp$gr_1$time)), 
          c(surv_obs$tp$gr_1$smooth_lower, rev(surv_obs$tp$gr_1$smooth_upper)), 
          col = adjustcolor("black", alpha.f = 0.3), border = NA)
  if (misc$ngroups > 1) {
    polygon(c(surv_obs$tp$gr_2$time, rev(surv_obs$tp$gr_2$time)), 
            c(surv_obs$tp$gr_2$smooth_lower, rev(surv_obs$tp$gr_2$smooth_upper)), 
            col = adjustcolor("lightgrey", alpha.f = 0.3), border = NA)
  }
  if (misc$ngroups > 2) {
    polygon(c(surv_obs$tp$gr_3$time, rev(surv_obs$tp$gr_3$time)), 
            c(surv_obs$tp$gr_3$smooth_lower, rev(surv_obs$tp$gr_3$smooth_upper)), 
            col = adjustcolor("darkgrey", alpha.f = 0.3), border = NA)
  }
  abline(v = exp(surv_model$spl_normal2$knots[2]), lty = 2, lwd = 1.5)
  abline(v = exp(surv_model$spl_normal2$knots[3]), lty = 2, lwd = 1.5)
  abline(v = exp(surv_model$spl_normal2$knots[1]), lty = 3, lwd = 1)
  abline(v = exp(surv_model$spl_normal2$knots[4]), lty = 3, lwd = 1)
  legend("topleft", legend = misc$group_names, col = "6", 
         lty = as.integer(c(1, "2222", "5212")), cex = 0.8)
  
  # diagnostics
  plot(cbind(log(surv_obs$km$time), 
             -qnorm(surv_obs$km$surv, mean = 0, sd = 1, lower.tail = TRUE, log.p = FALSE)), 
       pch = c(1, 8, 9)[surv_obs$km_names], 
       col = c("black", "lightgrey", "darkgrey")[surv_obs$km_names], cex = 0.6, 
       main = "C: Diagnostic plot (Spline, 2 knots, normal scale)", 
       xlim = c(floor(min(log(surv_obs$km$time)[surv_obs$km$surv != 1])), 
                ceiling(max(log(surv_obs$km$time)))), 
       xlab = "LN(time)", ylab = "- standard normal quartiles")
  lines(cbind(log(input$time_pred), 
              -qnorm(surv_pred$model$spl_normal2[, 2], mean = 0, sd = 1, lower.tail = TRUE, log.p = FALSE)), 
        col = "6", lty = 1, lwd = 2)
  if (misc$ngroups > 1) {
    lines(cbind(log(input$time_pred), 
                -qnorm(surv_pred$model$spl_normal2[, 3], mean = 0, sd = 1, lower.tail = TRUE, log.p = FALSE)),
          col = "6", lty = "2222", lwd = 2)
  }
  if (misc$ngroups > 2) {
    lines(cbind(log(input$time_pred), 
                -qnorm(surv_pred$model$spl_normal2[, 4], mean = 0, sd = 1, lower.tail = TRUE, log.p = FALSE)),
          col = "6", lty = "5212", lwd = 2)
  }
  abline(v = surv_model$spl_normal2$knots[2], lty = 2, lwd = 1.5)
  abline(v = surv_model$spl_normal2$knots[3], lty = 2, lwd = 1.5)
  abline(v = surv_model$spl_normal2$knots[1], lty = 3, lwd = 1)
  abline(v = surv_model$spl_normal2$knots[4], lty = 3, lwd = 1)
  legend("topleft", legend = misc$group_names, col = "6", 
         lty = as.integer(c(1, "2222", "5212")), cex = 0.8)
}, envir = PERSUADE)
```

\newpage

#Validity of long-term extrapolation?
What model(s) is/are more appropriate for long-term extrapolation?
Are/is the selected model(s) plausible in comparison with general population mortality?

##`r paste("Group", PERSUADE$misc$group_names[1])`
```{r validate_extrapolation1, echo=FALSE, out.height = "29%", fig.width=11, comment=NA}
evalq({
  # parametric curves
  plot(surv_obs$km[1], lwd = 2, col = "black", main = "A: Kaplan-Meier (parametric curves)", 
       xlab = "time", ylab = "survival", xlim = c(0, input$time_horizon))
  lines(cbind(input$time_pred, surv_pred$model$expo[, 2]), col = "1", lty = 1, lwd = 1)
  lines(cbind(input$time_pred, surv_pred$model$weib[, 2]), col = "2", lty = 1, lwd = 1)
  lines(cbind(input$time_pred, surv_pred$model$gom[, 2]), col = "3", lty = 1, lwd = 1)
  lines(cbind(input$time_pred, surv_pred$model$lnorm[, 2]), col = "4", lty = 1, lwd = 1)
  lines(cbind(input$time_pred, surv_pred$model$llog[, 2]), col = "5", lty = 1, lwd = 1)
  lines(cbind(input$time_pred, surv_pred$model$gam[, 2]), col = "6", lty = 1, lwd = 1)
  lines(cbind(input$time_pred, surv_pred$model$ggam[, 2]), col = "7", lty = 1, lwd = 1)
  legend("topright", legend = misc$lbls, col = 1:7, lty = 1, cex = 0.8)
  # spline curves
  if (input$spline_mod == TRUE) {
    plot(surv_obs$km[1], lwd = 2, col = "black", main = "B: Kaplan-Meier (spline curves)", 
         xlab = "time", ylab = "survival", xlim = c(0, input$time_horizon))
    lines(cbind(input$time_pred, surv_pred$model$spl_hazard1[, 2]), col = "1", lty = 1, lwd = 1)
    lines(cbind(input$time_pred, surv_pred$model$spl_hazard2[, 2]), col = "2", lty = 1, lwd = 1)
    lines(cbind(input$time_pred, surv_pred$model$spl_odds1[, 2]), col = "3", lty = 1, lwd = 1)
    lines(cbind(input$time_pred, surv_pred$model$spl_odds2[, 2]), col = "4", lty = 1, lwd = 1)
    lines(cbind(input$time_pred, surv_pred$model$spl_normal1[, 2]), col = "5", lty = 1, lwd = 1)
    lines(cbind(input$time_pred, surv_pred$model$spl_normal2[, 2]), col = "6", lty = 1, lwd = 1)
    legend("topright", legend = misc$lbls_spline, col = 1:6, lty = 1, cex = 0.8)
  }
}, envir = PERSUADE)
kable_styling(kable(t(round(
  PERSUADE$surv_pred$gr$surv_gr_1[1 + PERSUADE$input$time_pred_surv_table, ], 3))[-1, ], 
  col.names = paste("T=", PERSUADE$surv_pred$gr$surv_gr_1[1 + PERSUADE$input$time_pred_surv_table, ][, 1]), 
  format = "latex", booktabs = TRUE, 
  linesep = ""), latex_options = c("scale_down", "striped"), position = "left")

evalq({
  # parametric curves
  plot(cbind(surv_obs$tp$gr_1$time, surv_obs$tp$gr_1$smooth), 
       main = "C: Annual transition probability (parametric curves)", 
       xlab = "time", ylab = "annual transition probability", ylim = c(0, 1), 
       xlim = c(0, input$time_horizon), col = "black", type = "l", lwd = 2)
  lines(cbind(surv_obs$tp$gr_1$time, surv_obs$tp$gr_1$smooth_lower), 
        col = "black", type = "l", lwd = 2, lty = 2)
  lines(cbind(surv_obs$tp$gr_1$time, surv_obs$tp$gr_1$smooth_upper), 
        col = "black", type = "l", lwd = 2, lty = 2)
  lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_1[, 2]), col = "1", lty = 1, lwd = 1)
  lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_1[, 3]), col = "2", lty = 1, lwd = 1)
  lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_1[, 4]), col = "3", lty = 1, lwd = 1)
  lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_1[, 5]), col = "4", lty = 1, lwd = 1)
  lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_1[, 6]), col = "5", lty = 1, lwd = 1)
  lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_1[, 7]), col = "6", lty = 1, lwd = 1)
  lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_1[, 8]), col = "7", lty = 1, lwd = 1)
  legend("topleft", legend = misc$lbls, col = 1:7, lty = 1, cex = 0.8)
  # spline curves
  if (input$spline_mod == TRUE) {
    plot(cbind(surv_obs$tp$gr_1$time, surv_obs$tp$gr_1$smooth), 
         main = "D: Annual transition probability (spline curves)", xlab = "time", 
         ylab = "annual transition probability", ylim = c(0, 1), xlim = c(0, input$time_horizon), 
         col = "black", type = "l", lwd = 2)
    lines(cbind(surv_obs$tp$gr_1$time, surv_obs$tp$gr_1$smooth_lower), 
          col = "black", type = "l", lwd = 2, lty = 2)
    lines(cbind(surv_obs$tp$gr_1$time, surv_obs$tp$gr_1$smooth_upper), 
          col = "black", type = "l", lwd = 2, lty = 2)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_1[, 9]), col = "1", lty = 1, lwd = 1)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_1[, 10]), col = "2", lty = 1, lwd = 1)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_1[, 11]), col = "3", lty = 1, lwd = 1)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_1[, 12]), col = "4", lty = 1, lwd = 1)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_1[, 13]), col = "5", lty = 1, lwd = 1)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_1[, 14]), col = "6", lty = 1, lwd = 1)
    legend("topleft", legend = misc$lbls_spline, col = 1:6, lty = 1, cex = 0.8)
  }
}, envir = PERSUADE)
suppressWarnings(kable_styling(kable(descr(
  PERSUADE$surv_pred$tp_gr$gr_1[, 2:PERSUADE$misc$cols_tp], stats = "fivenum", transpose = TRUE), 
  format = "latex", booktabs = TRUE, linesep = ""), 
  latex_options = "striped", position = "left"))

evalq({
  plot(cbind(surv_obs$haz$smooth_gr1$est.grid, surv_obs$haz$smooth_gr1$haz.est),
       main = "E: Hazard function (parametric curves)", 
       type = "l", col = "black", lty = 1, lwd = 2, xlab = "time", ylab = "smoothed hazard rate", 
       xlim = c(0, input$time_horizon), ylim = c(0, surv_obs$haz$max$smooth))
  lines(cbind(surv_pred$model$expo_h[[1]]$time, surv_pred$model$expo_h[[1]]$est), 
        col = "1", lty = 1, lwd = 1)
  lines(cbind(surv_pred$model$weib_h[[1]]$time, surv_pred$model$weib_h[[1]]$est), 
        col = "2", lty = 1, lwd = 1)
  lines(cbind(surv_pred$model$gom_h[[1]]$time, surv_pred$model$gom_h[[1]]$est), 
        col = "3", lty = 1, lwd = 1)
  lines(cbind(surv_pred$model$lnorm_h[[1]]$time, surv_pred$model$lnorm_h[[1]]$est), 
        col = "4", lty = 1, lwd = 1)
  lines(cbind(surv_pred$model$llog_h[[1]]$time, surv_pred$model$llog_h[[1]]$est), 
        col = "5", lty = 1, lwd = 1)
  lines(cbind(surv_pred$model$gam_h[[1]]$time, surv_pred$model$gam_h[[1]]$est), 
        col = "6", lty = 1, lwd = 1)
  lines(cbind(surv_pred$model$ggam_h[[1]]$time, surv_pred$model$ggam_h[[1]]$est), 
        col = "7", lty = 1, lwd = 1)
  legend("topleft", legend = misc$lbls, col = 1:7, lty = 1, cex = 0.8)
  
  if (input$spline_mod == TRUE) {
    plot(cbind(surv_pred$model$spl_hazard1_h[[1]]$time, surv_pred$model$spl_hazard1_h[[1]]$est), 
         main = "F: Hazard function (spline curves)",
         type = "l", col = "black", lty = 1, lwd = 2, xlab = "time", ylab = "smoothed hazard rate", 
         xlim = c(0, input$time_horizon), ylim = c(0, surv_obs$haz$max$smooth))
    lines(cbind(surv_pred$model$spl_hazard1_h[[1]]$time, surv_pred$model$spl_hazard1_h[[1]]$est), 
          col = "1", lty = 1, lwd = 1)
    lines(cbind(surv_pred$model$spl_hazard2_h[[1]]$time, surv_pred$model$spl_hazard1_h[[1]]$est), 
          col = "2", lty = 1, lwd = 1)
    lines(cbind(surv_pred$model$spl_odds1_h[[1]]$time, surv_pred$model$spl_odds1_h[[1]]$est), 
          col = "3", lty = 1, lwd = 1)
    lines(cbind(surv_pred$model$spl_odds2_h[[1]]$time, surv_pred$model$spl_odds2_h[[1]]$est), 
          col = "4", lty = 1, lwd = 1)
    lines(cbind(surv_pred$model$spl_normal1_h[[1]]$time, surv_pred$model$spl_normal1_h[[1]]$est), 
          col = "5", lty = 1, lwd = 1)
    lines(cbind(surv_pred$model$spl_normal2_h[[1]]$time, surv_pred$model$spl_normal2_h[[1]]$est), 
          col = "6", lty = 1, lwd = 1)
    legend("topleft", legend = misc$lbls_spline, col = 1:6, lty = 1, cex = 0.8)
  }
}, envir = PERSUADE)
```

\newpage

##`r paste("Group", PERSUADE$misc$group_names[2])`
```{r validate_extrapolation2, echo=FALSE, out.height = "29%", fig.width=11, eval=if (PERSUADE$misc$ngroups>1) {TRUE} else {FALSE}, comment=NA}
evalq({
  # parametric curves
  plot(surv_obs$km[2], lwd = 2, col = "black", main = "A: Kaplan-Meier (parametric curves)", 
       xlab = "time", ylab = "survival", xlim = c(0, input$time_horizon))
  lines(cbind(input$time_pred, surv_pred$model$expo[, 3]), col = "1", lty = "2222", lwd = 1)
  lines(cbind(input$time_pred, surv_pred$model$weib[, 3]), col = "2", lty = "2222", lwd = 1)
  lines(cbind(input$time_pred, surv_pred$model$gom[, 3]), col = "3", lty = "2222", lwd = 1)
  lines(cbind(input$time_pred, surv_pred$model$lnorm[, 3]), col = "4", lty = "2222", lwd = 1)
  lines(cbind(input$time_pred, surv_pred$model$llog[, 3]), col = "5", lty = "2222", lwd = 1)
  lines(cbind(input$time_pred, surv_pred$model$gam[, 3]), col = "6", lty = "2222", lwd = 1)
  lines(cbind(input$time_pred, surv_pred$model$ggam[, 3]), col = "7", lty = "2222", lwd = 1)
  legend("topright", legend = misc$lbls, col = 1:7, lty = "2222", cex = 0.8)
  # spline curves
  if (input$spline_mod == TRUE) {
    plot(surv_obs$km[2], lwd = 2, col = "black", main = "B: Kaplan-Meier (spline curves)", 
         xlab = "time", ylab = "survival", xlim = c(0, input$time_horizon))
    lines(cbind(input$time_pred, surv_pred$model$spl_hazard1[, 3]), col = "1", lty = "2222", lwd = 1)
    lines(cbind(input$time_pred, surv_pred$model$spl_hazard2[, 3]), col = "2", lty = "2222", lwd = 1)
    lines(cbind(input$time_pred, surv_pred$model$spl_odds1[, 3]), col = "3", lty = "2222", lwd = 1)
    lines(cbind(input$time_pred, surv_pred$model$spl_odds2[, 3]), col = "4", lty = "2222", lwd = 1)
    lines(cbind(input$time_pred, surv_pred$model$spl_normal1[, 3]), col = "5", lty = "2222", lwd = 1)
    lines(cbind(input$time_pred, surv_pred$model$spl_normal2[, 3]), col = "6", lty = "2222", lwd = 1)
    legend("topright", legend = misc$lbls_spline, col = 1:6, lty = "2222", cex = 0.8)
  }
}, envir = PERSUADE)
kable_styling(kable(t(round(
  PERSUADE$surv_pred$gr$surv_gr_2[1 + PERSUADE$input$time_pred_surv_table, ], 3))[-1, ], 
  col.names = paste("T=", PERSUADE$surv_pred$gr$surv_gr_2[1 + PERSUADE$input$time_pred_surv_table, ][, 1]),
  format = "latex", booktabs = TRUE, linesep = ""), 
  latex_options = c("scale_down", "striped"), position = "left")

evalq({
  # parametric curves
  plot(cbind(surv_obs$tp$gr_2$time, surv_obs$tp$gr_2$smooth), 
       main = "C: Annual transition probability (parametric curves)", 
       xlab = "time", ylab = "annual transition probability", ylim = c(0, 1), 
       xlim = c(0, input$time_horizon), col = "black", type = "l", lwd = 2)
  lines(cbind(surv_obs$tp$gr_2$time, surv_obs$tp$gr_2$smooth_lower), 
        col = "black", type = "l", lwd = 2, lty = 2)
  lines(cbind(surv_obs$tp$gr_2$time, surv_obs$tp$gr_2$smooth_upper), 
        col = "black", type = "l", lwd = 2, lty = 2)
  lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_2[, 2]), col = "1", lty = "2222", lwd = 1)
  lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_2[, 3]), col = "2", lty = "2222", lwd = 1)
  lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_2[, 4]), col = "3", lty = "2222", lwd = 1)
  lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_2[, 5]), col = "4", lty = "2222", lwd = 1)
  lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_2[, 6]), col = "5", lty = "2222", lwd = 1)
  lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_2[, 7]), col = "6", lty = "2222", lwd = 1)
  lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_2[, 8]), col = "7", lty = "2222", lwd = 1)
  legend("topleft", legend = misc$lbls, col = 1:7, lty = "2222", cex = 0.8)
  # spline curves
  if (input$spline_mod == TRUE) {
    plot(cbind(surv_obs$tp$gr_2$time, surv_obs$tp$gr_2$smooth), 
         main = "D: Annual transition probability (spline curves)", xlab = "time", 
         ylab = "annual transition probability", ylim = c(0, 1), xlim = c(0, input$time_horizon), 
         col = "black", type = "l", lwd = 2)
    lines(cbind(surv_obs$tp$gr_2$time, surv_obs$tp$gr_2$smooth_lower), 
          col = "black", type = "l", lwd = 2, lty = 2)
    lines(cbind(surv_obs$tp$gr_2$time, surv_obs$tp$gr_2$smooth_upper), 
          col = "black", type = "l", lwd = 2, lty = 2)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_2[, 9]), col = "1", lty = "2222", lwd = 1)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_2[, 10]), col = "2", lty = "2222", lwd = 1)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_2[, 11]), col = "3", lty = "2222", lwd = 1)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_2[, 12]), col = "4", lty = "2222", lwd = 1)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_2[, 13]), col = "5", lty = "2222", lwd = 1)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_2[, 14]), col = "6", lty = "2222", lwd = 1)
    legend("topleft", legend = misc$lbls_spline, col = 1:6, lty = "2222", cex = 0.8)
  }
}, envir = PERSUADE)
suppressWarnings(kable_styling(kable(descr(
  PERSUADE$surv_pred$tp_gr$gr_2[, 2:PERSUADE$misc$cols_tp], stats = "fivenum", transpose = TRUE), 
  format = "latex", booktabs = TRUE, linesep = ""), 
  latex_options = "striped", position = "left"))

evalq({
  plot(cbind(surv_obs$haz$smooth_gr2$est.grid, surv_obs$haz$smooth_gr2$haz.est), 
       main = "E: Hazard function (parametric curves)",
       type = "l", col = "black", lty = "2222", lwd = 2, xlab = "time", ylab = "smoothed hazard rate", 
       xlim = c(0, input$time_horizon), ylim = c(0, surv_obs$haz$max$smooth))
  lines(cbind(surv_pred$model$expo_h[[2]]$time, surv_pred$model$expo_h[[2]]$est), 
        col = "1", lty = "2222", lwd = 1)
  lines(cbind(surv_pred$model$weib_h[[2]]$time, surv_pred$model$weib_h[[2]]$est), 
        col = "2", lty = "2222", lwd = 1)
  lines(cbind(surv_pred$model$gom_h[[2]]$time, surv_pred$model$gom_h[[2]]$est), 
        col = "3", lty = "2222", lwd = 1)
  lines(cbind(surv_pred$model$lnorm_h[[2]]$time, surv_pred$model$lnorm_h[[2]]$est), 
        col = "4", lty = "2222", lwd = 1)
  lines(cbind(surv_pred$model$llog_h[[2]]$time, surv_pred$model$llog_h[[2]]$est), 
        col = "5", lty = "2222", lwd = 1)
  lines(cbind(surv_pred$model$gam_h[[2]]$time, surv_pred$model$gam_h[[2]]$est), 
        col = "6", lty = "2222", lwd = 1)
  lines(cbind(surv_pred$model$ggam_h[[2]]$time, surv_pred$model$ggam_h[[2]]$est), 
        col = "7", lty = "2222", lwd = 1)
  legend("topleft", legend = misc$lbls, col = 1:7, lty = "2222", cex = 0.8)
  
  if (input$spline_mod == TRUE) {
    plot(cbind(surv_obs$haz$smooth_gr2$est.grid, surv_obs$haz$smooth_gr2$haz.est),
         main = "F: Hazard function (spline curves)",
         type = "l", col = "black", lty = "2222", lwd = 2, xlab = "time", ylab = "smoothed hazard rate", 
         xlim = c(0, input$time_horizon), ylim = c(0, surv_obs$haz$max$smooth))
    lines(cbind(surv_pred$model$spl_hazard1_h[[2]]$time, surv_pred$model$spl_hazard1_h[[2]]$est), 
          col = "1", lty = "2222", lwd = 1)
    lines(cbind(surv_pred$model$spl_hazard2_h[[2]]$time, surv_pred$model$spl_hazard1_h[[2]]$est), 
          col = "2", lty = "2222", lwd = 1)
    lines(cbind(surv_pred$model$spl_odds1_h[[2]]$time, surv_pred$model$spl_odds1_h[[2]]$est), 
          col = "3", lty = "2222", lwd = 1)
    lines(cbind(surv_pred$model$spl_odds2_h[[2]]$time, surv_pred$model$spl_odds2_h[[2]]$est), 
          col = "4", lty = "2222", lwd = 1)
    lines(cbind(surv_pred$model$spl_normal1_h[[2]]$time, surv_pred$model$spl_normal1_h[[2]]$est), 
          col = "5", lty = "2222", lwd = 1)
    lines(cbind(surv_pred$model$spl_normal2_h[[2]]$time, surv_pred$model$spl_normal2_h[[2]]$est), 
          col = "6", lty = "2222", lwd = 1)
    legend("topleft", legend = misc$lbls_spline, col = 1:6, lty = "2222", cex = 0.8)
  }
}, envir = PERSUADE)
```

\newpage

##`r paste("Group", PERSUADE$misc$group_names[3])`
```{r validate_extrapolation3, echo=FALSE, out.height = "29%", fig.width=11, eval=if (PERSUADE$misc$ngroups>2) {TRUE} else {FALSE}, comment=NA}
evalq({
  # parametric curves
  plot(surv_obs$km[3], lwd = 2, col = "black", main = "A: Kaplan-Meier (parametric curves)", 
       xlab = "time", ylab = "survival", xlim = c(0, input$time_horizon))
  lines(cbind(input$time_pred, surv_pred$model$expo[, 4]), col = "1", lty = "5212", lwd = 1)
  lines(cbind(input$time_pred, surv_pred$model$weib[, 4]), col = "2", lty = "5212", lwd = 1)
  lines(cbind(input$time_pred, surv_pred$model$gom[, 4]), col = "3", lty = "5212", lwd = 1)
  lines(cbind(input$time_pred, surv_pred$model$lnorm[, 4]), col = "4", lty = "5212", lwd = 1)
  lines(cbind(input$time_pred, surv_pred$model$llog[, 4]), col = "5", lty = "5212", lwd = 1)
  lines(cbind(input$time_pred, surv_pred$model$gam[, 4]), col = "6", lty = "5212", lwd = 1)
  lines(cbind(input$time_pred, surv_pred$model$ggam[, 4]), col = "7", lty = "5212", lwd = 1)
  legend("topright", legend = misc$lbls, col = 1:7, lty = "5212", cex = 0.8)
  # spline curves
  if (input$spline_mod == TRUE) {
    plot(surv_obs$km[3], lwd = 2, col = "black", main = "B: Kaplan-Meier (spline curves)", 
         xlab = "time", ylab = "survival", xlim = c(0, input$time_horizon))
    lines(cbind(input$time_pred, surv_pred$model$spl_hazard1[, 4]), col = "1", lty = "5212", lwd = 1)
    lines(cbind(input$time_pred, surv_pred$model$spl_hazard2[, 4]), col = "2", lty = "5212", lwd = 1)
    lines(cbind(input$time_pred, surv_pred$model$spl_odds1[, 4]), col = "3", lty = "5212", lwd = 1)
    lines(cbind(input$time_pred, surv_pred$model$spl_odds2[, 4]), col = "4", lty = "5212", lwd = 1)
    lines(cbind(input$time_pred, surv_pred$model$spl_normal1[, 4]), col = "5", lty = "5212", lwd = 1)
    lines(cbind(input$time_pred, surv_pred$model$spl_normal2[, 4]), col = "6", lty = "5212", lwd = 1)
    legend("topright", legend = misc$lbls_spline, col = 1:6, lty = "5212", cex = 0.8)
  }
}, envir = PERSUADE)
kable_styling(kable(t(round(
  PERSUADE$surv_pred$gr$surv_gr_3[1 + PERSUADE$input$time_pred_surv_table, ], 3))[-1, ], 
  col.names = paste("T=", PERSUADE$surv_pred$gr$surv_gr_3[1 + PERSUADE$input$time_pred_surv_table, ][, 1]),
  format = "latex", booktabs = TRUE, linesep = ""), 
  latex_options = c("scale_down", "striped"), position = "left")

evalq({
  # parametric curves
  plot(cbind(surv_obs$tp$gr_3$time, surv_obs$tp$gr_3$smooth), 
       main = "C: Annual transition probability (parametric curves)", 
       xlab = "time", ylab = "annual transition probability", 
       ylim = c(0, 1), xlim = c(0, input$time_horizon), col = "black", type = "l", lwd = 2)
  lines(cbind(surv_obs$tp$gr_3$time, surv_obs$tp$gr_3$smooth_lower), 
        col = "black", type = "l", lwd = 2, lty = 2)
  lines(cbind(surv_obs$tp$gr_3$time, surv_obs$tp$gr_3$smooth_upper), 
        col = "black", type = "l", lwd = 2, lty = 2)
  lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_3[, 2]), col = "1", lty = "5212", lwd = 1)
  lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_3[, 3]), col = "2", lty = "5212", lwd = 1)
  lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_3[, 4]), col = "3", lty = "5212", lwd = 1)
  lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_3[, 5]), col = "4", lty = "5212", lwd = 1)
  lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_3[, 6]), col = "5", lty = "5212", lwd = 1)
  lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_3[, 7]), col = "6", lty = "5212", lwd = 1)
  lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_3[, 8]), col = "7", lty = "5212", lwd = 1)
  legend("topleft", legend = misc$lbls, col = 1:7, lty = "5212", cex = 0.8)
  # spline curves
  if (input$spline_mod == TRUE) {
    plot(cbind(surv_obs$tp$gr_3$time, surv_obs$tp$gr_3$smooth), 
         main = "D: Annual transition probability (spline curves)", xlab = "time", 
         ylab = "annual transition probability", ylim = c(0, 1), xlim = c(0, input$time_horizon), 
         col = "black", type = "l", lwd = 2)
    lines(cbind(surv_obs$tp$gr_3$time, surv_obs$tp$gr_3$smooth_lower), 
          col = "black", type = "l", lwd = 2, lty = 2)
    lines(cbind(surv_obs$tp$gr_3$time, surv_obs$tp$gr_3$smooth_upper), 
          col = "black", type = "l", lwd = 2, lty = 2)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_3[, 9]), col = "1", lty = "5212", lwd = 1)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_3[, 10]), col = "2", lty = "5212", lwd = 1)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_3[, 11]), col = "3", lty = "5212", lwd = 1)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_3[, 12]), col = "4", lty = "5212", lwd = 1)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_3[, 13]), col = "5", lty = "5212", lwd = 1)
    lines(cbind(input$time_pred[-1], surv_pred$tp_gr$gr_3[, 14]), col = "6", lty = "5212", lwd = 1)
    legend("topleft", legend = misc$lbls_spline, col = 1:6, lty = "5212", cex = 0.8)
  }
}, envir = PERSUADE)
suppressWarnings(kable_styling(kable(descr(
  PERSUADE$surv_pred$tp_gr$gr_3[, 2:PERSUADE$misc$cols_tp], stats = "fivenum", transpose = TRUE), 
  format = "latex", booktabs = TRUE, linesep = ""), 
  latex_options = "striped", position = "left"))

evalq({
  plot(cbind(surv_obs$haz$smooth_gr3$est.grid, surv_obs$haz$smooth_gr3$haz.est), 
       main = "E: Hazard function (parametric curves)",
       type = "l", col = "black", lty = "5212", lwd = 2, xlab = "time", ylab = "smoothed hazard rate", 
       xlim = c(0, input$time_horizon), ylim = c(0, surv_obs$haz$max$smooth))
  lines(cbind(surv_pred$model$expo_h[[3]]$time, surv_pred$model$expo_h[[3]]$est), 
        col = "1", lty = "5212", lwd = 1)
  lines(cbind(surv_pred$model$weib_h[[3]]$time, surv_pred$model$weib_h[[3]]$est), 
        col = "2", lty = "5212", lwd = 1)
  lines(cbind(surv_pred$model$gom_h[[3]]$time, surv_pred$model$gom_h[[3]]$est), 
        col = "3", lty = "5212", lwd = 1)
  lines(cbind(surv_pred$model$lnorm_h[[3]]$time, surv_pred$model$lnorm_h[[3]]$est), 
        col = "4", lty = "5212", lwd = 1)
  lines(cbind(surv_pred$model$llog_h[[3]]$time, surv_pred$model$llog_h[[3]]$est), 
        col = "5", lty = "5212", lwd = 1)
  lines(cbind(surv_pred$model$gam_h[[3]]$time, surv_pred$model$gam_h[[3]]$est), 
        col = "6", lty = "5212", lwd = 1)
  lines(cbind(surv_pred$model$ggam_h[[3]]$time, surv_pred$model$ggam_h[[3]]$est), 
        col = "7", lty = "5212", lwd = 1)
  legend("topleft", legend = misc$lbls, col = 1:7, lty = "5212", cex = 0.8)
  
  if (input$spline_mod == TRUE) {
    plot(cbind(surv_obs$haz$smooth_gr3$est.grid, surv_obs$haz$smooth_gr3$haz.est), 
         main = "F: Hazard function (spline curves)",
         type = "l", col = "black", lty = "5212", lwd = 2, xlab = "time", ylab = "smoothed hazard rate", 
         xlim = c(0, input$time_horizon), ylim = c(0, surv_obs$haz$max$smooth))
    lines(cbind(surv_pred$model$spl_hazard1_h[[3]]$time, surv_pred$model$spl_hazard1_h[[3]]$est), 
          col = "1", lty = "5212", lwd = 1)
    lines(cbind(surv_pred$model$spl_hazard2_h[[3]]$time, surv_pred$model$spl_hazard1_h[[3]]$est), 
          col = "2", lty = "5212", lwd = 1)
    lines(cbind(surv_pred$model$spl_odds1_h[[3]]$time, surv_pred$model$spl_odds1_h[[3]]$est), 
          col = "3", lty = "5212", lwd = 1)
    lines(cbind(surv_pred$model$spl_odds2_h[[3]]$time, surv_pred$model$spl_odds2_h[[3]]$est), 
          col = "4", lty = "5212", lwd = 1)
    lines(cbind(surv_pred$model$spl_normal1_h[[3]]$time, surv_pred$model$spl_normal1_h[[3]]$est), 
          col = "5", lty = "5212", lwd = 1)
    lines(cbind(surv_pred$model$spl_normal2_h[[3]]$time, surv_pred$model$spl_normal2_h[[3]]$est), 
          col = "6", lty = "5212", lwd = 1)
    legend("topleft", legend = misc$lbls_spline, col = 1:6, lty = "5212", cex = 0.8)
  }
}, envir = PERSUADE)
```

\newpage

#Session information
```{r si, echo=FALSE}
print(sessionInfo(), RNG = TRUE, locale = FALSE)
```
