---
output:
  pdf_document:
    toc: yes
    keep_tex: TRUE
urlcolor: blue
---

---
title: "PERSUADE `r basename(getwd())`"
date: "`r Sys.Date()`"
---

```{r setup, include=FALSE}
#code is formatted using formatR::tidy_source(width.cutoff = 80)
knitr::opts_chunk$set(echo = TRUE, fig.align = "left", fig.path = "Images/", dev = c('pdf', 'png'), dpi=300)
options(warn=-1) # prevent warnings from being printed (options(warn=0) to turn warning back on)
```

```{r preparation, echo=FALSE, warning = FALSE, message = FALSE, results = "hide"}
packages <- c("ggplot2", "knitr",
              "survminer", "survival", "summarytools")
new.packages <- packages[!(packages %in% installed.packages()[, "Package"])]  #check for new packages
if (length(new.packages)) install.packages(new.packages)  #install new packages (if needed)
suppressPackageStartupMessages(lapply(packages, require, character.only = TRUE))  #load packages

# COLOUR PALETTE
n <- 9  #number of different colors (to be used for palette)
palette(rainbow(n = n, s = 1, v = 1, start = 0, end = max(1, n - 1)/n, alpha = 1))
```

```{r input, echo=FALSE, warning = FALSE, message = FALSE, results = "hide"}
# INPUT DATA
load(paste0(getwd(), "/PERSUADE.RData"))

# Figure functions
source(paste0(getwd(), "/PERSUADE figures.R"))

```

\

[Link to PERSUADE GitHub page](https://github.com/Bram-R/PERSUADE)

\clearpage
# 1. Kaplan-Meier  
```{r plot_KM, echo=FALSE, fig.height=7, fig.width=7}
f_plot_km_survival(PERSUADE)
kable(summary(PERSUADE$surv_obs$km)$table)
```

\clearpage
# 2. Proportional hazards assumption  
```{r PH_assumption, echo=FALSE, eval=if (PERSUADE$misc$ngroups>1) {TRUE} else {FALSE}, out.height = "29%", fig.width=11}
f_plot_log_cumhaz(PERSUADE)
f_plot_schoenfeld_residuals(PERSUADE)
```

\clearpage
# 3. Hazard function  
## Shape of the observed smoothed hazard function  
```{r plot_hr, echo=FALSE}
f_plot_smoothed_hazard(PERSUADE)
```

\clearpage
## Shape of the predicted hazard function  
```{r plot_haz_pred, out.height = "29%", fig.width=11, echo=FALSE}
f_plot_hazard_with_models(PERSUADE)
```

\clearpage

# 4.1 Standard parametric models  
```{r plot_parametric, echo=FALSE, out.height = "75%"}
# plot.new()
# legend("center", legend = PERSUADE$misc$lbls, cex = 0.9, bty = "n",
#        fill = rainbow(n = n, s = 1, v = 1, start = 0, end = max(1, n - 1)/n, alpha = 1))

kable(PERSUADE$surv_model$param_ic[order(PERSUADE$surv_model$param_ic$AIC), ],
      row.names = FALSE)
```

\clearpage

## Exponential
```{r expo, echo=FALSE, out.height = "25%", fig.width=11}
i <- 1
f_plot_param_surv_model(PERSUADE, names(PERSUADE$surv_pred$model)[1:7][i], 
                        PERSUADE$misc$lbls[i], i)
f_plot_diag_param_surv_model(PERSUADE, names(PERSUADE$surv_pred$model)[1:7][i], 
                             PERSUADE$misc$lbls[i], i)
f_plot_tp_param_surv_model(PERSUADE, names(PERSUADE$surv_pred$model)[1:7][i], 
                           PERSUADE$misc$lbls[i], i)
```

\clearpage  

## Weibull
```{r weib, echo=FALSE, out.height = "25%", fig.width=11}
i <- i + 1
f_plot_param_surv_model(PERSUADE, names(PERSUADE$surv_pred$model)[1:7][i], 
                        PERSUADE$misc$lbls[i], i)
f_plot_diag_param_surv_model(PERSUADE, names(PERSUADE$surv_pred$model)[1:7][i], 
                             PERSUADE$misc$lbls[i], i)
f_plot_tp_param_surv_model(PERSUADE, names(PERSUADE$surv_pred$model)[1:7][i], 
                           PERSUADE$misc$lbls[i], i)
```

\clearpage 

## Gompertz
```{r gom, echo=FALSE, out.height = "25%", fig.width=11}
i <- i + 1
f_plot_param_surv_model(PERSUADE, names(PERSUADE$surv_pred$model)[1:7][i], 
                        PERSUADE$misc$lbls[i], i)
f_plot_diag_param_surv_model(PERSUADE, names(PERSUADE$surv_pred$model)[1:7][i], 
                             PERSUADE$misc$lbls[i], i)
f_plot_tp_param_surv_model(PERSUADE, names(PERSUADE$surv_pred$model)[1:7][i], 
                           PERSUADE$misc$lbls[i], i)
```

\clearpage 

## Log-normal
```{r lnorm, echo=FALSE, out.height = "25%", fig.width=11}
i <- i + 1
f_plot_param_surv_model(PERSUADE, names(PERSUADE$surv_pred$model)[1:7][i], 
                        PERSUADE$misc$lbls[i], i)
f_plot_diag_param_surv_model(PERSUADE, names(PERSUADE$surv_pred$model)[1:7][i], 
                             PERSUADE$misc$lbls[i], i)
f_plot_tp_param_surv_model(PERSUADE, names(PERSUADE$surv_pred$model)[1:7][i], 
                           PERSUADE$misc$lbls[i], i)
```

\clearpage 

## Log-logistic
```{r llog, echo=FALSE, out.height = "25%", fig.width=11}
i <- i + 1
f_plot_param_surv_model(PERSUADE, names(PERSUADE$surv_pred$model)[1:7][i], 
                        PERSUADE$misc$lbls[i], i)
f_plot_diag_param_surv_model(PERSUADE, names(PERSUADE$surv_pred$model)[1:7][i], 
                             PERSUADE$misc$lbls[i], i)
f_plot_tp_param_surv_model(PERSUADE, names(PERSUADE$surv_pred$model)[1:7][i], 
                           PERSUADE$misc$lbls[i], i)
```

\clearpage 

## Gamma
```{r gam, echo=FALSE, out.height = "25%", fig.width=11}
i <- i + 1
f_plot_param_surv_model(PERSUADE, names(PERSUADE$surv_pred$model)[1:7][i], 
                        PERSUADE$misc$lbls[i], i)
f_plot_diag_param_surv_model(PERSUADE, names(PERSUADE$surv_pred$model)[1:7][i], 
                             PERSUADE$misc$lbls[i], i)
f_plot_tp_param_surv_model(PERSUADE, names(PERSUADE$surv_pred$model)[1:7][i], 
                           PERSUADE$misc$lbls[i], i)
```

\clearpage 

## Generalised Gamma 
```{r ggam, echo=FALSE, out.height = "25%", fig.width=11}
i <- i + 1
f_plot_param_surv_model(PERSUADE, names(PERSUADE$surv_pred$model)[1:7][i], 
                        PERSUADE$misc$lbls[i], i)
f_plot_diag_param_surv_model(PERSUADE, names(PERSUADE$surv_pred$model)[1:7][i], 
                             PERSUADE$misc$lbls[i], i)
f_plot_tp_param_surv_model(PERSUADE, names(PERSUADE$surv_pred$model)[1:7][i], 
                           PERSUADE$misc$lbls[i], i)
```

\clearpage

# 4.2 Parametric natural cubic spline models
```{r spline, echo=FALSE, out.height = "75%", eval = PERSUADE$input$spline_mod}
# plot.new()
# legend("center", legend = PERSUADE$misc$lbls_spline, cex = 0.9, bty = "n",
#        fill = rainbow(n = n, s = 1, v = 1, start = 0, end = max(1, n - 1)/n, alpha = 1))

kable(rbind(PERSUADE$surv_model$param_ic, PERSUADE$surv_model$spline_ic)[
  order(rbind(PERSUADE$surv_model$param_ic, PERSUADE$surv_model$spline_ic)$AIC), ],
  row.names = FALSE)
```

`r if(PERSUADE$input$spline_mod == TRUE) {return("\\clearpage")}`

## Spline 1 knot hazard
```{r spline_hazard1, echo=FALSE, out.height = "25%", fig.width=11, eval = PERSUADE$input$spline_mod}
i <- 1
f_plot_spline_surv_model(PERSUADE, names(PERSUADE$surv_pred$model$spline)[i], 
                         PERSUADE$misc$lbls_spline[i], i)
f_plot_diag_spline_surv_model(PERSUADE, names(PERSUADE$surv_pred$model$spline)[i], 
                              PERSUADE$misc$lbls_spline[i], i)
f_plot_tp_spline_surv_model(PERSUADE, names(PERSUADE$surv_pred$model$spline)[i], 
                              PERSUADE$misc$lbls_spline[i], i)
```

`r if(PERSUADE$input$spline_mod == TRUE) {return("\\clearpage")}`

## Spline 2 knots hazard
```{r spline_hazard2, echo=FALSE, out.height = "25%", fig.width=11, eval = PERSUADE$input$spline_mod}
i <- i + 1
f_plot_spline_surv_model(PERSUADE, names(PERSUADE$surv_pred$model$spline)[i], 
                         PERSUADE$misc$lbls_spline[i], i)
f_plot_diag_spline_surv_model(PERSUADE, names(PERSUADE$surv_pred$model$spline)[i], 
                              PERSUADE$misc$lbls_spline[i], i)
f_plot_tp_spline_surv_model(PERSUADE, names(PERSUADE$surv_pred$model$spline)[i], 
                              PERSUADE$misc$lbls_spline[i], i)
```

`r if(PERSUADE$input$spline_mod == TRUE) {return("\\clearpage")}`

## Spline 3 knots hazard 
```{r spline_hazard3, echo=FALSE, out.height = "25%", fig.width=11, eval = PERSUADE$input$spline_mod}
i <- i + 1
f_plot_spline_surv_model(PERSUADE, names(PERSUADE$surv_pred$model$spline)[i], 
                         PERSUADE$misc$lbls_spline[i], i)
f_plot_diag_spline_surv_model(PERSUADE, names(PERSUADE$surv_pred$model$spline)[i], 
                              PERSUADE$misc$lbls_spline[i], i)
f_plot_tp_spline_surv_model(PERSUADE, names(PERSUADE$surv_pred$model$spline)[i], 
                              PERSUADE$misc$lbls_spline[i], i)
```

`r if(PERSUADE$input$spline_mod == TRUE) {return("\\clearpage")}`

## Spline 1 knot odds 
```{r spline_odds1, echo=FALSE, out.height = "25%", fig.width=11, eval = PERSUADE$input$spline_mod}
i <- i + 1
f_plot_spline_surv_model(PERSUADE, names(PERSUADE$surv_pred$model$spline)[i], 
                         PERSUADE$misc$lbls_spline[i], i)
f_plot_diag_spline_surv_model(PERSUADE, names(PERSUADE$surv_pred$model$spline)[i], 
                              PERSUADE$misc$lbls_spline[i], i)
f_plot_tp_spline_surv_model(PERSUADE, names(PERSUADE$surv_pred$model$spline)[i], 
                              PERSUADE$misc$lbls_spline[i], i)
```

`r if(PERSUADE$input$spline_mod == TRUE) {return("\\clearpage")}`

## Spline 2 knots odds 
```{r spline_odds2, echo=FALSE, out.height = "25%", fig.width=11, eval = PERSUADE$input$spline_mod}
i <- i + 1
f_plot_spline_surv_model(PERSUADE, names(PERSUADE$surv_pred$model$spline)[i], 
                         PERSUADE$misc$lbls_spline[i], i)
f_plot_diag_spline_surv_model(PERSUADE, names(PERSUADE$surv_pred$model$spline)[i], 
                              PERSUADE$misc$lbls_spline[i], i)
f_plot_tp_spline_surv_model(PERSUADE, names(PERSUADE$surv_pred$model$spline)[i], 
                              PERSUADE$misc$lbls_spline[i], i)
```

`r if(PERSUADE$input$spline_mod == TRUE) {return("\\clearpage")}`

## Spline 3 knots odds 
```{r spline_odds3, echo=FALSE, out.height = "25%", fig.width=11, eval = PERSUADE$input$spline_mod}
i <- i + 1
f_plot_spline_surv_model(PERSUADE, names(PERSUADE$surv_pred$model$spline)[i], 
                         PERSUADE$misc$lbls_spline[i], i)
f_plot_diag_spline_surv_model(PERSUADE, names(PERSUADE$surv_pred$model$spline)[i], 
                              PERSUADE$misc$lbls_spline[i], i)
f_plot_tp_spline_surv_model(PERSUADE, names(PERSUADE$surv_pred$model$spline)[i], 
                              PERSUADE$misc$lbls_spline[i], i)
```

`r if(PERSUADE$input$spline_mod == TRUE) {return("\\clearpage")}`

## Spline 1 knot normal 
```{r spline_norm1, echo=FALSE, out.height = "25%", fig.width=11, eval = PERSUADE$input$spline_mod}
i <- i + 1
f_plot_spline_surv_model(PERSUADE, names(PERSUADE$surv_pred$model$spline)[i], 
                         PERSUADE$misc$lbls_spline[i], i)
f_plot_diag_spline_surv_model(PERSUADE, names(PERSUADE$surv_pred$model$spline)[i], 
                              PERSUADE$misc$lbls_spline[i], i)
f_plot_tp_spline_surv_model(PERSUADE, names(PERSUADE$surv_pred$model$spline)[i], 
                              PERSUADE$misc$lbls_spline[i], i)
```

`r if(PERSUADE$input$spline_mod == TRUE) {return("\\clearpage")}`

## Spline 2 knots normal 
```{r spline_norm2, echo=FALSE, out.height = "25%", fig.width=11, eval = PERSUADE$input$spline_mod}
i <- i + 1
f_plot_spline_surv_model(PERSUADE, names(PERSUADE$surv_pred$model$spline)[i], 
                         PERSUADE$misc$lbls_spline[i], i)
f_plot_diag_spline_surv_model(PERSUADE, names(PERSUADE$surv_pred$model$spline)[i], 
                              PERSUADE$misc$lbls_spline[i], i)
f_plot_tp_spline_surv_model(PERSUADE, names(PERSUADE$surv_pred$model$spline)[i], 
                              PERSUADE$misc$lbls_spline[i], i)
```

`r if(PERSUADE$input$spline_mod == TRUE) {return("\\clearpage")}`

## Spline 3 knots normal 
```{r spline_norm3, echo=FALSE, out.height = "25%", fig.width=11, eval = PERSUADE$input$spline_mod}
i <- i + 1
f_plot_spline_surv_model(PERSUADE, names(PERSUADE$surv_pred$model$spline)[i], 
                         PERSUADE$misc$lbls_spline[i], i)
f_plot_diag_spline_surv_model(PERSUADE, names(PERSUADE$surv_pred$model$spline)[i], 
                              PERSUADE$misc$lbls_spline[i], i)
f_plot_tp_spline_surv_model(PERSUADE, names(PERSUADE$surv_pred$model$spline)[i], 
                              PERSUADE$misc$lbls_spline[i], i)
```

\clearpage

# 4.3 Parametric (non-)mixture cure models 
```{r cure, echo=FALSE, out.height = "75%", eval = PERSUADE$input$cure_mod}
# plot.new()
# legend("center", legend = PERSUADE$misc$lbls_cure, cex = 0.9, bty = "n",
#        fill = rainbow(n = n, s = 1, v = 1, start = 0, end = max(1, n - 1)/n, alpha = 1))

kable(rbind(PERSUADE$surv_model$param_ic[,1:2], PERSUADE$surv_model$cure_ic[,1:2])[
  order(rbind(PERSUADE$surv_model$param_ic[,1:2], PERSUADE$surv_model$cure_ic[,1:2])$AIC), ],
  row.names = FALSE)
kable(PERSUADE$surv_model$cure_ic[,-2])
```

`r if(PERSUADE$input$cure_mod == TRUE) {return("\\clearpage")}`

## Mixture cure Weibull
```{r cure_weib_mix, echo=FALSE, out.height = "25%", fig.width=11, eval = PERSUADE$input$cure_mod}
i <- 1
f_plot_cure_surv_model(PERSUADE, names(PERSUADE$surv_pred$model$cure)[i], 
                       PERSUADE$misc$lbls_cure[i], i)
f_plot_diag_cure_surv_model(PERSUADE, names(PERSUADE$surv_pred$model$cure)[i], 
                            PERSUADE$misc$lbls_cure[i], i)
f_plot_tp_cure_surv_model(PERSUADE, names(PERSUADE$surv_pred$model$cure)[i], 
                            PERSUADE$misc$lbls_cure[i], i)
```

`r if(PERSUADE$input$cure_mod == TRUE) {return("\\clearpage")}`

## Non-mixture cure Weibull
```{r cure_weib_nmix, echo=FALSE, out.height = "25%", fig.width=11, eval = PERSUADE$input$cure_mod}
i <- i + 1
f_plot_cure_surv_model(PERSUADE, names(PERSUADE$surv_pred$model$cure)[i], 
                       PERSUADE$misc$lbls_cure[i], i)
f_plot_diag_cure_surv_model(PERSUADE, names(PERSUADE$surv_pred$model$cure)[i], 
                            PERSUADE$misc$lbls_cure[i], i)
f_plot_tp_cure_surv_model(PERSUADE, names(PERSUADE$surv_pred$model$cure)[i], 
                            PERSUADE$misc$lbls_cure[i], i)
```

`r if(PERSUADE$input$cure_mod == TRUE) {return("\\clearpage")}`

## Mixture cure Log-normal
```{r cure_lnorm_mix, echo=FALSE, out.height = "25%", fig.width=11, eval = PERSUADE$input$cure_mod}
i <- i + 1
f_plot_cure_surv_model(PERSUADE, names(PERSUADE$surv_pred$model$cure)[i], 
                       PERSUADE$misc$lbls_cure[i], i)
f_plot_diag_cure_surv_model(PERSUADE, names(PERSUADE$surv_pred$model$cure)[i], 
                            PERSUADE$misc$lbls_cure[i], i)
f_plot_tp_cure_surv_model(PERSUADE, names(PERSUADE$surv_pred$model$cure)[i], 
                            PERSUADE$misc$lbls_cure[i], i)
```

`r if(PERSUADE$input$cure_mod == TRUE) {return("\\clearpage")}`

## Non-mixture cure Log-normal
```{r cure_lnorm_nmix, echo=FALSE, out.height = "25%", fig.width=11, eval = PERSUADE$input$cure_mod}
i <- i + 1
f_plot_cure_surv_model(PERSUADE, names(PERSUADE$surv_pred$model$cure)[i], 
                       PERSUADE$misc$lbls_cure[i], i)
f_plot_diag_cure_surv_model(PERSUADE, names(PERSUADE$surv_pred$model$cure)[i], 
                            PERSUADE$misc$lbls_cure[i], i)
f_plot_tp_cure_surv_model(PERSUADE, names(PERSUADE$surv_pred$model$cure)[i], 
                            PERSUADE$misc$lbls_cure[i], i)
```

`r if(PERSUADE$input$cure_mod == TRUE) {return("\\clearpage")}`

## Mixture cure Log-logistic
```{r cure_llog_mix, echo=FALSE, out.height = "25%", fig.width=11, eval = PERSUADE$input$cure_mod}
i <- i + 1
f_plot_cure_surv_model(PERSUADE, names(PERSUADE$surv_pred$model$cure)[i], 
                       PERSUADE$misc$lbls_cure[i], i)
f_plot_diag_cure_surv_model(PERSUADE, names(PERSUADE$surv_pred$model$cure)[i], 
                            PERSUADE$misc$lbls_cure[i], i)
f_plot_tp_cure_surv_model(PERSUADE, names(PERSUADE$surv_pred$model$cure)[i], 
                            PERSUADE$misc$lbls_cure[i], i)
```

`r if(PERSUADE$input$cure_mod == TRUE) {return("\\clearpage")}`

## Non-mixture cure Log-logistic
```{r cure_llog_nmix, echo=FALSE, out.height = "25%", fig.width=11, eval = PERSUADE$input$cure_mod}
i <- i + 1
f_plot_cure_surv_model(PERSUADE, names(PERSUADE$surv_pred$model$cure)[i], 
                       PERSUADE$misc$lbls_cure[i], i)
f_plot_diag_cure_surv_model(PERSUADE, names(PERSUADE$surv_pred$model$cure)[i], 
                            PERSUADE$misc$lbls_cure[i], i)
f_plot_tp_cure_surv_model(PERSUADE, names(PERSUADE$surv_pred$model$cure)[i], 
                            PERSUADE$misc$lbls_cure[i], i)
```

\clearpage


# 5. Extrapolated survival













\clearpage

# 6. PERSUADE object information
```{r oi, echo=FALSE}
print(str(PERSUADE, max.level = 2))
```

\clearpage

# 7. Session information
```{r si, echo=FALSE}
print(sessionInfo(), RNG = TRUE, locale = FALSE)
```


